// ==UserScript==
// @name         Timekeeper
// @namespace    https://violentmonkey.github.io/
// @version      4.4.64
// @description  Enhanced timestamp tool for YouTube videos
// @author       Silent Shout
// @match        https://www.youtube.com/*
// @run-at       document-idle
// @noframes
// @icon         https://raw.githubusercontent.com/KamoTimestamps/timekeeper/refs/heads/main/assets/Kamo_64px_Indexed.png
// @grant        GM.getValue
// @grant        GM.setValue
// @grant        GM.setClipboard
// @homepageURL  https://github.com/KamoTimestamps/timekeeper
// @supportURL   https://github.com/KamoTimestamps/timekeeper/issues
// @downloadURL  https://raw.githubusercontent.com/KamoTimestamps/timekeeper/main/timekeeper.user.js
// @updateURL    https://raw.githubusercontent.com/KamoTimestamps/timekeeper/main/timekeeper.user.js
// @license MIT
// ==/UserScript==

(()=>{var Ns=Object.defineProperty;var $s=(t,e)=>{for(var n in e)Ns(t,n,{get:e[n],enumerable:!0})};var B={};$s(B,{BRAND:()=>fo,DIRTY:()=>sn,EMPTY_PATH:()=>Us,INVALID:()=>P,NEVER:()=>Ko,OK:()=>Ne,ParseStatus:()=>Be,Schema:()=>q,ZodAny:()=>Vt,ZodArray:()=>Ot,ZodBigInt:()=>ln,ZodBoolean:()=>cn,ZodBranded:()=>gr,ZodCatch:()=>bn,ZodDate:()=>un,ZodDefault:()=>xn,ZodDiscriminatedUnion:()=>ri,ZodEffects:()=>ft,ZodEnum:()=>yn,ZodError:()=>We,ZodFirstPartyTypeKind:()=>$,ZodFunction:()=>ai,ZodIntersection:()=>pn,ZodIssueCode:()=>_,ZodLazy:()=>hn,ZodLiteral:()=>gn,ZodMap:()=>Gn,ZodNaN:()=>qn,ZodNativeEnum:()=>vn,ZodNever:()=>wt,ZodNull:()=>fn,ZodNullable:()=>St,ZodNumber:()=>on,ZodObject:()=>Ye,ZodOptional:()=>ut,ZodParsedType:()=>C,ZodPipeline:()=>yr,ZodPromise:()=>qt,ZodReadonly:()=>wn,ZodRecord:()=>ii,ZodSchema:()=>q,ZodSet:()=>Vn,ZodString:()=>Gt,ZodSymbol:()=>Hn,ZodTransformer:()=>ft,ZodTuple:()=>Et,ZodType:()=>q,ZodUndefined:()=>dn,ZodUnion:()=>mn,ZodUnknown:()=>Rt,ZodVoid:()=>Un,addIssueToContext:()=>I,any:()=>wo,array:()=>Eo,bigint:()=>go,boolean:()=>La,coerce:()=>Yo,custom:()=>Sa,date:()=>yo,datetimeRegex:()=>_a,defaultErrorMap:()=>Dt,discriminatedUnion:()=>Lo,effect:()=>jo,enum:()=>No,function:()=>Oo,getErrorMap:()=>$n,getParsedType:()=>_t,instanceof:()=>po,intersection:()=>Ao,isAborted:()=>ti,isAsync:()=>Fn,isDirty:()=>ni,isValid:()=>Ut,late:()=>mo,lazy:()=>Po,literal:()=>zo,makeIssue:()=>hr,map:()=>Bo,nan:()=>ho,nativeEnum:()=>$o,never:()=>To,null:()=>bo,nullable:()=>Uo,number:()=>Ca,object:()=>So,objectUtil:()=>Li,oboolean:()=>Wo,onumber:()=>Zo,optional:()=>Ho,ostring:()=>qo,pipeline:()=>Vo,preprocess:()=>Go,promise:()=>Fo,quotelessJson:()=>Fs,record:()=>Do,set:()=>Ro,setErrorMap:()=>Hs,strictObject:()=>Io,string:()=>Ia,symbol:()=>vo,transformer:()=>jo,tuple:()=>Mo,undefined:()=>xo,union:()=>Co,unknown:()=>ko,util:()=>J,void:()=>_o});var J;(function(t){t.assertEqual=a=>{};function e(a){}t.assertIs=e;function n(a){throw new Error}t.assertNever=n,t.arrayToEnum=a=>{let r={};for(let l of a)r[l]=l;return r},t.getValidEnumValues=a=>{let r=t.objectKeys(a).filter(s=>typeof a[a[s]]!="number"),l={};for(let s of r)l[s]=a[s];return t.objectValues(l)},t.objectValues=a=>t.objectKeys(a).map(function(r){return a[r]}),t.objectKeys=typeof Object.keys=="function"?a=>Object.keys(a):a=>{let r=[];for(let l in a)Object.prototype.hasOwnProperty.call(a,l)&&r.push(l);return r},t.find=(a,r)=>{for(let l of a)if(r(l))return l},t.isInteger=typeof Number.isInteger=="function"?a=>Number.isInteger(a):a=>typeof a=="number"&&Number.isFinite(a)&&Math.floor(a)===a;function i(a,r=" | "){return a.map(l=>typeof l=="string"?`'${l}'`:l).join(r)}t.joinValues=i,t.jsonStringifyReplacer=(a,r)=>typeof r=="bigint"?r.toString():r})(J||(J={}));var Li;(function(t){t.mergeShapes=(e,n)=>({...e,...n})})(Li||(Li={}));var C=J.arrayToEnum(["string","nan","number","integer","float","boolean","date","bigint","symbol","function","undefined","null","array","object","unknown","promise","void","never","map","set"]),_t=t=>{switch(typeof t){case"undefined":return C.undefined;case"string":return C.string;case"number":return Number.isNaN(t)?C.nan:C.number;case"boolean":return C.boolean;case"function":return C.function;case"bigint":return C.bigint;case"symbol":return C.symbol;case"object":return Array.isArray(t)?C.array:t===null?C.null:t.then&&typeof t.then=="function"&&t.catch&&typeof t.catch=="function"?C.promise:typeof Map<"u"&&t instanceof Map?C.map:typeof Set<"u"&&t instanceof Set?C.set:typeof Date<"u"&&t instanceof Date?C.date:C.object;default:return C.unknown}};var _=J.arrayToEnum(["invalid_type","invalid_literal","custom","invalid_union","invalid_union_discriminator","invalid_enum_value","unrecognized_keys","invalid_arguments","invalid_return_type","invalid_date","invalid_string","too_small","too_big","invalid_intersection_types","not_multiple_of","not_finite"]),Fs=t=>JSON.stringify(t,null,2).replace(/"([^"]+)":/g,"$1:"),We=class t extends Error{get errors(){return this.issues}constructor(e){super(),this.issues=[],this.addIssue=i=>{this.issues=[...this.issues,i]},this.addIssues=(i=[])=>{this.issues=[...this.issues,...i]};let n=new.target.prototype;Object.setPrototypeOf?Object.setPrototypeOf(this,n):this.__proto__=n,this.name="ZodError",this.issues=e}format(e){let n=e||function(r){return r.message},i={_errors:[]},a=r=>{for(let l of r.issues)if(l.code==="invalid_union")l.unionErrors.map(a);else if(l.code==="invalid_return_type")a(l.returnTypeError);else if(l.code==="invalid_arguments")a(l.argumentsError);else if(l.path.length===0)i._errors.push(n(l));else{let s=i,g=0;for(;g<l.path.length;){let p=l.path[g];g===l.path.length-1?(s[p]=s[p]||{_errors:[]},s[p]._errors.push(n(l))):s[p]=s[p]||{_errors:[]},s=s[p],g++}}};return a(this),i}static assert(e){if(!(e instanceof t))throw new Error(`Not a ZodError: ${e}`)}toString(){return this.message}get message(){return JSON.stringify(this.issues,J.jsonStringifyReplacer,2)}get isEmpty(){return this.issues.length===0}flatten(e=n=>n.message){let n={},i=[];for(let a of this.issues)if(a.path.length>0){let r=a.path[0];n[r]=n[r]||[],n[r].push(e(a))}else i.push(e(a));return{formErrors:i,fieldErrors:n}}get formErrors(){return this.flatten()}};We.create=t=>new We(t);var js=(t,e)=>{let n;switch(t.code){case _.invalid_type:t.received===C.undefined?n="Required":n=`Expected ${t.expected}, received ${t.received}`;break;case _.invalid_literal:n=`Invalid literal value, expected ${JSON.stringify(t.expected,J.jsonStringifyReplacer)}`;break;case _.unrecognized_keys:n=`Unrecognized key(s) in object: ${J.joinValues(t.keys,", ")}`;break;case _.invalid_union:n="Invalid input";break;case _.invalid_union_discriminator:n=`Invalid discriminator value. Expected ${J.joinValues(t.options)}`;break;case _.invalid_enum_value:n=`Invalid enum value. Expected ${J.joinValues(t.options)}, received '${t.received}'`;break;case _.invalid_arguments:n="Invalid function arguments";break;case _.invalid_return_type:n="Invalid function return type";break;case _.invalid_date:n="Invalid date";break;case _.invalid_string:typeof t.validation=="object"?"includes"in t.validation?(n=`Invalid input: must include "${t.validation.includes}"`,typeof t.validation.position=="number"&&(n=`${n} at one or more positions greater than or equal to ${t.validation.position}`)):"startsWith"in t.validation?n=`Invalid input: must start with "${t.validation.startsWith}"`:"endsWith"in t.validation?n=`Invalid input: must end with "${t.validation.endsWith}"`:J.assertNever(t.validation):t.validation!=="regex"?n=`Invalid ${t.validation}`:n="Invalid";break;case _.too_small:t.type==="array"?n=`Array must contain ${t.exact?"exactly":t.inclusive?"at least":"more than"} ${t.minimum} element(s)`:t.type==="string"?n=`String must contain ${t.exact?"exactly":t.inclusive?"at least":"over"} ${t.minimum} character(s)`:t.type==="number"?n=`Number must be ${t.exact?"exactly equal to ":t.inclusive?"greater than or equal to ":"greater than "}${t.minimum}`:t.type==="bigint"?n=`Number must be ${t.exact?"exactly equal to ":t.inclusive?"greater than or equal to ":"greater than "}${t.minimum}`:t.type==="date"?n=`Date must be ${t.exact?"exactly equal to ":t.inclusive?"greater than or equal to ":"greater than "}${new Date(Number(t.minimum))}`:n="Invalid input";break;case _.too_big:t.type==="array"?n=`Array must contain ${t.exact?"exactly":t.inclusive?"at most":"less than"} ${t.maximum} element(s)`:t.type==="string"?n=`String must contain ${t.exact?"exactly":t.inclusive?"at most":"under"} ${t.maximum} character(s)`:t.type==="number"?n=`Number must be ${t.exact?"exactly":t.inclusive?"less than or equal to":"less than"} ${t.maximum}`:t.type==="bigint"?n=`BigInt must be ${t.exact?"exactly":t.inclusive?"less than or equal to":"less than"} ${t.maximum}`:t.type==="date"?n=`Date must be ${t.exact?"exactly":t.inclusive?"smaller than or equal to":"smaller than"} ${new Date(Number(t.maximum))}`:n="Invalid input";break;case _.custom:n="Invalid input";break;case _.invalid_intersection_types:n="Intersection results could not be merged";break;case _.not_multiple_of:n=`Number must be a multiple of ${t.multipleOf}`;break;case _.not_finite:n="Number must be finite";break;default:n=e.defaultError,J.assertNever(t)}return{message:n}},Dt=js;var xa=Dt;function Hs(t){xa=t}function $n(){return xa}var hr=t=>{let{data:e,path:n,errorMaps:i,issueData:a}=t,r=[...n,...a.path||[]],l={...a,path:r};if(a.message!==void 0)return{...a,path:r,message:a.message};let s="",g=i.filter(p=>!!p).slice().reverse();for(let p of g)s=p(l,{data:e,defaultError:s}).message;return{...a,path:r,message:s}},Us=[];function I(t,e){let n=$n(),i=hr({issueData:e,data:t.data,path:t.path,errorMaps:[t.common.contextualErrorMap,t.schemaErrorMap,n,n===Dt?void 0:Dt].filter(a=>!!a)});t.common.issues.push(i)}var Be=class t{constructor(){this.value="valid"}dirty(){this.value==="valid"&&(this.value="dirty")}abort(){this.value!=="aborted"&&(this.value="aborted")}static mergeArray(e,n){let i=[];for(let a of n){if(a.status==="aborted")return P;a.status==="dirty"&&e.dirty(),i.push(a.value)}return{status:e.value,value:i}}static async mergeObjectAsync(e,n){let i=[];for(let a of n){let r=await a.key,l=await a.value;i.push({key:r,value:l})}return t.mergeObjectSync(e,i)}static mergeObjectSync(e,n){let i={};for(let a of n){let{key:r,value:l}=a;if(r.status==="aborted"||l.status==="aborted")return P;r.status==="dirty"&&e.dirty(),l.status==="dirty"&&e.dirty(),r.value!=="__proto__"&&(typeof l.value<"u"||a.alwaysSet)&&(i[r.value]=l.value)}return{status:e.value,value:i}}},P=Object.freeze({status:"aborted"}),sn=t=>({status:"dirty",value:t}),Ne=t=>({status:"valid",value:t}),ti=t=>t.status==="aborted",ni=t=>t.status==="dirty",Ut=t=>t.status==="valid",Fn=t=>typeof Promise<"u"&&t instanceof Promise;var D;(function(t){t.errToObj=e=>typeof e=="string"?{message:e}:e||{},t.toString=e=>typeof e=="string"?e:e?.message})(D||(D={}));var dt=class{constructor(e,n,i,a){this._cachedPath=[],this.parent=e,this.data=n,this._path=i,this._key=a}get path(){return this._cachedPath.length||(Array.isArray(this._key)?this._cachedPath.push(...this._path,...this._key):this._cachedPath.push(...this._path,this._key)),this._cachedPath}},ba=(t,e)=>{if(Ut(e))return{success:!0,data:e.value};if(!t.common.issues.length)throw new Error("Validation failed but no issues detected.");return{success:!1,get error(){if(this._error)return this._error;let n=new We(t.common.issues);return this._error=n,this._error}}};function V(t){if(!t)return{};let{errorMap:e,invalid_type_error:n,required_error:i,description:a}=t;if(e&&(n||i))throw new Error(`Can't use "invalid_type_error" or "required_error" in conjunction with custom error map.`);return e?{errorMap:e,description:a}:{errorMap:(l,s)=>{let{message:g}=t;return l.code==="invalid_enum_value"?{message:g??s.defaultError}:typeof s.data>"u"?{message:g??i??s.defaultError}:l.code!=="invalid_type"?{message:s.defaultError}:{message:g??n??s.defaultError}},description:a}}var q=class{get description(){return this._def.description}_getType(e){return _t(e.data)}_getOrReturnCtx(e,n){return n||{common:e.parent.common,data:e.data,parsedType:_t(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}_processInputParams(e){return{status:new Be,ctx:{common:e.parent.common,data:e.data,parsedType:_t(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}}_parseSync(e){let n=this._parse(e);if(Fn(n))throw new Error("Synchronous parse encountered promise.");return n}_parseAsync(e){let n=this._parse(e);return Promise.resolve(n)}parse(e,n){let i=this.safeParse(e,n);if(i.success)return i.data;throw i.error}safeParse(e,n){let i={common:{issues:[],async:n?.async??!1,contextualErrorMap:n?.errorMap},path:n?.path||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:_t(e)},a=this._parseSync({data:e,path:i.path,parent:i});return ba(i,a)}"~validate"(e){let n={common:{issues:[],async:!!this["~standard"].async},path:[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:_t(e)};if(!this["~standard"].async)try{let i=this._parseSync({data:e,path:[],parent:n});return Ut(i)?{value:i.value}:{issues:n.common.issues}}catch(i){i?.message?.toLowerCase()?.includes("encountered")&&(this["~standard"].async=!0),n.common={issues:[],async:!0}}return this._parseAsync({data:e,path:[],parent:n}).then(i=>Ut(i)?{value:i.value}:{issues:n.common.issues})}async parseAsync(e,n){let i=await this.safeParseAsync(e,n);if(i.success)return i.data;throw i.error}async safeParseAsync(e,n){let i={common:{issues:[],contextualErrorMap:n?.errorMap,async:!0},path:n?.path||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:_t(e)},a=this._parse({data:e,path:i.path,parent:i}),r=await(Fn(a)?a:Promise.resolve(a));return ba(i,r)}refine(e,n){let i=a=>typeof n=="string"||typeof n>"u"?{message:n}:typeof n=="function"?n(a):n;return this._refinement((a,r)=>{let l=e(a),s=()=>r.addIssue({code:_.custom,...i(a)});return typeof Promise<"u"&&l instanceof Promise?l.then(g=>g?!0:(s(),!1)):l?!0:(s(),!1)})}refinement(e,n){return this._refinement((i,a)=>e(i)?!0:(a.addIssue(typeof n=="function"?n(i,a):n),!1))}_refinement(e){return new ft({schema:this,typeName:$.ZodEffects,effect:{type:"refinement",refinement:e}})}superRefine(e){return this._refinement(e)}constructor(e){this.spa=this.safeParseAsync,this._def=e,this.parse=this.parse.bind(this),this.safeParse=this.safeParse.bind(this),this.parseAsync=this.parseAsync.bind(this),this.safeParseAsync=this.safeParseAsync.bind(this),this.spa=this.spa.bind(this),this.refine=this.refine.bind(this),this.refinement=this.refinement.bind(this),this.superRefine=this.superRefine.bind(this),this.optional=this.optional.bind(this),this.nullable=this.nullable.bind(this),this.nullish=this.nullish.bind(this),this.array=this.array.bind(this),this.promise=this.promise.bind(this),this.or=this.or.bind(this),this.and=this.and.bind(this),this.transform=this.transform.bind(this),this.brand=this.brand.bind(this),this.default=this.default.bind(this),this.catch=this.catch.bind(this),this.describe=this.describe.bind(this),this.pipe=this.pipe.bind(this),this.readonly=this.readonly.bind(this),this.isNullable=this.isNullable.bind(this),this.isOptional=this.isOptional.bind(this),this["~standard"]={version:1,vendor:"zod",validate:n=>this["~validate"](n)}}optional(){return ut.create(this,this._def)}nullable(){return St.create(this,this._def)}nullish(){return this.nullable().optional()}array(){return Ot.create(this)}promise(){return qt.create(this,this._def)}or(e){return mn.create([this,e],this._def)}and(e){return pn.create(this,e,this._def)}transform(e){return new ft({...V(this._def),schema:this,typeName:$.ZodEffects,effect:{type:"transform",transform:e}})}default(e){let n=typeof e=="function"?e:()=>e;return new xn({...V(this._def),innerType:this,defaultValue:n,typeName:$.ZodDefault})}brand(){return new gr({typeName:$.ZodBranded,type:this,...V(this._def)})}catch(e){let n=typeof e=="function"?e:()=>e;return new bn({...V(this._def),innerType:this,catchValue:n,typeName:$.ZodCatch})}describe(e){let n=this.constructor;return new n({...this._def,description:e})}pipe(e){return yr.create(this,e)}readonly(){return wn.create(this)}isOptional(){return this.safeParse(void 0).success}isNullable(){return this.safeParse(null).success}},Gs=/^c[^\s-]{8,}$/i,Vs=/^[0-9a-z]+$/,qs=/^[0-9A-HJKMNP-TV-Z]{26}$/i,Zs=/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/i,Ws=/^[a-z0-9_-]{21}$/i,Ys=/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]*$/,Ks=/^[-+]?P(?!$)(?:(?:[-+]?\d+Y)|(?:[-+]?\d+[.,]\d+Y$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:(?:[-+]?\d+W)|(?:[-+]?\d+[.,]\d+W$))?(?:(?:[-+]?\d+D)|(?:[-+]?\d+[.,]\d+D$))?(?:T(?=[\d+-])(?:(?:[-+]?\d+H)|(?:[-+]?\d+[.,]\d+H$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:[-+]?\d+(?:[.,]\d+)?S)?)??$/,Js=/^(?!\.)(?!.*\.\.)([A-Z0-9_'+\-\.]*)[A-Z0-9_+-]@([A-Z0-9][A-Z0-9\-]*\.)+[A-Z]{2,}$/i,Xs="^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$",Ai,Qs=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,eo=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\/(3[0-2]|[12]?[0-9])$/,to=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))$/,no=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/,ro=/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,io=/^([0-9a-zA-Z-_]{4})*(([0-9a-zA-Z-_]{2}(==)?)|([0-9a-zA-Z-_]{3}(=)?))?$/,ka="((\\d\\d[2468][048]|\\d\\d[13579][26]|\\d\\d0[48]|[02468][048]00|[13579][26]00)-02-29|\\d{4}-((0[13578]|1[02])-(0[1-9]|[12]\\d|3[01])|(0[469]|11)-(0[1-9]|[12]\\d|30)|(02)-(0[1-9]|1\\d|2[0-8])))",ao=new RegExp(`^${ka}$`);function Ta(t){let e="[0-5]\\d";t.precision?e=`${e}\\.\\d{${t.precision}}`:t.precision==null&&(e=`${e}(\\.\\d+)?`);let n=t.precision?"+":"?";return`([01]\\d|2[0-3]):[0-5]\\d(:${e})${n}`}function so(t){return new RegExp(`^${Ta(t)}$`)}function _a(t){let e=`${ka}T${Ta(t)}`,n=[];return n.push(t.local?"Z?":"Z"),t.offset&&n.push("([+-]\\d{2}:?\\d{2})"),e=`${e}(${n.join("|")})`,new RegExp(`^${e}$`)}function oo(t,e){return!!((e==="v4"||!e)&&Qs.test(t)||(e==="v6"||!e)&&to.test(t))}function lo(t,e){if(!Ys.test(t))return!1;try{let[n]=t.split(".");if(!n)return!1;let i=n.replace(/-/g,"+").replace(/_/g,"/").padEnd(n.length+(4-n.length%4)%4,"="),a=JSON.parse(atob(i));return!(typeof a!="object"||a===null||"typ"in a&&a?.typ!=="JWT"||!a.alg||e&&a.alg!==e)}catch{return!1}}function co(t,e){return!!((e==="v4"||!e)&&eo.test(t)||(e==="v6"||!e)&&no.test(t))}var Gt=class t extends q{_parse(e){if(this._def.coerce&&(e.data=String(e.data)),this._getType(e)!==C.string){let r=this._getOrReturnCtx(e);return I(r,{code:_.invalid_type,expected:C.string,received:r.parsedType}),P}let i=new Be,a;for(let r of this._def.checks)if(r.kind==="min")e.data.length<r.value&&(a=this._getOrReturnCtx(e,a),I(a,{code:_.too_small,minimum:r.value,type:"string",inclusive:!0,exact:!1,message:r.message}),i.dirty());else if(r.kind==="max")e.data.length>r.value&&(a=this._getOrReturnCtx(e,a),I(a,{code:_.too_big,maximum:r.value,type:"string",inclusive:!0,exact:!1,message:r.message}),i.dirty());else if(r.kind==="length"){let l=e.data.length>r.value,s=e.data.length<r.value;(l||s)&&(a=this._getOrReturnCtx(e,a),l?I(a,{code:_.too_big,maximum:r.value,type:"string",inclusive:!0,exact:!0,message:r.message}):s&&I(a,{code:_.too_small,minimum:r.value,type:"string",inclusive:!0,exact:!0,message:r.message}),i.dirty())}else if(r.kind==="email")Js.test(e.data)||(a=this._getOrReturnCtx(e,a),I(a,{validation:"email",code:_.invalid_string,message:r.message}),i.dirty());else if(r.kind==="emoji")Ai||(Ai=new RegExp(Xs,"u")),Ai.test(e.data)||(a=this._getOrReturnCtx(e,a),I(a,{validation:"emoji",code:_.invalid_string,message:r.message}),i.dirty());else if(r.kind==="uuid")Zs.test(e.data)||(a=this._getOrReturnCtx(e,a),I(a,{validation:"uuid",code:_.invalid_string,message:r.message}),i.dirty());else if(r.kind==="nanoid")Ws.test(e.data)||(a=this._getOrReturnCtx(e,a),I(a,{validation:"nanoid",code:_.invalid_string,message:r.message}),i.dirty());else if(r.kind==="cuid")Gs.test(e.data)||(a=this._getOrReturnCtx(e,a),I(a,{validation:"cuid",code:_.invalid_string,message:r.message}),i.dirty());else if(r.kind==="cuid2")Vs.test(e.data)||(a=this._getOrReturnCtx(e,a),I(a,{validation:"cuid2",code:_.invalid_string,message:r.message}),i.dirty());else if(r.kind==="ulid")qs.test(e.data)||(a=this._getOrReturnCtx(e,a),I(a,{validation:"ulid",code:_.invalid_string,message:r.message}),i.dirty());else if(r.kind==="url")try{new URL(e.data)}catch{a=this._getOrReturnCtx(e,a),I(a,{validation:"url",code:_.invalid_string,message:r.message}),i.dirty()}else r.kind==="regex"?(r.regex.lastIndex=0,r.regex.test(e.data)||(a=this._getOrReturnCtx(e,a),I(a,{validation:"regex",code:_.invalid_string,message:r.message}),i.dirty())):r.kind==="trim"?e.data=e.data.trim():r.kind==="includes"?e.data.includes(r.value,r.position)||(a=this._getOrReturnCtx(e,a),I(a,{code:_.invalid_string,validation:{includes:r.value,position:r.position},message:r.message}),i.dirty()):r.kind==="toLowerCase"?e.data=e.data.toLowerCase():r.kind==="toUpperCase"?e.data=e.data.toUpperCase():r.kind==="startsWith"?e.data.startsWith(r.value)||(a=this._getOrReturnCtx(e,a),I(a,{code:_.invalid_string,validation:{startsWith:r.value},message:r.message}),i.dirty()):r.kind==="endsWith"?e.data.endsWith(r.value)||(a=this._getOrReturnCtx(e,a),I(a,{code:_.invalid_string,validation:{endsWith:r.value},message:r.message}),i.dirty()):r.kind==="datetime"?_a(r).test(e.data)||(a=this._getOrReturnCtx(e,a),I(a,{code:_.invalid_string,validation:"datetime",message:r.message}),i.dirty()):r.kind==="date"?ao.test(e.data)||(a=this._getOrReturnCtx(e,a),I(a,{code:_.invalid_string,validation:"date",message:r.message}),i.dirty()):r.kind==="time"?so(r).test(e.data)||(a=this._getOrReturnCtx(e,a),I(a,{code:_.invalid_string,validation:"time",message:r.message}),i.dirty()):r.kind==="duration"?Ks.test(e.data)||(a=this._getOrReturnCtx(e,a),I(a,{validation:"duration",code:_.invalid_string,message:r.message}),i.dirty()):r.kind==="ip"?oo(e.data,r.version)||(a=this._getOrReturnCtx(e,a),I(a,{validation:"ip",code:_.invalid_string,message:r.message}),i.dirty()):r.kind==="jwt"?lo(e.data,r.alg)||(a=this._getOrReturnCtx(e,a),I(a,{validation:"jwt",code:_.invalid_string,message:r.message}),i.dirty()):r.kind==="cidr"?co(e.data,r.version)||(a=this._getOrReturnCtx(e,a),I(a,{validation:"cidr",code:_.invalid_string,message:r.message}),i.dirty()):r.kind==="base64"?ro.test(e.data)||(a=this._getOrReturnCtx(e,a),I(a,{validation:"base64",code:_.invalid_string,message:r.message}),i.dirty()):r.kind==="base64url"?io.test(e.data)||(a=this._getOrReturnCtx(e,a),I(a,{validation:"base64url",code:_.invalid_string,message:r.message}),i.dirty()):J.assertNever(r);return{status:i.value,value:e.data}}_regex(e,n,i){return this.refinement(a=>e.test(a),{validation:n,code:_.invalid_string,...D.errToObj(i)})}_addCheck(e){return new t({...this._def,checks:[...this._def.checks,e]})}email(e){return this._addCheck({kind:"email",...D.errToObj(e)})}url(e){return this._addCheck({kind:"url",...D.errToObj(e)})}emoji(e){return this._addCheck({kind:"emoji",...D.errToObj(e)})}uuid(e){return this._addCheck({kind:"uuid",...D.errToObj(e)})}nanoid(e){return this._addCheck({kind:"nanoid",...D.errToObj(e)})}cuid(e){return this._addCheck({kind:"cuid",...D.errToObj(e)})}cuid2(e){return this._addCheck({kind:"cuid2",...D.errToObj(e)})}ulid(e){return this._addCheck({kind:"ulid",...D.errToObj(e)})}base64(e){return this._addCheck({kind:"base64",...D.errToObj(e)})}base64url(e){return this._addCheck({kind:"base64url",...D.errToObj(e)})}jwt(e){return this._addCheck({kind:"jwt",...D.errToObj(e)})}ip(e){return this._addCheck({kind:"ip",...D.errToObj(e)})}cidr(e){return this._addCheck({kind:"cidr",...D.errToObj(e)})}datetime(e){return typeof e=="string"?this._addCheck({kind:"datetime",precision:null,offset:!1,local:!1,message:e}):this._addCheck({kind:"datetime",precision:typeof e?.precision>"u"?null:e?.precision,offset:e?.offset??!1,local:e?.local??!1,...D.errToObj(e?.message)})}date(e){return this._addCheck({kind:"date",message:e})}time(e){return typeof e=="string"?this._addCheck({kind:"time",precision:null,message:e}):this._addCheck({kind:"time",precision:typeof e?.precision>"u"?null:e?.precision,...D.errToObj(e?.message)})}duration(e){return this._addCheck({kind:"duration",...D.errToObj(e)})}regex(e,n){return this._addCheck({kind:"regex",regex:e,...D.errToObj(n)})}includes(e,n){return this._addCheck({kind:"includes",value:e,position:n?.position,...D.errToObj(n?.message)})}startsWith(e,n){return this._addCheck({kind:"startsWith",value:e,...D.errToObj(n)})}endsWith(e,n){return this._addCheck({kind:"endsWith",value:e,...D.errToObj(n)})}min(e,n){return this._addCheck({kind:"min",value:e,...D.errToObj(n)})}max(e,n){return this._addCheck({kind:"max",value:e,...D.errToObj(n)})}length(e,n){return this._addCheck({kind:"length",value:e,...D.errToObj(n)})}nonempty(e){return this.min(1,D.errToObj(e))}trim(){return new t({...this._def,checks:[...this._def.checks,{kind:"trim"}]})}toLowerCase(){return new t({...this._def,checks:[...this._def.checks,{kind:"toLowerCase"}]})}toUpperCase(){return new t({...this._def,checks:[...this._def.checks,{kind:"toUpperCase"}]})}get isDatetime(){return!!this._def.checks.find(e=>e.kind==="datetime")}get isDate(){return!!this._def.checks.find(e=>e.kind==="date")}get isTime(){return!!this._def.checks.find(e=>e.kind==="time")}get isDuration(){return!!this._def.checks.find(e=>e.kind==="duration")}get isEmail(){return!!this._def.checks.find(e=>e.kind==="email")}get isURL(){return!!this._def.checks.find(e=>e.kind==="url")}get isEmoji(){return!!this._def.checks.find(e=>e.kind==="emoji")}get isUUID(){return!!this._def.checks.find(e=>e.kind==="uuid")}get isNANOID(){return!!this._def.checks.find(e=>e.kind==="nanoid")}get isCUID(){return!!this._def.checks.find(e=>e.kind==="cuid")}get isCUID2(){return!!this._def.checks.find(e=>e.kind==="cuid2")}get isULID(){return!!this._def.checks.find(e=>e.kind==="ulid")}get isIP(){return!!this._def.checks.find(e=>e.kind==="ip")}get isCIDR(){return!!this._def.checks.find(e=>e.kind==="cidr")}get isBase64(){return!!this._def.checks.find(e=>e.kind==="base64")}get isBase64url(){return!!this._def.checks.find(e=>e.kind==="base64url")}get minLength(){let e=null;for(let n of this._def.checks)n.kind==="min"&&(e===null||n.value>e)&&(e=n.value);return e}get maxLength(){let e=null;for(let n of this._def.checks)n.kind==="max"&&(e===null||n.value<e)&&(e=n.value);return e}};Gt.create=t=>new Gt({checks:[],typeName:$.ZodString,coerce:t?.coerce??!1,...V(t)});function uo(t,e){let n=(t.toString().split(".")[1]||"").length,i=(e.toString().split(".")[1]||"").length,a=n>i?n:i,r=Number.parseInt(t.toFixed(a).replace(".","")),l=Number.parseInt(e.toFixed(a).replace(".",""));return r%l/10**a}var on=class t extends q{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte,this.step=this.multipleOf}_parse(e){if(this._def.coerce&&(e.data=Number(e.data)),this._getType(e)!==C.number){let r=this._getOrReturnCtx(e);return I(r,{code:_.invalid_type,expected:C.number,received:r.parsedType}),P}let i,a=new Be;for(let r of this._def.checks)r.kind==="int"?J.isInteger(e.data)||(i=this._getOrReturnCtx(e,i),I(i,{code:_.invalid_type,expected:"integer",received:"float",message:r.message}),a.dirty()):r.kind==="min"?(r.inclusive?e.data<r.value:e.data<=r.value)&&(i=this._getOrReturnCtx(e,i),I(i,{code:_.too_small,minimum:r.value,type:"number",inclusive:r.inclusive,exact:!1,message:r.message}),a.dirty()):r.kind==="max"?(r.inclusive?e.data>r.value:e.data>=r.value)&&(i=this._getOrReturnCtx(e,i),I(i,{code:_.too_big,maximum:r.value,type:"number",inclusive:r.inclusive,exact:!1,message:r.message}),a.dirty()):r.kind==="multipleOf"?uo(e.data,r.value)!==0&&(i=this._getOrReturnCtx(e,i),I(i,{code:_.not_multiple_of,multipleOf:r.value,message:r.message}),a.dirty()):r.kind==="finite"?Number.isFinite(e.data)||(i=this._getOrReturnCtx(e,i),I(i,{code:_.not_finite,message:r.message}),a.dirty()):J.assertNever(r);return{status:a.value,value:e.data}}gte(e,n){return this.setLimit("min",e,!0,D.toString(n))}gt(e,n){return this.setLimit("min",e,!1,D.toString(n))}lte(e,n){return this.setLimit("max",e,!0,D.toString(n))}lt(e,n){return this.setLimit("max",e,!1,D.toString(n))}setLimit(e,n,i,a){return new t({...this._def,checks:[...this._def.checks,{kind:e,value:n,inclusive:i,message:D.toString(a)}]})}_addCheck(e){return new t({...this._def,checks:[...this._def.checks,e]})}int(e){return this._addCheck({kind:"int",message:D.toString(e)})}positive(e){return this._addCheck({kind:"min",value:0,inclusive:!1,message:D.toString(e)})}negative(e){return this._addCheck({kind:"max",value:0,inclusive:!1,message:D.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:0,inclusive:!0,message:D.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:0,inclusive:!0,message:D.toString(e)})}multipleOf(e,n){return this._addCheck({kind:"multipleOf",value:e,message:D.toString(n)})}finite(e){return this._addCheck({kind:"finite",message:D.toString(e)})}safe(e){return this._addCheck({kind:"min",inclusive:!0,value:Number.MIN_SAFE_INTEGER,message:D.toString(e)})._addCheck({kind:"max",inclusive:!0,value:Number.MAX_SAFE_INTEGER,message:D.toString(e)})}get minValue(){let e=null;for(let n of this._def.checks)n.kind==="min"&&(e===null||n.value>e)&&(e=n.value);return e}get maxValue(){let e=null;for(let n of this._def.checks)n.kind==="max"&&(e===null||n.value<e)&&(e=n.value);return e}get isInt(){return!!this._def.checks.find(e=>e.kind==="int"||e.kind==="multipleOf"&&J.isInteger(e.value))}get isFinite(){let e=null,n=null;for(let i of this._def.checks){if(i.kind==="finite"||i.kind==="int"||i.kind==="multipleOf")return!0;i.kind==="min"?(n===null||i.value>n)&&(n=i.value):i.kind==="max"&&(e===null||i.value<e)&&(e=i.value)}return Number.isFinite(n)&&Number.isFinite(e)}};on.create=t=>new on({checks:[],typeName:$.ZodNumber,coerce:t?.coerce||!1,...V(t)});var ln=class t extends q{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte}_parse(e){if(this._def.coerce)try{e.data=BigInt(e.data)}catch{return this._getInvalidInput(e)}if(this._getType(e)!==C.bigint)return this._getInvalidInput(e);let i,a=new Be;for(let r of this._def.checks)r.kind==="min"?(r.inclusive?e.data<r.value:e.data<=r.value)&&(i=this._getOrReturnCtx(e,i),I(i,{code:_.too_small,type:"bigint",minimum:r.value,inclusive:r.inclusive,message:r.message}),a.dirty()):r.kind==="max"?(r.inclusive?e.data>r.value:e.data>=r.value)&&(i=this._getOrReturnCtx(e,i),I(i,{code:_.too_big,type:"bigint",maximum:r.value,inclusive:r.inclusive,message:r.message}),a.dirty()):r.kind==="multipleOf"?e.data%r.value!==BigInt(0)&&(i=this._getOrReturnCtx(e,i),I(i,{code:_.not_multiple_of,multipleOf:r.value,message:r.message}),a.dirty()):J.assertNever(r);return{status:a.value,value:e.data}}_getInvalidInput(e){let n=this._getOrReturnCtx(e);return I(n,{code:_.invalid_type,expected:C.bigint,received:n.parsedType}),P}gte(e,n){return this.setLimit("min",e,!0,D.toString(n))}gt(e,n){return this.setLimit("min",e,!1,D.toString(n))}lte(e,n){return this.setLimit("max",e,!0,D.toString(n))}lt(e,n){return this.setLimit("max",e,!1,D.toString(n))}setLimit(e,n,i,a){return new t({...this._def,checks:[...this._def.checks,{kind:e,value:n,inclusive:i,message:D.toString(a)}]})}_addCheck(e){return new t({...this._def,checks:[...this._def.checks,e]})}positive(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!1,message:D.toString(e)})}negative(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!1,message:D.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!0,message:D.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!0,message:D.toString(e)})}multipleOf(e,n){return this._addCheck({kind:"multipleOf",value:e,message:D.toString(n)})}get minValue(){let e=null;for(let n of this._def.checks)n.kind==="min"&&(e===null||n.value>e)&&(e=n.value);return e}get maxValue(){let e=null;for(let n of this._def.checks)n.kind==="max"&&(e===null||n.value<e)&&(e=n.value);return e}};ln.create=t=>new ln({checks:[],typeName:$.ZodBigInt,coerce:t?.coerce??!1,...V(t)});var cn=class extends q{_parse(e){if(this._def.coerce&&(e.data=!!e.data),this._getType(e)!==C.boolean){let i=this._getOrReturnCtx(e);return I(i,{code:_.invalid_type,expected:C.boolean,received:i.parsedType}),P}return Ne(e.data)}};cn.create=t=>new cn({typeName:$.ZodBoolean,coerce:t?.coerce||!1,...V(t)});var un=class t extends q{_parse(e){if(this._def.coerce&&(e.data=new Date(e.data)),this._getType(e)!==C.date){let r=this._getOrReturnCtx(e);return I(r,{code:_.invalid_type,expected:C.date,received:r.parsedType}),P}if(Number.isNaN(e.data.getTime())){let r=this._getOrReturnCtx(e);return I(r,{code:_.invalid_date}),P}let i=new Be,a;for(let r of this._def.checks)r.kind==="min"?e.data.getTime()<r.value&&(a=this._getOrReturnCtx(e,a),I(a,{code:_.too_small,message:r.message,inclusive:!0,exact:!1,minimum:r.value,type:"date"}),i.dirty()):r.kind==="max"?e.data.getTime()>r.value&&(a=this._getOrReturnCtx(e,a),I(a,{code:_.too_big,message:r.message,inclusive:!0,exact:!1,maximum:r.value,type:"date"}),i.dirty()):J.assertNever(r);return{status:i.value,value:new Date(e.data.getTime())}}_addCheck(e){return new t({...this._def,checks:[...this._def.checks,e]})}min(e,n){return this._addCheck({kind:"min",value:e.getTime(),message:D.toString(n)})}max(e,n){return this._addCheck({kind:"max",value:e.getTime(),message:D.toString(n)})}get minDate(){let e=null;for(let n of this._def.checks)n.kind==="min"&&(e===null||n.value>e)&&(e=n.value);return e!=null?new Date(e):null}get maxDate(){let e=null;for(let n of this._def.checks)n.kind==="max"&&(e===null||n.value<e)&&(e=n.value);return e!=null?new Date(e):null}};un.create=t=>new un({checks:[],coerce:t?.coerce||!1,typeName:$.ZodDate,...V(t)});var Hn=class extends q{_parse(e){if(this._getType(e)!==C.symbol){let i=this._getOrReturnCtx(e);return I(i,{code:_.invalid_type,expected:C.symbol,received:i.parsedType}),P}return Ne(e.data)}};Hn.create=t=>new Hn({typeName:$.ZodSymbol,...V(t)});var dn=class extends q{_parse(e){if(this._getType(e)!==C.undefined){let i=this._getOrReturnCtx(e);return I(i,{code:_.invalid_type,expected:C.undefined,received:i.parsedType}),P}return Ne(e.data)}};dn.create=t=>new dn({typeName:$.ZodUndefined,...V(t)});var fn=class extends q{_parse(e){if(this._getType(e)!==C.null){let i=this._getOrReturnCtx(e);return I(i,{code:_.invalid_type,expected:C.null,received:i.parsedType}),P}return Ne(e.data)}};fn.create=t=>new fn({typeName:$.ZodNull,...V(t)});var Vt=class extends q{constructor(){super(...arguments),this._any=!0}_parse(e){return Ne(e.data)}};Vt.create=t=>new Vt({typeName:$.ZodAny,...V(t)});var Rt=class extends q{constructor(){super(...arguments),this._unknown=!0}_parse(e){return Ne(e.data)}};Rt.create=t=>new Rt({typeName:$.ZodUnknown,...V(t)});var wt=class extends q{_parse(e){let n=this._getOrReturnCtx(e);return I(n,{code:_.invalid_type,expected:C.never,received:n.parsedType}),P}};wt.create=t=>new wt({typeName:$.ZodNever,...V(t)});var Un=class extends q{_parse(e){if(this._getType(e)!==C.undefined){let i=this._getOrReturnCtx(e);return I(i,{code:_.invalid_type,expected:C.void,received:i.parsedType}),P}return Ne(e.data)}};Un.create=t=>new Un({typeName:$.ZodVoid,...V(t)});var Ot=class t extends q{_parse(e){let{ctx:n,status:i}=this._processInputParams(e),a=this._def;if(n.parsedType!==C.array)return I(n,{code:_.invalid_type,expected:C.array,received:n.parsedType}),P;if(a.exactLength!==null){let l=n.data.length>a.exactLength.value,s=n.data.length<a.exactLength.value;(l||s)&&(I(n,{code:l?_.too_big:_.too_small,minimum:s?a.exactLength.value:void 0,maximum:l?a.exactLength.value:void 0,type:"array",inclusive:!0,exact:!0,message:a.exactLength.message}),i.dirty())}if(a.minLength!==null&&n.data.length<a.minLength.value&&(I(n,{code:_.too_small,minimum:a.minLength.value,type:"array",inclusive:!0,exact:!1,message:a.minLength.message}),i.dirty()),a.maxLength!==null&&n.data.length>a.maxLength.value&&(I(n,{code:_.too_big,maximum:a.maxLength.value,type:"array",inclusive:!0,exact:!1,message:a.maxLength.message}),i.dirty()),n.common.async)return Promise.all([...n.data].map((l,s)=>a.type._parseAsync(new dt(n,l,n.path,s)))).then(l=>Be.mergeArray(i,l));let r=[...n.data].map((l,s)=>a.type._parseSync(new dt(n,l,n.path,s)));return Be.mergeArray(i,r)}get element(){return this._def.type}min(e,n){return new t({...this._def,minLength:{value:e,message:D.toString(n)}})}max(e,n){return new t({...this._def,maxLength:{value:e,message:D.toString(n)}})}length(e,n){return new t({...this._def,exactLength:{value:e,message:D.toString(n)}})}nonempty(e){return this.min(1,e)}};Ot.create=(t,e)=>new Ot({type:t,minLength:null,maxLength:null,exactLength:null,typeName:$.ZodArray,...V(e)});function jn(t){if(t instanceof Ye){let e={};for(let n in t.shape){let i=t.shape[n];e[n]=ut.create(jn(i))}return new Ye({...t._def,shape:()=>e})}else return t instanceof Ot?new Ot({...t._def,type:jn(t.element)}):t instanceof ut?ut.create(jn(t.unwrap())):t instanceof St?St.create(jn(t.unwrap())):t instanceof Et?Et.create(t.items.map(e=>jn(e))):t}var Ye=class t extends q{constructor(){super(...arguments),this._cached=null,this.nonstrict=this.passthrough,this.augment=this.extend}_getCached(){if(this._cached!==null)return this._cached;let e=this._def.shape(),n=J.objectKeys(e);return this._cached={shape:e,keys:n},this._cached}_parse(e){if(this._getType(e)!==C.object){let p=this._getOrReturnCtx(e);return I(p,{code:_.invalid_type,expected:C.object,received:p.parsedType}),P}let{status:i,ctx:a}=this._processInputParams(e),{shape:r,keys:l}=this._getCached(),s=[];if(!(this._def.catchall instanceof wt&&this._def.unknownKeys==="strip"))for(let p in a.data)l.includes(p)||s.push(p);let g=[];for(let p of l){let b=r[p],M=a.data[p];g.push({key:{status:"valid",value:p},value:b._parse(new dt(a,M,a.path,p)),alwaysSet:p in a.data})}if(this._def.catchall instanceof wt){let p=this._def.unknownKeys;if(p==="passthrough")for(let b of s)g.push({key:{status:"valid",value:b},value:{status:"valid",value:a.data[b]}});else if(p==="strict")s.length>0&&(I(a,{code:_.unrecognized_keys,keys:s}),i.dirty());else if(p!=="strip")throw new Error("Internal ZodObject error: invalid unknownKeys value.")}else{let p=this._def.catchall;for(let b of s){let M=a.data[b];g.push({key:{status:"valid",value:b},value:p._parse(new dt(a,M,a.path,b)),alwaysSet:b in a.data})}}return a.common.async?Promise.resolve().then(async()=>{let p=[];for(let b of g){let M=await b.key,R=await b.value;p.push({key:M,value:R,alwaysSet:b.alwaysSet})}return p}).then(p=>Be.mergeObjectSync(i,p)):Be.mergeObjectSync(i,g)}get shape(){return this._def.shape()}strict(e){return D.errToObj,new t({...this._def,unknownKeys:"strict",...e!==void 0?{errorMap:(n,i)=>{let a=this._def.errorMap?.(n,i).message??i.defaultError;return n.code==="unrecognized_keys"?{message:D.errToObj(e).message??a}:{message:a}}}:{}})}strip(){return new t({...this._def,unknownKeys:"strip"})}passthrough(){return new t({...this._def,unknownKeys:"passthrough"})}extend(e){return new t({...this._def,shape:()=>({...this._def.shape(),...e})})}merge(e){return new t({unknownKeys:e._def.unknownKeys,catchall:e._def.catchall,shape:()=>({...this._def.shape(),...e._def.shape()}),typeName:$.ZodObject})}setKey(e,n){return this.augment({[e]:n})}catchall(e){return new t({...this._def,catchall:e})}pick(e){let n={};for(let i of J.objectKeys(e))e[i]&&this.shape[i]&&(n[i]=this.shape[i]);return new t({...this._def,shape:()=>n})}omit(e){let n={};for(let i of J.objectKeys(this.shape))e[i]||(n[i]=this.shape[i]);return new t({...this._def,shape:()=>n})}deepPartial(){return jn(this)}partial(e){let n={};for(let i of J.objectKeys(this.shape)){let a=this.shape[i];e&&!e[i]?n[i]=a:n[i]=a.optional()}return new t({...this._def,shape:()=>n})}required(e){let n={};for(let i of J.objectKeys(this.shape))if(e&&!e[i])n[i]=this.shape[i];else{let r=this.shape[i];for(;r instanceof ut;)r=r._def.innerType;n[i]=r}return new t({...this._def,shape:()=>n})}keyof(){return Ea(J.objectKeys(this.shape))}};Ye.create=(t,e)=>new Ye({shape:()=>t,unknownKeys:"strip",catchall:wt.create(),typeName:$.ZodObject,...V(e)});Ye.strictCreate=(t,e)=>new Ye({shape:()=>t,unknownKeys:"strict",catchall:wt.create(),typeName:$.ZodObject,...V(e)});Ye.lazycreate=(t,e)=>new Ye({shape:t,unknownKeys:"strip",catchall:wt.create(),typeName:$.ZodObject,...V(e)});var mn=class extends q{_parse(e){let{ctx:n}=this._processInputParams(e),i=this._def.options;function a(r){for(let s of r)if(s.result.status==="valid")return s.result;for(let s of r)if(s.result.status==="dirty")return n.common.issues.push(...s.ctx.common.issues),s.result;let l=r.map(s=>new We(s.ctx.common.issues));return I(n,{code:_.invalid_union,unionErrors:l}),P}if(n.common.async)return Promise.all(i.map(async r=>{let l={...n,common:{...n.common,issues:[]},parent:null};return{result:await r._parseAsync({data:n.data,path:n.path,parent:l}),ctx:l}})).then(a);{let r,l=[];for(let g of i){let p={...n,common:{...n.common,issues:[]},parent:null},b=g._parseSync({data:n.data,path:n.path,parent:p});if(b.status==="valid")return b;b.status==="dirty"&&!r&&(r={result:b,ctx:p}),p.common.issues.length&&l.push(p.common.issues)}if(r)return n.common.issues.push(...r.ctx.common.issues),r.result;let s=l.map(g=>new We(g));return I(n,{code:_.invalid_union,unionErrors:s}),P}}get options(){return this._def.options}};mn.create=(t,e)=>new mn({options:t,typeName:$.ZodUnion,...V(e)});var Bt=t=>t instanceof hn?Bt(t.schema):t instanceof ft?Bt(t.innerType()):t instanceof gn?[t.value]:t instanceof yn?t.options:t instanceof vn?J.objectValues(t.enum):t instanceof xn?Bt(t._def.innerType):t instanceof dn?[void 0]:t instanceof fn?[null]:t instanceof ut?[void 0,...Bt(t.unwrap())]:t instanceof St?[null,...Bt(t.unwrap())]:t instanceof gr||t instanceof wn?Bt(t.unwrap()):t instanceof bn?Bt(t._def.innerType):[],ri=class t extends q{_parse(e){let{ctx:n}=this._processInputParams(e);if(n.parsedType!==C.object)return I(n,{code:_.invalid_type,expected:C.object,received:n.parsedType}),P;let i=this.discriminator,a=n.data[i],r=this.optionsMap.get(a);return r?n.common.async?r._parseAsync({data:n.data,path:n.path,parent:n}):r._parseSync({data:n.data,path:n.path,parent:n}):(I(n,{code:_.invalid_union_discriminator,options:Array.from(this.optionsMap.keys()),path:[i]}),P)}get discriminator(){return this._def.discriminator}get options(){return this._def.options}get optionsMap(){return this._def.optionsMap}static create(e,n,i){let a=new Map;for(let r of n){let l=Bt(r.shape[e]);if(!l.length)throw new Error(`A discriminator value for key \`${e}\` could not be extracted from all schema options`);for(let s of l){if(a.has(s))throw new Error(`Discriminator property ${String(e)} has duplicate value ${String(s)}`);a.set(s,r)}}return new t({typeName:$.ZodDiscriminatedUnion,discriminator:e,options:n,optionsMap:a,...V(i)})}};function Mi(t,e){let n=_t(t),i=_t(e);if(t===e)return{valid:!0,data:t};if(n===C.object&&i===C.object){let a=J.objectKeys(e),r=J.objectKeys(t).filter(s=>a.indexOf(s)!==-1),l={...t,...e};for(let s of r){let g=Mi(t[s],e[s]);if(!g.valid)return{valid:!1};l[s]=g.data}return{valid:!0,data:l}}else if(n===C.array&&i===C.array){if(t.length!==e.length)return{valid:!1};let a=[];for(let r=0;r<t.length;r++){let l=t[r],s=e[r],g=Mi(l,s);if(!g.valid)return{valid:!1};a.push(g.data)}return{valid:!0,data:a}}else return n===C.date&&i===C.date&&+t==+e?{valid:!0,data:t}:{valid:!1}}var pn=class extends q{_parse(e){let{status:n,ctx:i}=this._processInputParams(e),a=(r,l)=>{if(ti(r)||ti(l))return P;let s=Mi(r.value,l.value);return s.valid?((ni(r)||ni(l))&&n.dirty(),{status:n.value,value:s.data}):(I(i,{code:_.invalid_intersection_types}),P)};return i.common.async?Promise.all([this._def.left._parseAsync({data:i.data,path:i.path,parent:i}),this._def.right._parseAsync({data:i.data,path:i.path,parent:i})]).then(([r,l])=>a(r,l)):a(this._def.left._parseSync({data:i.data,path:i.path,parent:i}),this._def.right._parseSync({data:i.data,path:i.path,parent:i}))}};pn.create=(t,e,n)=>new pn({left:t,right:e,typeName:$.ZodIntersection,...V(n)});var Et=class t extends q{_parse(e){let{status:n,ctx:i}=this._processInputParams(e);if(i.parsedType!==C.array)return I(i,{code:_.invalid_type,expected:C.array,received:i.parsedType}),P;if(i.data.length<this._def.items.length)return I(i,{code:_.too_small,minimum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),P;!this._def.rest&&i.data.length>this._def.items.length&&(I(i,{code:_.too_big,maximum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),n.dirty());let r=[...i.data].map((l,s)=>{let g=this._def.items[s]||this._def.rest;return g?g._parse(new dt(i,l,i.path,s)):null}).filter(l=>!!l);return i.common.async?Promise.all(r).then(l=>Be.mergeArray(n,l)):Be.mergeArray(n,r)}get items(){return this._def.items}rest(e){return new t({...this._def,rest:e})}};Et.create=(t,e)=>{if(!Array.isArray(t))throw new Error("You must pass an array of schemas to z.tuple([ ... ])");return new Et({items:t,typeName:$.ZodTuple,rest:null,...V(e)})};var ii=class t extends q{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){let{status:n,ctx:i}=this._processInputParams(e);if(i.parsedType!==C.object)return I(i,{code:_.invalid_type,expected:C.object,received:i.parsedType}),P;let a=[],r=this._def.keyType,l=this._def.valueType;for(let s in i.data)a.push({key:r._parse(new dt(i,s,i.path,s)),value:l._parse(new dt(i,i.data[s],i.path,s)),alwaysSet:s in i.data});return i.common.async?Be.mergeObjectAsync(n,a):Be.mergeObjectSync(n,a)}get element(){return this._def.valueType}static create(e,n,i){return n instanceof q?new t({keyType:e,valueType:n,typeName:$.ZodRecord,...V(i)}):new t({keyType:Gt.create(),valueType:e,typeName:$.ZodRecord,...V(n)})}},Gn=class extends q{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){let{status:n,ctx:i}=this._processInputParams(e);if(i.parsedType!==C.map)return I(i,{code:_.invalid_type,expected:C.map,received:i.parsedType}),P;let a=this._def.keyType,r=this._def.valueType,l=[...i.data.entries()].map(([s,g],p)=>({key:a._parse(new dt(i,s,i.path,[p,"key"])),value:r._parse(new dt(i,g,i.path,[p,"value"]))}));if(i.common.async){let s=new Map;return Promise.resolve().then(async()=>{for(let g of l){let p=await g.key,b=await g.value;if(p.status==="aborted"||b.status==="aborted")return P;(p.status==="dirty"||b.status==="dirty")&&n.dirty(),s.set(p.value,b.value)}return{status:n.value,value:s}})}else{let s=new Map;for(let g of l){let p=g.key,b=g.value;if(p.status==="aborted"||b.status==="aborted")return P;(p.status==="dirty"||b.status==="dirty")&&n.dirty(),s.set(p.value,b.value)}return{status:n.value,value:s}}}};Gn.create=(t,e,n)=>new Gn({valueType:e,keyType:t,typeName:$.ZodMap,...V(n)});var Vn=class t extends q{_parse(e){let{status:n,ctx:i}=this._processInputParams(e);if(i.parsedType!==C.set)return I(i,{code:_.invalid_type,expected:C.set,received:i.parsedType}),P;let a=this._def;a.minSize!==null&&i.data.size<a.minSize.value&&(I(i,{code:_.too_small,minimum:a.minSize.value,type:"set",inclusive:!0,exact:!1,message:a.minSize.message}),n.dirty()),a.maxSize!==null&&i.data.size>a.maxSize.value&&(I(i,{code:_.too_big,maximum:a.maxSize.value,type:"set",inclusive:!0,exact:!1,message:a.maxSize.message}),n.dirty());let r=this._def.valueType;function l(g){let p=new Set;for(let b of g){if(b.status==="aborted")return P;b.status==="dirty"&&n.dirty(),p.add(b.value)}return{status:n.value,value:p}}let s=[...i.data.values()].map((g,p)=>r._parse(new dt(i,g,i.path,p)));return i.common.async?Promise.all(s).then(g=>l(g)):l(s)}min(e,n){return new t({...this._def,minSize:{value:e,message:D.toString(n)}})}max(e,n){return new t({...this._def,maxSize:{value:e,message:D.toString(n)}})}size(e,n){return this.min(e,n).max(e,n)}nonempty(e){return this.min(1,e)}};Vn.create=(t,e)=>new Vn({valueType:t,minSize:null,maxSize:null,typeName:$.ZodSet,...V(e)});var ai=class t extends q{constructor(){super(...arguments),this.validate=this.implement}_parse(e){let{ctx:n}=this._processInputParams(e);if(n.parsedType!==C.function)return I(n,{code:_.invalid_type,expected:C.function,received:n.parsedType}),P;function i(s,g){return hr({data:s,path:n.path,errorMaps:[n.common.contextualErrorMap,n.schemaErrorMap,$n(),Dt].filter(p=>!!p),issueData:{code:_.invalid_arguments,argumentsError:g}})}function a(s,g){return hr({data:s,path:n.path,errorMaps:[n.common.contextualErrorMap,n.schemaErrorMap,$n(),Dt].filter(p=>!!p),issueData:{code:_.invalid_return_type,returnTypeError:g}})}let r={errorMap:n.common.contextualErrorMap},l=n.data;if(this._def.returns instanceof qt){let s=this;return Ne(async function(...g){let p=new We([]),b=await s._def.args.parseAsync(g,r).catch(F=>{throw p.addIssue(i(g,F)),p}),M=await Reflect.apply(l,this,b);return await s._def.returns._def.type.parseAsync(M,r).catch(F=>{throw p.addIssue(a(M,F)),p})})}else{let s=this;return Ne(function(...g){let p=s._def.args.safeParse(g,r);if(!p.success)throw new We([i(g,p.error)]);let b=Reflect.apply(l,this,p.data),M=s._def.returns.safeParse(b,r);if(!M.success)throw new We([a(b,M.error)]);return M.data})}}parameters(){return this._def.args}returnType(){return this._def.returns}args(...e){return new t({...this._def,args:Et.create(e).rest(Rt.create())})}returns(e){return new t({...this._def,returns:e})}implement(e){return this.parse(e)}strictImplement(e){return this.parse(e)}static create(e,n,i){return new t({args:e||Et.create([]).rest(Rt.create()),returns:n||Rt.create(),typeName:$.ZodFunction,...V(i)})}},hn=class extends q{get schema(){return this._def.getter()}_parse(e){let{ctx:n}=this._processInputParams(e);return this._def.getter()._parse({data:n.data,path:n.path,parent:n})}};hn.create=(t,e)=>new hn({getter:t,typeName:$.ZodLazy,...V(e)});var gn=class extends q{_parse(e){if(e.data!==this._def.value){let n=this._getOrReturnCtx(e);return I(n,{received:n.data,code:_.invalid_literal,expected:this._def.value}),P}return{status:"valid",value:e.data}}get value(){return this._def.value}};gn.create=(t,e)=>new gn({value:t,typeName:$.ZodLiteral,...V(e)});function Ea(t,e){return new yn({values:t,typeName:$.ZodEnum,...V(e)})}var yn=class t extends q{_parse(e){if(typeof e.data!="string"){let n=this._getOrReturnCtx(e),i=this._def.values;return I(n,{expected:J.joinValues(i),received:n.parsedType,code:_.invalid_type}),P}if(this._cache||(this._cache=new Set(this._def.values)),!this._cache.has(e.data)){let n=this._getOrReturnCtx(e),i=this._def.values;return I(n,{received:n.data,code:_.invalid_enum_value,options:i}),P}return Ne(e.data)}get options(){return this._def.values}get enum(){let e={};for(let n of this._def.values)e[n]=n;return e}get Values(){let e={};for(let n of this._def.values)e[n]=n;return e}get Enum(){let e={};for(let n of this._def.values)e[n]=n;return e}extract(e,n=this._def){return t.create(e,{...this._def,...n})}exclude(e,n=this._def){return t.create(this.options.filter(i=>!e.includes(i)),{...this._def,...n})}};yn.create=Ea;var vn=class extends q{_parse(e){let n=J.getValidEnumValues(this._def.values),i=this._getOrReturnCtx(e);if(i.parsedType!==C.string&&i.parsedType!==C.number){let a=J.objectValues(n);return I(i,{expected:J.joinValues(a),received:i.parsedType,code:_.invalid_type}),P}if(this._cache||(this._cache=new Set(J.getValidEnumValues(this._def.values))),!this._cache.has(e.data)){let a=J.objectValues(n);return I(i,{received:i.data,code:_.invalid_enum_value,options:a}),P}return Ne(e.data)}get enum(){return this._def.values}};vn.create=(t,e)=>new vn({values:t,typeName:$.ZodNativeEnum,...V(e)});var qt=class extends q{unwrap(){return this._def.type}_parse(e){let{ctx:n}=this._processInputParams(e);if(n.parsedType!==C.promise&&n.common.async===!1)return I(n,{code:_.invalid_type,expected:C.promise,received:n.parsedType}),P;let i=n.parsedType===C.promise?n.data:Promise.resolve(n.data);return Ne(i.then(a=>this._def.type.parseAsync(a,{path:n.path,errorMap:n.common.contextualErrorMap})))}};qt.create=(t,e)=>new qt({type:t,typeName:$.ZodPromise,...V(e)});var ft=class extends q{innerType(){return this._def.schema}sourceType(){return this._def.schema._def.typeName===$.ZodEffects?this._def.schema.sourceType():this._def.schema}_parse(e){let{status:n,ctx:i}=this._processInputParams(e),a=this._def.effect||null,r={addIssue:l=>{I(i,l),l.fatal?n.abort():n.dirty()},get path(){return i.path}};if(r.addIssue=r.addIssue.bind(r),a.type==="preprocess"){let l=a.transform(i.data,r);if(i.common.async)return Promise.resolve(l).then(async s=>{if(n.value==="aborted")return P;let g=await this._def.schema._parseAsync({data:s,path:i.path,parent:i});return g.status==="aborted"?P:g.status==="dirty"?sn(g.value):n.value==="dirty"?sn(g.value):g});{if(n.value==="aborted")return P;let s=this._def.schema._parseSync({data:l,path:i.path,parent:i});return s.status==="aborted"?P:s.status==="dirty"?sn(s.value):n.value==="dirty"?sn(s.value):s}}if(a.type==="refinement"){let l=s=>{let g=a.refinement(s,r);if(i.common.async)return Promise.resolve(g);if(g instanceof Promise)throw new Error("Async refinement encountered during synchronous parse operation. Use .parseAsync instead.");return s};if(i.common.async===!1){let s=this._def.schema._parseSync({data:i.data,path:i.path,parent:i});return s.status==="aborted"?P:(s.status==="dirty"&&n.dirty(),l(s.value),{status:n.value,value:s.value})}else return this._def.schema._parseAsync({data:i.data,path:i.path,parent:i}).then(s=>s.status==="aborted"?P:(s.status==="dirty"&&n.dirty(),l(s.value).then(()=>({status:n.value,value:s.value}))))}if(a.type==="transform")if(i.common.async===!1){let l=this._def.schema._parseSync({data:i.data,path:i.path,parent:i});if(!Ut(l))return P;let s=a.transform(l.value,r);if(s instanceof Promise)throw new Error("Asynchronous transform encountered during synchronous parse operation. Use .parseAsync instead.");return{status:n.value,value:s}}else return this._def.schema._parseAsync({data:i.data,path:i.path,parent:i}).then(l=>Ut(l)?Promise.resolve(a.transform(l.value,r)).then(s=>({status:n.value,value:s})):P);J.assertNever(a)}};ft.create=(t,e,n)=>new ft({schema:t,typeName:$.ZodEffects,effect:e,...V(n)});ft.createWithPreprocess=(t,e,n)=>new ft({schema:e,effect:{type:"preprocess",transform:t},typeName:$.ZodEffects,...V(n)});var ut=class extends q{_parse(e){return this._getType(e)===C.undefined?Ne(void 0):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}};ut.create=(t,e)=>new ut({innerType:t,typeName:$.ZodOptional,...V(e)});var St=class extends q{_parse(e){return this._getType(e)===C.null?Ne(null):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}};St.create=(t,e)=>new St({innerType:t,typeName:$.ZodNullable,...V(e)});var xn=class extends q{_parse(e){let{ctx:n}=this._processInputParams(e),i=n.data;return n.parsedType===C.undefined&&(i=this._def.defaultValue()),this._def.innerType._parse({data:i,path:n.path,parent:n})}removeDefault(){return this._def.innerType}};xn.create=(t,e)=>new xn({innerType:t,typeName:$.ZodDefault,defaultValue:typeof e.default=="function"?e.default:()=>e.default,...V(e)});var bn=class extends q{_parse(e){let{ctx:n}=this._processInputParams(e),i={...n,common:{...n.common,issues:[]}},a=this._def.innerType._parse({data:i.data,path:i.path,parent:{...i}});return Fn(a)?a.then(r=>({status:"valid",value:r.status==="valid"?r.value:this._def.catchValue({get error(){return new We(i.common.issues)},input:i.data})})):{status:"valid",value:a.status==="valid"?a.value:this._def.catchValue({get error(){return new We(i.common.issues)},input:i.data})}}removeCatch(){return this._def.innerType}};bn.create=(t,e)=>new bn({innerType:t,typeName:$.ZodCatch,catchValue:typeof e.catch=="function"?e.catch:()=>e.catch,...V(e)});var qn=class extends q{_parse(e){if(this._getType(e)!==C.nan){let i=this._getOrReturnCtx(e);return I(i,{code:_.invalid_type,expected:C.nan,received:i.parsedType}),P}return{status:"valid",value:e.data}}};qn.create=t=>new qn({typeName:$.ZodNaN,...V(t)});var fo=Symbol("zod_brand"),gr=class extends q{_parse(e){let{ctx:n}=this._processInputParams(e),i=n.data;return this._def.type._parse({data:i,path:n.path,parent:n})}unwrap(){return this._def.type}},yr=class t extends q{_parse(e){let{status:n,ctx:i}=this._processInputParams(e);if(i.common.async)return(async()=>{let r=await this._def.in._parseAsync({data:i.data,path:i.path,parent:i});return r.status==="aborted"?P:r.status==="dirty"?(n.dirty(),sn(r.value)):this._def.out._parseAsync({data:r.value,path:i.path,parent:i})})();{let a=this._def.in._parseSync({data:i.data,path:i.path,parent:i});return a.status==="aborted"?P:a.status==="dirty"?(n.dirty(),{status:"dirty",value:a.value}):this._def.out._parseSync({data:a.value,path:i.path,parent:i})}}static create(e,n){return new t({in:e,out:n,typeName:$.ZodPipeline})}},wn=class extends q{_parse(e){let n=this._def.innerType._parse(e),i=a=>(Ut(a)&&(a.value=Object.freeze(a.value)),a);return Fn(n)?n.then(a=>i(a)):i(n)}unwrap(){return this._def.innerType}};wn.create=(t,e)=>new wn({innerType:t,typeName:$.ZodReadonly,...V(e)});function wa(t,e){let n=typeof t=="function"?t(e):typeof t=="string"?{message:t}:t;return typeof n=="string"?{message:n}:n}function Sa(t,e={},n){return t?Vt.create().superRefine((i,a)=>{let r=t(i);if(r instanceof Promise)return r.then(l=>{if(!l){let s=wa(e,i),g=s.fatal??n??!0;a.addIssue({code:"custom",...s,fatal:g})}});if(!r){let l=wa(e,i),s=l.fatal??n??!0;a.addIssue({code:"custom",...l,fatal:s})}}):Vt.create()}var mo={object:Ye.lazycreate},$;(function(t){t.ZodString="ZodString",t.ZodNumber="ZodNumber",t.ZodNaN="ZodNaN",t.ZodBigInt="ZodBigInt",t.ZodBoolean="ZodBoolean",t.ZodDate="ZodDate",t.ZodSymbol="ZodSymbol",t.ZodUndefined="ZodUndefined",t.ZodNull="ZodNull",t.ZodAny="ZodAny",t.ZodUnknown="ZodUnknown",t.ZodNever="ZodNever",t.ZodVoid="ZodVoid",t.ZodArray="ZodArray",t.ZodObject="ZodObject",t.ZodUnion="ZodUnion",t.ZodDiscriminatedUnion="ZodDiscriminatedUnion",t.ZodIntersection="ZodIntersection",t.ZodTuple="ZodTuple",t.ZodRecord="ZodRecord",t.ZodMap="ZodMap",t.ZodSet="ZodSet",t.ZodFunction="ZodFunction",t.ZodLazy="ZodLazy",t.ZodLiteral="ZodLiteral",t.ZodEnum="ZodEnum",t.ZodEffects="ZodEffects",t.ZodNativeEnum="ZodNativeEnum",t.ZodOptional="ZodOptional",t.ZodNullable="ZodNullable",t.ZodDefault="ZodDefault",t.ZodCatch="ZodCatch",t.ZodPromise="ZodPromise",t.ZodBranded="ZodBranded",t.ZodPipeline="ZodPipeline",t.ZodReadonly="ZodReadonly"})($||($={}));var po=(t,e={message:`Input not instance of ${t.name}`})=>Sa(n=>n instanceof t,e),Ia=Gt.create,Ca=on.create,ho=qn.create,go=ln.create,La=cn.create,yo=un.create,vo=Hn.create,xo=dn.create,bo=fn.create,wo=Vt.create,ko=Rt.create,To=wt.create,_o=Un.create,Eo=Ot.create,So=Ye.create,Io=Ye.strictCreate,Co=mn.create,Lo=ri.create,Ao=pn.create,Mo=Et.create,Do=ii.create,Bo=Gn.create,Ro=Vn.create,Oo=ai.create,Po=hn.create,zo=gn.create,No=yn.create,$o=vn.create,Fo=qt.create,jo=ft.create,Ho=ut.create,Uo=St.create,Go=ft.createWithPreprocess,Vo=yr.create,qo=()=>Ia().optional(),Zo=()=>Ca().optional(),Wo=()=>La().optional(),Yo={string:(t=>Gt.create({...t,coerce:!0})),number:(t=>on.create({...t,coerce:!0})),boolean:(t=>cn.create({...t,coerce:!0})),bigint:(t=>ln.create({...t,coerce:!0})),date:(t=>un.create({...t,coerce:!0}))};var Ko=P;function u(t,...e){let n="debug",i=[...e];e.length>0&&typeof e[e.length-1]=="string"&&["debug","info","warn","error"].includes(e[e.length-1])&&(n=i.pop());let r=`[Timekeeper v${GM_info.script.version}]`;({debug:console.log,info:console.info,warn:console.warn,error:console.error})[n](`${r} ${t}`,...i)}function Zt(t,e=t){let n=Math.floor(t/3600),i=Math.floor(t%3600/60),a=String(t%60).padStart(2,"0");return e<3600?`${i<10?i:String(i).padStart(2,"0")}:${a}`:`${e>=36e3?String(n).padStart(2,"0"):n}:${String(i).padStart(2,"0")}:${a}`}function Di(t,e=window.location.href){try{let n=new URL(e);return n.searchParams.set("t",`${t}s`),n.toString()}catch{return`https://www.youtube.com/watch?v=${e.search(/[?&]v=/)>=0?e.split(/[?&]v=/)[1].split(/&/)[0]:e.split(/\/live\/|\/shorts\/|\?|&/)[1]}&t=${t}s`}}function vr(){let t=new Date;return t.getUTCFullYear()+"-"+String(t.getUTCMonth()+1).padStart(2,"0")+"-"+String(t.getUTCDate()).padStart(2,"0")+"--"+String(t.getUTCHours()).padStart(2,"0")+"-"+String(t.getUTCMinutes()).padStart(2,"0")+"-"+String(t.getUTCSeconds()).padStart(2,"0")}var Jo=[{emoji:"\u{1F942}",month:1,day:1,name:"New Year's Day"},{emoji:"\u{1F49D}",month:2,day:14,name:"Valentine's Day"},{emoji:"\u{1F986}",month:5,day:25,name:"Kanna's Debut Anniversary"},{emoji:"\u{1F383}",month:10,day:31,name:"Halloween"},{emoji:"\u{1F382}",month:9,day:15,name:"Kanna's Birthday"},{emoji:"\u{1F332}",month:12,day:25,name:"Christmas"}];function Aa(){let t=new Date,e=t.getFullYear(),n=t.toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"});for(let i of Jo){let a=new Date(e,i.month-1,i.day),r=a.getTime()-t.getTime(),l=r/(1e3*60*60*24);if(l<=5&&l>=-2)return u(`Current date: ${n}, Selected emoji: ${i.emoji} (${i.name}), Days until holiday: ${Math.ceil(l)}`),i.emoji;if(l<-2&&(a=new Date(e+1,i.month-1,i.day),r=a.getTime()-t.getTime(),l=r/(1e3*60*60*24),l<=5&&l>=-2))return u(`Current date: ${n}, Selected emoji: ${i.emoji} (${i.name}), Days until holiday: ${Math.ceil(l)}`),i.emoji;if(l>5&&(a=new Date(e-1,i.month-1,i.day),r=a.getTime()-t.getTime(),l=r/(1e3*60*60*24),l<=5&&l>=-2))return u(`Current date: ${n}, Selected emoji: ${i.emoji} (${i.name}), Days until holiday: ${Math.ceil(l)}`),i.emoji}return u(`Current date: ${n}, No holiday emoji (not within range)`),null}var mt=null,Zn=null,Xo=500,kn=null,xr=!1,Wt=null;function Qo(){return(!mt||!document.body.contains(mt))&&(mt=document.createElement("div"),mt.className="ytls-tooltip",mt.style.pointerEvents="none",document.body.appendChild(mt),window.addEventListener("scroll",Ma,!0),window.addEventListener("resize",Ma,!0)),mt}function el(t,e,n){let a=window.innerWidth,r=window.innerHeight,l=t.getBoundingClientRect(),s=l.width,g=l.height,p=e+10,b=n+10;p+s>a-10&&(p=e-s-10),b+g>r-10&&(b=n-g-10),p=Math.max(10,Math.min(p,a-s-10)),b=Math.max(10,Math.min(b,r-g-10)),t.style.left=`${p}px`,t.style.top=`${b}px`}function Da(t,e){let i=window.innerWidth,a=window.innerHeight,r=e.getBoundingClientRect(),l=t.getBoundingClientRect(),s=l.width,g=l.height,p=Math.round(r.right+8),b=Math.round(r.top);p+s>i-8&&(p=Math.round(r.left-s-8)),p=Math.max(8,Math.min(p,i-s-8)),b+g>a-8&&(b=Math.round(r.bottom-g)),b=Math.max(8,Math.min(b,a-g-8)),t.style.left=`${p}px`,t.style.top=`${b}px`}function Ma(){if(!(!mt||!kn)&&mt.classList.contains("ytls-tooltip-visible"))try{Da(mt,kn)}catch{}}function tl(t=50){Wt&&(clearTimeout(Wt),Wt=null),!xr&&(Wt=setTimeout(()=>{Bi(),Wt=null},t))}function nl(t,e,n,i){Zn&&clearTimeout(Zn),i&&(kn=i,xr=!0),Zn=setTimeout(()=>{let a=Qo();a.textContent=t,a.classList.remove("ytls-tooltip-visible"),i?requestAnimationFrame(()=>{Da(a,i),requestAnimationFrame(()=>{a.classList.add("ytls-tooltip-visible")})}):(el(a,e,n),requestAnimationFrame(()=>{a.classList.add("ytls-tooltip-visible")}))},Xo)}function Bi(){Zn&&(clearTimeout(Zn),Zn=null),Wt&&(clearTimeout(Wt),Wt=null),mt&&mt.classList.remove("ytls-tooltip-visible"),kn=null,xr=!1}function kt(t,e){let n=0,i=0,a=g=>{n=g.clientX,i=g.clientY,xr=!0,kn=t;let p=typeof e=="function"?e():e;p&&nl(p,n,i,t)},r=g=>{n=g.clientX,i=g.clientY},l=()=>{xr=!1,tl()};t.addEventListener("mouseenter",a),t.addEventListener("mousemove",r),t.addEventListener("mouseleave",l);let s=new MutationObserver(()=>{try{if(!document.body.contains(t))kn===t&&Bi();else{let g=window.getComputedStyle(t);(g.display==="none"||g.visibility==="hidden"||g.opacity==="0")&&kn===t&&Bi()}}catch{}});try{s.observe(t,{attributes:!0,attributeFilter:["class","style"]}),s.observe(document.body,{childList:!0,subtree:!0})}catch{}t.__tooltipCleanup=()=>{t.removeEventListener("mouseenter",a),t.removeEventListener("mousemove",r),t.removeEventListener("mouseleave",l);try{s.disconnect()}catch{}delete t.__tooltipObserver},t.__tooltipObserver=s}var Ri="#ytls-pane{background:rgba(19,19,19,.8);text-align:left;position:fixed;bottom:0;right:0;padding:0;margin:0;border-radius:12px;border:1px solid rgba(85,85,85,.8);opacity:.9;z-index:5000;font-family:Arial,sans-serif;width:300px;height:90vh;min-width:300px;max-width:800px;min-height:400px;max-height:90vh;user-select:none;display:flex;flex-direction:column;will-change:width,height;transform:translateZ(0);backface-visibility:hidden;contain:layout style paint;overflow:hidden}#ytls-pane:hover{opacity:1}#ytls-resize-handle{position:absolute;bottom:0;right:0;width:20px;height:20px;cursor:auto;z-index:10;pointer-events:none;background:0 0;margin:0;padding:0}#ytls-resize-handle::before{display:none;content:none}#ytls-resize-bl,#ytls-resize-br,#ytls-resize-tl,#ytls-resize-tr{position:absolute;width:16px;height:16px;z-index:11;background:0 0;pointer-events:auto}#ytls-resize-tl{top:0;left:0;cursor:nwse-resize}#ytls-resize-tr{top:0;right:0;cursor:nesw-resize}#ytls-resize-bl{bottom:0;left:0;cursor:nesw-resize}#ytls-resize-br{bottom:0;right:0;cursor:nwse-resize}#ytls-content{display:flex;flex-direction:column;width:100%;height:100%;min-height:0;box-sizing:border-box;position:relative}#ytls-content ul{flex:1 1 auto;overflow-y:auto;margin:0!important;padding:0!important;border:none!important;box-sizing:border-box;width:100%;max-width:100%;min-height:0;z-index:1}#ytls-content ul li.ytls-placeholder{display:flex;align-items:center;justify-content:center;height:100%;width:100%;color:#bfbfbf;font-size:14px;font-style:italic;padding:12px;text-align:center;box-sizing:border-box}#ytls-pane-header{position:relative;z-index:2}#ytls-buttons{position:relative;z-index:2;flex-shrink:0;display:flex;gap:8px;justify-content:flex-end;padding:10px 18px 10px 16px;background:linear-gradient(0deg,#23272b 0,#212121 100%);border-radius:0 0 12px 12px;border-top:1px solid #23272b;margin-top:auto}#ytls-pane li{display:flex;flex-direction:column;padding:8px 12px;margin:0!important;border:none;border-top:1px solid rgba(85,85,85,.8);user-select:none;box-sizing:border-box;width:100%;max-width:100%}#ytls-pane li:first-child{border-top:none}#ytls-pane li.ytls-timestamp-highlight{background:#1f251d}#ytls-pane li.ytls-timestamp-pending-delete{background:rgba(128,0,0,.8)}#ytls-pane .time-row{display:flex;gap:5px;align-items:center}#ytls-pane .time-row a{flex-grow:1;max-width:100%;text-align:left;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}#ytls-pane .ytls-marker{position:absolute;height:100%;width:2px;background-color:red;cursor:pointer}#ytls-pane a,#ytls-pane input,#ytls-pane span{background:0 0;color:#fff;font-family:inherit;font-size:14px;text-decoration:none;border:none;outline:0}#ytls-pane input,#ytls-pane textarea{-webkit-user-select:text;-moz-user-select:text;-ms-user-select:text;user-select:text;caret-color:white}#ytls-buttons{flex-shrink:0;display:flex;gap:5px;justify-content:space-between;padding:8px 12px;background:#212121;border-radius:0 0 12px 12px;border-top:1px solid rgba(85,85,85,.8);z-index:2}#ytls-buttons button:hover{background:rgba(255,255,255,.2)}.ytls-main-button{background:#272727;color:#fff;font-size:24px;border:none;border-radius:5px;padding:5px;cursor:pointer;position:relative}.ytls-main-button:hover{background:#3f3f3f}.ytls-holiday-emoji{position:absolute;bottom:0;right:0;font-size:.25em;pointer-events:none}#ytls-pane-header{display:flex;justify-content:space-between;align-items:center;padding:10px 18px 10px 16px;white-space:nowrap;cursor:default;border-radius:12px 12px 0 0;border:none;background:linear-gradient(180deg,#23272b 0,#212121 100%);box-shadow:0 1px 0 0 #23272b;flex-shrink:0;color:#fafafa}#ytls-pane .ytls-version-display{font-size:14px;color:#666;margin-left:auto;padding-right:5px;cursor:default}#ytls-pane .ytls-google-user-display{font-size:12px;color:#4285f4;margin-left:8px;padding:2px 6px;cursor:default;background:rgba(66,133,244,.1);border-radius:4px}#ytls-pane .ytls-backup-status-display{font-size:12px;color:#9acd32;margin-left:8px;padding:2px 6px;cursor:default;background:rgba(154,205,50,.12);border-radius:4px}#ytls-current-time{color:#fff;font-size:14px;cursor:pointer;position:relative}.ytls-backup-indicator{display:inline-block;width:8px;height:8px;border-radius:50%;background-color:#666;cursor:help;flex-shrink:0}#ytls-settings-modal{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#1a1a1a;padding:8px;border-radius:10px;z-index:10000;color:#fff;text-align:center;width:200px;box-shadow:0 0 10px rgba(0,0,0,.5)}#ytls-delete-all-modal,#ytls-load-modal,#ytls-save-modal{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#333;padding:8px;border-radius:10px;z-index:10000;color:#fff;text-align:center;width:fit-content;max-width:90vw;box-shadow:0 0 10px rgba(0,0,0,.5)}.ytls-modal-header{display:flex;align-items:flex-end;margin-bottom:0;gap:10px}.ytls-modal-close-button{position:absolute;top:8px;right:8px;width:16px;height:16px;background:#f44;color:#fff;border:none;border-radius:3px;font-size:14px;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;line-height:1;padding:0;flex-shrink:0;z-index:1}.ytls-modal-close-button:hover{background:#f66}#ytls-settings-content{display:flex;flex-direction:column;gap:10px;align-items:center;background:#2a2a2a;border:2px solid #3a3a3a;border-radius:0 4px 4px 4px;padding:10px;margin-top:-2px;position:relative;z-index:1}.ytls-section-heading{margin:0 0 10px 0;padding:0;font-size:16px;font-weight:700;color:#fff;text-align:center}#ytls-settings-nav{display:flex;gap:6px;flex:0}#ytls-settings-nav .ytls-settings-modal-button{flex:0;width:auto;height:24px;margin-bottom:0;background:#2a2a2a;font-size:13px;padding:0 8px;display:flex;align-items:center;justify-content:center;line-height:1;border:2px solid transparent;border-radius:4px 4px 0 0;border-bottom:2px solid transparent;white-space:nowrap;position:relative}#ytls-settings-nav .ytls-settings-modal-button .ytls-tab-text{display:none}#ytls-settings-nav .ytls-settings-modal-button.active .ytls-tab-text{display:inline}#ytls-settings-nav .ytls-settings-modal-button:hover{background:#3a3a3a}#ytls-settings-nav .ytls-settings-modal-button.active{background:#2a2a2a;border:2px solid #3a3a3a;border-bottom:2px solid #2a2a2a;z-index:2}.ytls-button-grid{display:grid;grid-template-columns:1fr;gap:5px;width:100%}.ytls-settings-modal-button{width:100%;height:32px;background:#555;color:#fff;border:none;border-radius:5px;cursor:pointer;font-size:13px;display:flex;justify-content:center;align-items:center;margin-bottom:5px;padding:0 8px}.ytls-settings-modal-button:hover{background:#777}#ytls-delete-all-modal p,#ytls-load-modal p,#ytls-save-modal p{margin-bottom:15px;font-size:16px}.ytls-save-modal-button{background:#555;color:#fff;padding:10px 20px;border:none;border-radius:5px;cursor:pointer;margin-right:10px}.ytls-save-modal-button:last-of-type{margin-right:0}.ytls-save-modal-cancel-button{background:#444;color:#fff;padding:10px 20px;border:none;border-radius:5px;cursor:pointer;margin-top:15px;display:block;width:100%}.ytls-file-operation-button{background:#555;color:#fff;font-size:12px;padding:5px 10px;border:none;border-radius:5px;cursor:pointer}.ytls-file-operation-button:hover{background:#777}.ytls-hidden-file-input{display:none}#ytls-header-button{align-items:center;background:0 0;border:none;color:var(--yt-spec-text-primary,currentColor);cursor:pointer;display:inline-flex;font-size:20px;height:40px;margin-left:6px;padding:0 6px;text-decoration:none}#ytls-header-button:hover{color:var(--yt-spec-call-to-action,#3ea6ff)}#ytls-header-button:focus-visible{outline:2px solid var(--yt-spec-call-to-action,#3ea6ff);outline-offset:2px}#ytls-header-button img{display:block;height:32px;max-width:48px;pointer-events:none;width:auto}.ytls-fade-in{animation:fadeIn .3s ease-in-out forwards}.ytls-fade-out{animation:fadeOut .3s ease-in-out forwards}.ytls-zoom-in{animation:zoomIn .4s cubic-bezier(.68,-.55,.265,1.55) forwards;transform-origin:center center}.ytls-zoom-out{animation:zoomOut .4s cubic-bezier(.68,-.55,.265,1.55) forwards;transform-origin:center center}@keyframes fadeIn{from{opacity:0}to{opacity:1}}@keyframes fadeOut{from{opacity:1}to{opacity:0}}@keyframes zoomIn{from{opacity:0;transform:scale(.1)}to{opacity:1;transform:scale(1)}}@keyframes zoomOut{from{opacity:1;transform:scale(1)}to{opacity:0;transform:scale(.1)}}.ytls-tooltip{position:fixed;background:rgba(97,97,97,.92);color:#fff;padding:8px 10px;border-radius:2px;font-size:12px;font-family:Roboto,Arial,sans-serif;font-weight:400;line-height:1.4;letter-spacing:.2px;z-index:10001;pointer-events:none;white-space:pre-line;max-width:300px;box-shadow:0 1px 2px rgba(0,0,0,.1);opacity:0;transition:opacity .2s cubic-bezier(0, 0, .2, 1)}.ytls-tooltip.ytls-tooltip-visible{opacity:1}";var Oe=Uint8Array,at=Uint16Array,Fi=Int32Array,ji=new Oe([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),Hi=new Oe([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),Ba=new Oe([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),$a=function(t,e){for(var n=new at(31),i=0;i<31;++i)n[i]=e+=1<<t[i-1];for(var a=new Fi(n[30]),i=1;i<30;++i)for(var r=n[i];r<n[i+1];++r)a[r]=r-n[i]<<5|i;return{b:n,r:a}},Fa=$a(ji,2),rl=Fa.b,Pi=Fa.r;rl[28]=258,Pi[258]=28;var ja=$a(Hi,0),fc=ja.b,Ra=ja.r,zi=new at(32768);for(ie=0;ie<32768;++ie)Pt=(ie&43690)>>1|(ie&21845)<<1,Pt=(Pt&52428)>>2|(Pt&13107)<<2,Pt=(Pt&61680)>>4|(Pt&3855)<<4,zi[ie]=((Pt&65280)>>8|(Pt&255)<<8)>>1;var Pt,ie,kr=(function(t,e,n){for(var i=t.length,a=0,r=new at(e);a<i;++a)t[a]&&++r[t[a]-1];var l=new at(e);for(a=1;a<e;++a)l[a]=l[a-1]+r[a-1]<<1;var s;if(n){s=new at(1<<e);var g=15-e;for(a=0;a<i;++a)if(t[a])for(var p=a<<4|t[a],b=e-t[a],M=l[t[a]-1]++<<b,R=M|(1<<b)-1;M<=R;++M)s[zi[M]>>g]=p}else for(s=new at(i),a=0;a<i;++a)t[a]&&(s[a]=zi[l[t[a]-1]++]>>15-t[a]);return s}),Tn=new Oe(288);for(ie=0;ie<144;++ie)Tn[ie]=8;var ie;for(ie=144;ie<256;++ie)Tn[ie]=9;var ie;for(ie=256;ie<280;++ie)Tn[ie]=7;var ie;for(ie=280;ie<288;++ie)Tn[ie]=8;var ie,si=new Oe(32);for(ie=0;ie<32;++ie)si[ie]=5;var ie,il=kr(Tn,9,0);var al=kr(si,5,0);var Ha=function(t){return(t+7)/8|0},Ua=function(t,e,n){return(e==null||e<0)&&(e=0),(n==null||n>t.length)&&(n=t.length),new Oe(t.subarray(e,n))};var sl=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],li=function(t,e,n){var i=new Error(e||sl[t]);if(i.code=t,Error.captureStackTrace&&Error.captureStackTrace(i,li),!n)throw i;return i};var zt=function(t,e,n){n<<=e&7;var i=e/8|0;t[i]|=n,t[i+1]|=n>>8},br=function(t,e,n){n<<=e&7;var i=e/8|0;t[i]|=n,t[i+1]|=n>>8,t[i+2]|=n>>16},Oi=function(t,e){for(var n=[],i=0;i<t.length;++i)t[i]&&n.push({s:i,f:t[i]});var a=n.length,r=n.slice();if(!a)return{t:Va,l:0};if(a==1){var l=new Oe(n[0].s+1);return l[n[0].s]=1,{t:l,l:1}}n.sort(function(ve,Ae){return ve.f-Ae.f}),n.push({s:-1,f:25001});var s=n[0],g=n[1],p=0,b=1,M=2;for(n[0]={s:-1,f:s.f+g.f,l:s,r:g};b!=a-1;)s=n[n[p].f<n[M].f?p++:M++],g=n[p!=b&&n[p].f<n[M].f?p++:M++],n[b++]={s:-1,f:s.f+g.f,l:s,r:g};for(var R=r[0].s,i=1;i<a;++i)r[i].s>R&&(R=r[i].s);var F=new at(R+1),X=Ni(n[b-1],F,0);if(X>e){var i=0,ae=0,de=X-e,he=1<<de;for(r.sort(function(Ae,ye){return F[ye.s]-F[Ae.s]||Ae.f-ye.f});i<a;++i){var me=r[i].s;if(F[me]>e)ae+=he-(1<<X-F[me]),F[me]=e;else break}for(ae>>=de;ae>0;){var ee=r[i].s;F[ee]<e?ae-=1<<e-F[ee]++-1:++i}for(;i>=0&&ae;--i){var ce=r[i].s;F[ce]==e&&(--F[ce],++ae)}X=e}return{t:new Oe(F),l:X}},Ni=function(t,e,n){return t.s==-1?Math.max(Ni(t.l,e,n+1),Ni(t.r,e,n+1)):e[t.s]=n},Oa=function(t){for(var e=t.length;e&&!t[--e];);for(var n=new at(++e),i=0,a=t[0],r=1,l=function(g){n[i++]=g},s=1;s<=e;++s)if(t[s]==a&&s!=e)++r;else{if(!a&&r>2){for(;r>138;r-=138)l(32754);r>2&&(l(r>10?r-11<<5|28690:r-3<<5|12305),r=0)}else if(r>3){for(l(a),--r;r>6;r-=6)l(8304);r>2&&(l(r-3<<5|8208),r=0)}for(;r--;)l(a);r=1,a=t[s]}return{c:n.subarray(0,i),n:e}},wr=function(t,e){for(var n=0,i=0;i<e.length;++i)n+=t[i]*e[i];return n},Ga=function(t,e,n){var i=n.length,a=Ha(e+2);t[a]=i&255,t[a+1]=i>>8,t[a+2]=t[a]^255,t[a+3]=t[a+1]^255;for(var r=0;r<i;++r)t[a+r+4]=n[r];return(a+4+i)*8},Pa=function(t,e,n,i,a,r,l,s,g,p,b){zt(e,b++,n),++a[256];for(var M=Oi(a,15),R=M.t,F=M.l,X=Oi(r,15),ae=X.t,de=X.l,he=Oa(R),me=he.c,ee=he.n,ce=Oa(ae),ve=ce.c,Ae=ce.n,ye=new at(19),te=0;te<me.length;++te)++ye[me[te]&31];for(var te=0;te<ve.length;++te)++ye[ve[te]&31];for(var Z=Oi(ye,7),xe=Z.t,ke=Z.l,be=19;be>4&&!xe[Ba[be-1]];--be);var Xe=p+5<<3,Pe=wr(a,Tn)+wr(r,si)+l,He=wr(a,R)+wr(r,ae)+l+14+3*be+wr(ye,xe)+2*ye[16]+3*ye[17]+7*ye[18];if(g>=0&&Xe<=Pe&&Xe<=He)return Ga(e,b,t.subarray(g,g+p));var lt,Te,Ue,Tt;if(zt(e,b,1+(He<Pe)),b+=2,He<Pe){lt=kr(R,F,0),Te=R,Ue=kr(ae,de,0),Tt=ae;var Qn=kr(xe,ke,0);zt(e,b,ee-257),zt(e,b+5,Ae-1),zt(e,b+10,be-4),b+=14;for(var te=0;te<be;++te)zt(e,b+3*te,xe[Ba[te]]);b+=3*be;for(var Qe=[me,ve],et=0;et<2;++et)for(var Ge=Qe[et],te=0;te<Ge.length;++te){var ne=Ge[te]&31;zt(e,b,Qn[ne]),b+=xe[ne],ne>15&&(zt(e,b,Ge[te]>>5&127),b+=Ge[te]>>12)}}else lt=il,Te=Tn,Ue=al,Tt=si;for(var te=0;te<s;++te){var we=i[te];if(we>255){var ne=we>>18&31;br(e,b,lt[ne+257]),b+=Te[ne+257],ne>7&&(zt(e,b,we>>23&31),b+=ji[ne]);var Nt=we&31;br(e,b,Ue[Nt]),b+=Tt[Nt],Nt>3&&(br(e,b,we>>5&8191),b+=Hi[Nt])}else br(e,b,lt[we]),b+=Te[we]}return br(e,b,lt[256]),b+Te[256]},ol=new Fi([65540,131080,131088,131104,262176,1048704,1048832,2114560,2117632]),Va=new Oe(0),ll=function(t,e,n,i,a,r){var l=r.z||t.length,s=new Oe(i+l+5*(1+Math.ceil(l/7e3))+a),g=s.subarray(i,s.length-a),p=r.l,b=(r.r||0)&7;if(e){b&&(g[0]=r.r>>3);for(var M=ol[e-1],R=M>>13,F=M&8191,X=(1<<n)-1,ae=r.p||new at(32768),de=r.h||new at(X+1),he=Math.ceil(n/3),me=2*he,ee=function(Ve){return(t[Ve]^t[Ve+1]<<he^t[Ve+2]<<me)&X},ce=new Fi(25e3),ve=new at(288),Ae=new at(32),ye=0,te=0,Z=r.i||0,xe=0,ke=r.w||0,be=0;Z+2<l;++Z){var Xe=ee(Z),Pe=Z&32767,He=de[Xe];if(ae[Pe]=He,de[Xe]=Pe,ke<=Z){var lt=l-Z;if((ye>7e3||xe>24576)&&(lt>423||!p)){b=Pa(t,g,0,ce,ve,Ae,te,xe,be,Z-be,b),xe=ye=te=0,be=Z;for(var Te=0;Te<286;++Te)ve[Te]=0;for(var Te=0;Te<30;++Te)Ae[Te]=0}var Ue=2,Tt=0,Qn=F,Qe=Pe-He&32767;if(lt>2&&Xe==ee(Z-Qe))for(var et=Math.min(R,lt)-1,Ge=Math.min(32767,Z),ne=Math.min(258,lt);Qe<=Ge&&--Qn&&Pe!=He;){if(t[Z+Ue]==t[Z+Ue-Qe]){for(var we=0;we<ne&&t[Z+we]==t[Z+we-Qe];++we);if(we>Ue){if(Ue=we,Tt=Qe,we>et)break;for(var Nt=Math.min(Qe,we-2),Cr=0,Te=0;Te<Nt;++Te){var _n=Z-Qe+Te&32767,gi=ae[_n],er=_n-gi&32767;er>Cr&&(Cr=er,He=_n)}}}Pe=He,He=ae[Pe],Qe+=Pe-He&32767}if(Tt){ce[xe++]=268435456|Pi[Ue]<<18|Ra[Tt];var Lr=Pi[Ue]&31,En=Ra[Tt]&31;te+=ji[Lr]+Hi[En],++ve[257+Lr],++Ae[En],ke=Z+Ue,++ye}else ce[xe++]=t[Z],++ve[t[Z]]}}for(Z=Math.max(Z,ke);Z<l;++Z)ce[xe++]=t[Z],++ve[t[Z]];b=Pa(t,g,p,ce,ve,Ae,te,xe,be,Z-be,b),p||(r.r=b&7|g[b/8|0]<<3,b-=7,r.h=de,r.p=ae,r.i=Z,r.w=ke)}else{for(var Z=r.w||0;Z<l+p;Z+=65535){var Yt=Z+65535;Yt>=l&&(g[b/8|0]=p,Yt=l),b=Ga(g,b+1,t.subarray(Z,Yt))}r.i=l}return Ua(s,0,i+Ha(b)+a)},cl=(function(){for(var t=new Int32Array(256),e=0;e<256;++e){for(var n=e,i=9;--i;)n=(n&1&&-306674912)^n>>>1;t[e]=n}return t})(),ul=function(){var t=-1;return{p:function(e){for(var n=t,i=0;i<e.length;++i)n=cl[n&255^e[i]]^n>>>8;t=n},d:function(){return~t}}};var dl=function(t,e,n,i,a){if(!a&&(a={l:1},e.dictionary)){var r=e.dictionary.subarray(-32768),l=new Oe(r.length+t.length);l.set(r),l.set(t,r.length),t=l,a.w=r.length}return ll(t,e.level==null?6:e.level,e.mem==null?a.l?Math.ceil(Math.max(8,Math.min(13,Math.log(t.length)))*1.5):20:12+e.mem,n,i,a)},qa=function(t,e){var n={};for(var i in t)n[i]=t[i];for(var i in e)n[i]=e[i];return n};var Re=function(t,e,n){for(;n;++e)t[e]=n,n>>>=8};function fl(t,e){return dl(t,e||{},0,0)}var Za=function(t,e,n,i){for(var a in t){var r=t[a],l=e+a,s=i;Array.isArray(r)&&(s=qa(i,r[1]),r=r[0]),r instanceof Oe?n[l]=[r,s]:(n[l+="/"]=[new Oe(0),s],Za(r,l,n,i))}},za=typeof TextEncoder<"u"&&new TextEncoder,ml=typeof TextDecoder<"u"&&new TextDecoder,pl=0;try{ml.decode(Va,{stream:!0}),pl=1}catch{}function oi(t,e){if(e){for(var n=new Oe(t.length),i=0;i<t.length;++i)n[i]=t.charCodeAt(i);return n}if(za)return za.encode(t);for(var a=t.length,r=new Oe(t.length+(t.length>>1)),l=0,s=function(b){r[l++]=b},i=0;i<a;++i){if(l+5>r.length){var g=new Oe(l+8+(a-i<<1));g.set(r),r=g}var p=t.charCodeAt(i);p<128||e?s(p):p<2048?(s(192|p>>6),s(128|p&63)):p>55295&&p<57344?(p=65536+(p&1047552)|t.charCodeAt(++i)&1023,s(240|p>>18),s(128|p>>12&63),s(128|p>>6&63),s(128|p&63)):(s(224|p>>12),s(128|p>>6&63),s(128|p&63))}return Ua(r,0,l)}var $i=function(t){var e=0;if(t)for(var n in t){var i=t[n].length;i>65535&&li(9),e+=i+4}return e},Na=function(t,e,n,i,a,r,l,s){var g=i.length,p=n.extra,b=s&&s.length,M=$i(p);Re(t,e,l!=null?33639248:67324752),e+=4,l!=null&&(t[e++]=20,t[e++]=n.os),t[e]=20,e+=2,t[e++]=n.flag<<1|(r<0&&8),t[e++]=a&&8,t[e++]=n.compression&255,t[e++]=n.compression>>8;var R=new Date(n.mtime==null?Date.now():n.mtime),F=R.getFullYear()-1980;if((F<0||F>119)&&li(10),Re(t,e,F<<25|R.getMonth()+1<<21|R.getDate()<<16|R.getHours()<<11|R.getMinutes()<<5|R.getSeconds()>>1),e+=4,r!=-1&&(Re(t,e,n.crc),Re(t,e+4,r<0?-r-2:r),Re(t,e+8,n.size)),Re(t,e+12,g),Re(t,e+14,M),e+=16,l!=null&&(Re(t,e,b),Re(t,e+6,n.attrs),Re(t,e+10,l),e+=14),t.set(i,e),e+=g,M)for(var X in p){var ae=p[X],de=ae.length;Re(t,e,+X),Re(t,e+2,de),t.set(ae,e+4),e+=4+de}return b&&(t.set(s,e),e+=b),e},hl=function(t,e,n,i,a){Re(t,e,101010256),Re(t,e+8,n),Re(t,e+10,n),Re(t,e+12,i),Re(t,e+16,a)};function Wa(t,e){e||(e={});var n={},i=[];Za(t,"",n,e);var a=0,r=0;for(var l in n){var s=n[l],g=s[0],p=s[1],b=p.level==0?0:8,M=oi(l),R=M.length,F=p.comment,X=F&&oi(F),ae=X&&X.length,de=$i(p.extra);R>65535&&li(11);var he=b?fl(g,p):g,me=he.length,ee=ul();ee.p(g),i.push(qa(p,{size:g.length,crc:ee.d(),c:he,f:M,m:X,u:R!=l.length||X&&F.length!=ae,o:a,compression:b})),a+=30+R+de+me,r+=76+2*(R+de)+(ae||0)+me}for(var ce=new Oe(r+22),ve=a,Ae=r-a,ye=0;ye<i.length;++ye){var M=i[ye];Na(ce,M.o,M,M.f,M.u,M.c.length);var te=30+M.f.length+$i(M.extra);ce.set(M.c,M.o+te),Na(ce,a,M,M.f,M.u,M.c.length,M.o,M.m),a+=16+te+(M.m?M.m.length:0)}return hl(ce,a,i.length,Ae,ve),ce}var gl=B.preprocess(t=>typeof t=="string"&&t.trim().length>0?t:crypto.randomUUID(),B.string()),Wn=B.object({guid:gl,start:B.number().finite().nonnegative(),comment:B.string()}),Tr=Wn.array(),Ui=Wn.extend({video_id:B.string()}),Ka=B.object({x:B.number().finite(),y:B.number().finite(),width:B.number().finite().positive().optional(),height:B.number().finite().positive().optional()}),ci=B.object({video_id:B.string(),timestamps:Tr}),hc=B.record(ci),Ya=B.object({isSignedIn:B.boolean().catch(!1),accessToken:B.string().nullable().catch(null),userName:B.string().nullable().catch(null),email:B.string().nullable().catch(null)}),Gi=B.union([Ya,B.string().transform((t,e)=>{try{let n=JSON.parse(t);return Ya.parse(n)}catch{return e.addIssue({code:B.ZodIssueCode.custom,message:"Invalid JSON string for auth state"}),B.NEVER}})]).catch({isSignedIn:!1,accessToken:null,userName:null,email:null}),Vi=B.object({autoBackupEnabled:B.boolean(),autoBackupIntervalMinutes:B.number().positive(),lastAutoBackupAt:B.number().int().positive().nullable().optional()}),yl=B.object({type:B.literal("timekeeper_oauth_token"),token:B.string().min(1),timestamp:B.number().optional()}),vl=B.object({type:B.literal("timekeeper_oauth_error"),error:B.string(),timestamp:B.number().optional()}),gc=B.union([yl,vl]),yc=B.object({name:B.string().optional(),email:B.string().email().optional(),id:B.string().optional(),picture:B.string().url().optional()});var z={isSignedIn:!1,accessToken:null,userName:null,email:null},ht=!0,Je=30,ot=null,Kn=!1,Yn=0,pt=null,qi=null,Ee=null,se=null,ui=null;function es(t){qi=t}function ts(t){Ee=t}function ns(t){se=t}function Zi(t){ui=t}var Ja=!1;function rs(){if(!Ja)try{let t=document.createElement("style");t.textContent=`
@keyframes tk-spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
@keyframes tk-blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.2; } }
.tk-auth-spinner { display:inline-block; width:12px; height:12px; border:2px solid rgba(255,165,0,0.3); border-top-color:#ffa500; border-radius:50%; margin-right:6px; vertical-align:-2px; animation: tk-spin 0.9s linear infinite; }
.tk-auth-blink { animation: tk-blink 0.4s ease-in-out 3; }
`,document.head.appendChild(t),Ja=!0}catch{}}var is=null,_r=null,Er=null;function Wi(t){is=t}function fi(t){_r=t}function mi(t){Er=t}var Xa="1023528652072-45cu3dr7o5j79vsdn8643bhle9ee8kds.apps.googleusercontent.com",xl="https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/userinfo.profile",bl="https://www.youtube.com/",wl=30*1e3,kl=1800*1e3,Qa=5,di=null,st=null;async function Yi(){try{let t=await Er("googleAuthState"),e=t&&typeof t=="object"?{...t,accessToken:t.accessToken?"[REDACTED]":null}:t;u("Loading Google auth state from IndexedDB:",e);let n=Gi.safeParse(t);if(n.success)z={...z,...n.data},z.isSignedIn&&z.accessToken&&u(`Reusing stored Google auth token for ${z.userName||z.email||"user"}`),Ir(),z.isSignedIn&&z.accessToken&&await Xn(!0);else if(t!==void 0){let i=t&&typeof t=="object"?{...t,accessToken:t.accessToken?"[REDACTED]":null}:t;u("Google auth state failed validation:",{stored:i,errors:n.error.format()},"warn")}}catch(t){u("Failed to load Google auth state:",t,"error")}}async function pi(){try{let t=Gi.safeParse(z);if(!t.success){let e={...z,accessToken:z.accessToken?"[REDACTED]":null};u("Invalid auth state, cannot save",{state:e,errors:t.error.format()},"error");return}await _r("googleAuthState",z),z.isSignedIn&&z.accessToken?u(`Saved Google auth state to IndexedDB for ${z.userName||z.email||"user"}`):u("Cleared Google auth state in IndexedDB (signed out)")}catch(t){u("Failed to save Google auth state:",t,"error")}}function Ir(){qi&&(qi.style.display="none")}function Ke(t,e){if(se){if(se.style.fontWeight="bold",t==="authenticating"){for(rs(),se.style.color="#ffa500";se.firstChild;)se.removeChild(se.firstChild);let n=document.createElement("span");n.className="tk-auth-spinner";let i=document.createTextNode(` ${e||"Authorizing with Google\u2026"}`);se.appendChild(n),se.appendChild(i);return}if(t==="error"){se.textContent=`\u274C ${e||"Authorization failed"}`,se.style.color="#ff4d4f",ge();return}z.isSignedIn?(se.textContent="\u2705 Signed in",se.style.color="#52c41a",se.removeAttribute("title"),z.userName?(se.onmouseenter=()=>{se.textContent=`\u2705 Signed in as ${z.userName}`},se.onmouseleave=()=>{se.textContent="\u2705 Signed in"}):(se.onmouseenter=null,se.onmouseleave=null)):(se.textContent="\u274C Not signed in",se.style.color="#ff4d4f",se.removeAttribute("title"),se.onmouseenter=null,se.onmouseleave=null),ge()}}function Tl(){se&&(rs(),se.classList.remove("tk-auth-blink"),se.offsetWidth,se.classList.add("tk-auth-blink"),setTimeout(()=>{se.classList.remove("tk-auth-blink")},1200))}function _l(t){return new Promise((e,n)=>{if(!t){u&&u("OAuth monitor: popup is null",null,"error"),n(new Error("Failed to open popup"));return}u&&u("OAuth monitor: starting to monitor popup for token");let i=Date.now(),a=300*1e3,r="timekeeper_oauth",l=null,s=null,g=null,p=()=>{if(l){try{l.close()}catch{}l=null}s&&(clearInterval(s),s=null),g&&(clearInterval(g),g=null)};try{l=new BroadcastChannel(r),u&&u("OAuth monitor: BroadcastChannel created successfully"),l.onmessage=R=>{let F=R.data?.token?{...R.data,token:"[REDACTED]"}:R.data;u&&u("OAuth monitor: received BroadcastChannel message",F);let X=B.object({type:B.string(),token:B.string().optional(),error:B.string().optional()}).safeParse(R.data);if(!X.success){u&&u("OAuth monitor: invalid message format",X.error,"warn");return}if(X.data.type==="timekeeper_oauth_token"&&X.data.token){u&&u("OAuth monitor: token received via BroadcastChannel"),p();try{t.close()}catch{}e(X.data.token)}else if(X.data.type==="timekeeper_oauth_error"){u&&u("OAuth monitor: error received via BroadcastChannel",X.data.error,"error"),p();try{t.close()}catch{}n(new Error(X.data.error||"OAuth failed"))}}}catch(R){u&&u("OAuth monitor: BroadcastChannel not supported, using IndexedDB fallback",R)}u&&u("OAuth monitor: setting up IndexedDB polling");let b=Date.now();s=setInterval(async()=>{try{let R=indexedDB.open("ytls-timestamps-db",3);R.onsuccess=()=>{let F=R.result,de=F.transaction("settings","readonly").objectStore("settings").get("oauth_message");de.onsuccess=()=>{let he=de.result;if(he&&he.value){let me=he.value,ee=B.object({type:B.string(),token:B.string().optional(),error:B.string().optional(),timestamp:B.number().optional()}).safeParse(me);if(!ee.success){u&&u("OAuth monitor: invalid IndexedDB message format",ee.error,"warn");return}if(ee.data.timestamp&&ee.data.timestamp>b){let ce=ee.data.token?{...ee.data,token:"[REDACTED]"}:ee.data;if(u&&u("OAuth monitor: received IndexedDB message",ce),ee.data.type==="timekeeper_oauth_token"&&ee.data.token){u&&u("OAuth monitor: token received via IndexedDB"),p();try{t.close()}catch{}F.transaction("settings","readwrite").objectStore("settings").delete("oauth_message"),e(ee.data.token)}else if(ee.data.type==="timekeeper_oauth_error"){u&&u("OAuth monitor: error received via IndexedDB",ee.data.error,"error"),p();try{t.close()}catch{}F.transaction("settings","readwrite").objectStore("settings").delete("oauth_message"),n(new Error(ee.data.error||"OAuth failed"))}b=ee.data.timestamp||Date.now()}}F.close()}}}catch(R){u&&u("OAuth monitor: IndexedDB polling error",R,"error")}},500),g=setInterval(()=>{if(Date.now()-i>a){u&&u("OAuth monitor: popup timed out after 5 minutes",null,"error"),p();try{t.close()}catch{}n(new Error("OAuth popup timed out"));return}},1e3)})}async function as(){if(!Xa){Ke("error","Google Client ID not configured");return}try{u&&u("OAuth signin: starting OAuth flow"),Ke("authenticating","Opening authentication window...");let t=new URL("https://accounts.google.com/o/oauth2/v2/auth");t.searchParams.set("client_id",Xa),t.searchParams.set("redirect_uri",bl),t.searchParams.set("response_type","token"),t.searchParams.set("scope",xl),t.searchParams.set("include_granted_scopes","true"),t.searchParams.set("state","timekeeper_auth"),u&&u("OAuth signin: opening popup");let e=window.open(t.toString(),"TimekeeperGoogleAuth","width=500,height=600,menubar=no,toolbar=no,location=no");if(!e){u&&u("OAuth signin: popup blocked by browser",null,"error"),Ke("error","Popup blocked. Please enable popups for YouTube.");return}u&&u("OAuth signin: popup opened successfully"),Ke("authenticating","Waiting for authentication...");try{let n=await _l(e),i=await fetch("https://www.googleapis.com/oauth2/v2/userinfo",{headers:{Authorization:`Bearer ${n}`}});if(i.ok){let a=await i.json(),r=B.object({name:B.string().optional(),email:B.string().optional()}).safeParse(a);if(!r.success)throw u&&u("Failed to validate user info response",r.error,"error"),new Error("Invalid user info response");let l=r.data;z.accessToken=n,z.isSignedIn=!0,z.userName=l.name||null,z.email=l.email||null,await pi(),Ir(),Ke(),ge(),await Xn(),u?u(`Successfully authenticated as ${l.name}`):console.log(`[Timekeeper] Successfully authenticated as ${l.name}`)}else throw new Error("Failed to fetch user info")}catch(n){let i=n instanceof Error?n.message:"Authentication failed";u?u("OAuth failed:",n,"error"):console.error("[Timekeeper] OAuth failed:",n),Ke("error",i);return}}catch(t){let e=t instanceof Error?t.message:"Sign in failed";u?u("Failed to sign in to Google:",t,"error"):console.error("[Timekeeper] Failed to sign in to Google:",t),Ke("error",`Failed to sign in: ${e}`)}}async function ss(){if(!window.opener||window.opener===window)return!1;u&&u("OAuth popup: detected popup window, checking for OAuth response");let t=window.location.hash;if(!t||t.length<=1)return u&&u("OAuth popup: no hash params found"),!1;let e=t.startsWith("#")?t.substring(1):t,n=new URLSearchParams(e),i=n.get("state");if(u&&u("OAuth popup: hash params found, state="+i),i!=="timekeeper_auth")return u&&u("OAuth popup: not our OAuth flow (wrong state)"),!1;let a=n.get("error"),r=n.get("access_token"),l="timekeeper_oauth";if(a){try{let s=new BroadcastChannel(l);s.postMessage({type:"timekeeper_oauth_error",error:n.get("error_description")||a}),s.close(),u&&u("OAuth popup: error broadcast via BroadcastChannel")}catch{let g={type:"timekeeper_oauth_error",error:n.get("error_description")||a,timestamp:Date.now()};u&&u("OAuth popup: writing error to IndexedDB",g);let p=indexedDB.open("ytls-timestamps-db",3);p.onsuccess=()=>{let b=p.result,R=b.transaction("settings","readwrite").objectStore("settings").put({key:"oauth_message",value:g});R.onsuccess=()=>{u&&u("OAuth popup: error written to IndexedDB successfully")},R.onerror=()=>{u&&u("OAuth popup: failed to write error to IndexedDB",R.error,"error")},b.close()},p.onerror=()=>{u&&u("OAuth popup: failed to open IndexedDB",p.error,"error")}}return setTimeout(()=>{try{window.close()}catch{}},500),!0}if(r){u&&u("OAuth popup: access token found, broadcasting to opener");try{let s=new BroadcastChannel(l);s.postMessage({type:"timekeeper_oauth_token",token:r}),s.close(),u&&u("OAuth popup: token broadcast via BroadcastChannel")}catch(s){u&&u("OAuth popup: BroadcastChannel failed, using IndexedDB",s);let g={type:"timekeeper_oauth_token",token:r,timestamp:Date.now()},p={...g,token:"[REDACTED]"};u&&u("OAuth popup: writing token to IndexedDB",p);let b=indexedDB.open("ytls-timestamps-db",3);b.onsuccess=()=>{let M=b.result,F=M.transaction("settings","readwrite").objectStore("settings").put({key:"oauth_message",value:g});F.onsuccess=()=>{u&&u("OAuth popup: token written to IndexedDB successfully")},F.onerror=()=>{u&&u("OAuth popup: failed to write token to IndexedDB",F.error,"error")},M.close()},b.onerror=()=>{u&&u("OAuth popup: failed to open IndexedDB",b.error,"error")}}return setTimeout(()=>{try{window.close()}catch{}},500),!0}return!1}async function os(){z={isSignedIn:!1,accessToken:null,userName:null,email:null},await pi(),Ir(),Ke(),ge()}async function ls(){if(!z.isSignedIn||!z.accessToken)return!1;try{let t=await fetch("https://www.googleapis.com/oauth2/v2/userinfo",{headers:{Authorization:`Bearer ${z.accessToken}`}});return t.status===401?(await cs({silent:!0}),!1):t.ok}catch(t){return u("Failed to verify auth state:",t,"error"),!1}}async function El(t){let e={Authorization:`Bearer ${t}`},i=`https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent("name = 'Timekeeper' and mimeType = 'application/vnd.google-apps.folder' and trashed = false")}&fields=files(id,name)&pageSize=10`,a=await fetch(i,{headers:e});if(a.status===401)throw new Error("unauthorized");if(!a.ok)throw new Error("drive search failed");let r=await a.json();if(Array.isArray(r.files)&&r.files.length>0)return r.files[0].id;let l=await fetch("https://www.googleapis.com/drive/v3/files",{method:"POST",headers:{...e,"Content-Type":"application/json"},body:JSON.stringify({name:"Timekeeper",mimeType:"application/vnd.google-apps.folder"})});if(l.status===401)throw new Error("unauthorized");if(!l.ok)throw new Error("drive folder create failed");return(await l.json()).id}async function Sl(t,e,n){let i=`name='${t}' and '${e}' in parents and trashed=false`,a=encodeURIComponent(i),r=await fetch(`https://www.googleapis.com/drive/v3/files?q=${a}&fields=files(id,name)`,{method:"GET",headers:{Authorization:`Bearer ${n}`}});if(r.status===401)throw new Error("unauthorized");if(!r.ok)return null;let l=await r.json();return l.files&&l.files.length>0?l.files[0].id:null}function Il(t,e){let n=oi(t),i=e.replace(/\\/g,"/").replace(/^\/+/,"");return i.endsWith(".json")||(i+=".json"),Wa({[i]:[n,{level:6,mtime:new Date,os:0}]})}async function Cl(t,e,n,i){let a=t.replace(/\.json$/,".zip"),r=await Sl(a,n,i),l=new TextEncoder().encode(e).length,s=Il(e,t),g=s.length;u(`Compressing data: ${l} bytes -> ${g} bytes (${Math.round(100-g/l*100)}% reduction)`);let p="-------314159265358979",b=`\r
--${p}\r
`,M=`\r
--${p}--`,R=r?{name:a,mimeType:"application/zip"}:{name:a,mimeType:"application/zip",parents:[n]},F=8192,X="";for(let ce=0;ce<s.length;ce+=F){let ve=s.subarray(ce,Math.min(ce+F,s.length));X+=String.fromCharCode.apply(null,Array.from(ve))}let ae=btoa(X),de=b+`Content-Type: application/json; charset=UTF-8\r
\r
`+JSON.stringify(R)+b+`Content-Type: application/zip\r
Content-Transfer-Encoding: base64\r
\r
`+ae+M,he,me;r?(he=`https://www.googleapis.com/upload/drive/v3/files/${r}?uploadType=multipart&fields=id,name`,me="PATCH"):(he="https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,name",me="POST");let ee=await fetch(he,{method:me,headers:{Authorization:`Bearer ${i}`,"Content-Type":`multipart/related; boundary=${p}`},body:de});if(ee.status===401)throw new Error("unauthorized");if(!ee.ok)throw new Error("drive upload failed")}async function cs(t){u("Auth expired, clearing token",null,"warn"),z.isSignedIn=!1,z.accessToken=null,await pi(),Ke("error","Authorization expired. Please sign in again."),ge()}async function Ll(t){if(!z.isSignedIn||!z.accessToken){t?.silent||Ke("error","Please sign in to Google Drive first");return}try{let{json:e,filename:n,totalVideos:i,totalTimestamps:a}=await is();if(a===0){t?.silent||u("Skipping export: no timestamps to back up");return}let r=await El(z.accessToken);await Cl(n,e,r,z.accessToken),u(`Exported to Google Drive (${n}) with ${i} videos / ${a} timestamps.`)}catch(e){throw e.message==="unauthorized"?(await cs({silent:t?.silent}),e):(u("Drive export failed:",e,"error"),t?.silent||Ke("error","Failed to export to Google Drive."),e)}}async function us(){try{let t=Vi.partial().safeParse({autoBackupEnabled:await Er("autoBackupEnabled"),autoBackupIntervalMinutes:await Er("autoBackupIntervalMinutes"),lastAutoBackupAt:await Er("lastAutoBackupAt")});t.success?(typeof t.data.autoBackupEnabled=="boolean"&&(ht=t.data.autoBackupEnabled),typeof t.data.autoBackupIntervalMinutes=="number"&&(Je=t.data.autoBackupIntervalMinutes),typeof t.data.lastAutoBackupAt=="number"&&(ot=t.data.lastAutoBackupAt)):u("Failed to validate auto backup settings:",t.error.format(),"warn")}catch(t){u("Failed to load auto backup settings:",t,"error")}}async function Ki(){try{let t={autoBackupEnabled:ht,autoBackupIntervalMinutes:Je,lastAutoBackupAt:ot??0},e=Vi.safeParse(t);if(!e.success){u("Invalid auto backup settings, cannot save",{settings:t,errors:e.error.format()},"error");return}await _r("autoBackupEnabled",ht),await _r("autoBackupIntervalMinutes",Je),await _r("lastAutoBackupAt",ot??0)}catch(t){u("Failed to save auto backup settings:",t,"error")}}function Al(){di&&(clearInterval(di),di=null),st&&(clearTimeout(st),st=null)}function Jn(t){try{let e=new Date(t),n=new Date,i=e.toDateString()===n.toDateString(),a=e.toLocaleTimeString([],{hour:"numeric",minute:"2-digit"});return i?a:`${e.toLocaleDateString()} ${a}`}catch{return""}}function ds(){return ht?Kn?"#4285f4":pt&&pt>0?"#ffa500":z.isSignedIn&&ot?"#52c41a":z.isSignedIn?"#ffa500":"#ff4d4f":"#ff4d4f"}function ge(){if(!Ee)return;let t="",e="";if(!ht)t="\u{1F501} Backup: Off",Ee.onmouseenter=null,Ee.onmouseleave=null;else if(Kn)t="\u{1F501} Backing up\u2026",Ee.onmouseenter=null,Ee.onmouseleave=null;else if(pt&&pt>0)t=`\u26A0\uFE0F Retry in ${Math.ceil(pt/6e4)}m`,Ee.onmouseenter=null,Ee.onmouseleave=null;else if(ot){t=`\u{1F5C4}\uFE0F Last backup: ${Jn(ot)}`;let n=ot+Math.max(1,Je)*60*1e3;e=`\u{1F5C4}\uFE0F Next backup: ${Jn(n)}`,Ee.onmouseenter=()=>{Ee.textContent=e},Ee.onmouseleave=()=>{Ee.textContent=t}}else{t="\u{1F5C4}\uFE0F Last backup: never";let n=Date.now()+Math.max(1,Je)*60*1e3;e=`\u{1F5C4}\uFE0F Next backup: ${Jn(n)}`,Ee.onmouseenter=()=>{Ee.textContent=e},Ee.onmouseleave=()=>{Ee.textContent=t}}Ee.textContent=t,Ee.style.display=t?"inline":"none";try{let n=ds();Ee.style.color=n}catch{}hi()}function hi(){if(!ui)return;let t=ds();ui.style.backgroundColor=t,kt(ui,()=>{let e="";if(!ht)e="Auto backup is disabled";else if(Kn)e="Backup in progress";else if(pt&&pt>0)e=`Retrying backup in ${Math.ceil(pt/6e4)}m`;else if(z.isSignedIn&&ot){let n=ot+Math.max(1,Je)*60*1e3,i=Jn(n);e=`Last backup: ${Jn(ot)}
Next backup: ${i}`}else if(z.isSignedIn){let n=Date.now()+Math.max(1,Je)*60*1e3;e=`No backup yet
Next backup: ${Jn(n)}`}else e="Not signed in to Google Drive";return e})}async function Sr(t=!0){if(!z.isSignedIn||!z.accessToken){t||Tl();return}if(st){u("Auto backup: backoff in progress, skipping scheduled run");return}if(!Kn){Kn=!0,ge();try{await Ll({silent:t}),ot=Date.now(),Yn=0,pt=null,st&&(clearTimeout(st),st=null),await Ki()}catch(e){if(u("Auto backup failed:",e,"error"),e.message==="unauthorized")u("Auth error detected, clearing token and stopping retries",null,"warn"),z.isSignedIn=!1,z.accessToken=null,await pi(),Ke("error","Authorization expired. Please sign in again."),ge(),Yn=0,pt=null,st&&(clearTimeout(st),st=null);else if(Yn<Qa){Yn+=1;let a=Math.min(wl*Math.pow(2,Yn-1),kl);pt=a,st&&clearTimeout(st),st=setTimeout(()=>{Sr(!0)},a),u(`Scheduling backup retry ${Yn}/${Qa} in ${Math.round(a/1e3)}s`),ge()}else pt=null}finally{Kn=!1,ge()}}}async function Xn(t=!1){if(Al(),!!ht&&!(!z.isSignedIn||!z.accessToken)){if(di=setInterval(()=>{Sr(!0)},Math.max(1,Je)*60*1e3),!t){let e=Date.now(),n=Math.max(1,Je)*60*1e3;(!ot||e-ot>=n)&&Sr(!0)}ge()}}async function fs(){ht=!ht,await Ki(),await Xn(),ge()}async function ms(){let t=prompt("Set Auto Backup interval (minutes):",String(Je));if(t===null)return;let e=Math.floor(Number(t));if(!Number.isFinite(e)||e<5||e>1440){alert("Please enter a number between 5 and 1440 minutes.");return}Je=e,await Ki(),await Xn(),ge()}var Ji=window.location.hash;if(Ji&&Ji.length>1){let t=new URLSearchParams(Ji.substring(1));if(t.get("state")==="timekeeper_auth"){let n=t.get("access_token");if(n){console.log("[Timekeeper] Auth token detected in URL, broadcasting token"),console.log("[Timekeeper] Token length:",n.length,"characters");try{let i=new BroadcastChannel("timekeeper_oauth"),a={type:"timekeeper_oauth_token",token:n};console.log("[Timekeeper] Sending auth message via BroadcastChannel:",{type:a.type,tokenLength:n.length}),i.postMessage(a),i.close(),console.log("[Timekeeper] Token broadcast via BroadcastChannel completed")}catch(i){console.log("[Timekeeper] BroadcastChannel failed, using IndexedDB fallback:",i);let a={type:"timekeeper_oauth_token",token:n,timestamp:Date.now()},r=indexedDB.open("ytls-timestamps-db",3);r.onsuccess=()=>{let l=r.result,s=l.transaction("settings","readwrite");s.objectStore("settings").put({key:"oauth_message",value:a}),s.oncomplete=()=>{console.log("[Timekeeper] Token broadcast via IndexedDB completed, timestamp:",a.timestamp),l.close()}}}if(history.replaceState){let i=window.location.pathname+window.location.search;history.replaceState(null,"",i)}throw console.log("[Timekeeper] Closing window after broadcasting auth token"),window.close(),new Error("OAuth window closed")}}}(async function(){"use strict";if(window.top!==window.self)return;function t(o){return GM.getValue(`timekeeper_${o}`,void 0)}function e(o,c){return GM.setValue(`timekeeper_${o}`,JSON.stringify(c))}if(mi(t),fi(e),await ss()){u("OAuth popup detected, broadcasting token and closing");return}await Yi();let i=["/watch","/live"];function a(o=window.location.href){try{let c=new URL(o);return c.origin!=="https://www.youtube.com"?!1:i.some(d=>c.pathname===d||c.pathname.startsWith(`${d}/`))}catch(c){return u("Timekeeper failed to parse URL for support check:",c,"error"),!1}}let r=null,l=null,s=null,g=null,p=null,b=null,M=null,R=null,F=250,X=null,ae=!1;function de(){return r?r.getBoundingClientRect():null}function he(o,c,d){o&&(qe={x:Math.round(typeof c=="number"?c:o.left),y:Math.round(typeof d=="number"?d:o.top),width:Math.round(o.width),height:Math.round(o.height)})}function me(o=!0){if(!r)return;Cn();let c=de();c&&(c.width||c.height)&&(he(c),o&&(Wr("windowPosition",qe),tr({type:"window_position_updated",position:qe,timestamp:Date.now()})))}function ee(){if(!r||!l||!g||!s)return;let o=40,c=pe();if(c.length>0)o=c[0].offsetHeight;else{let d=document.createElement("li");d.style.visibility="hidden",d.style.position="absolute",d.textContent="00:00 Example",s.appendChild(d),o=d.offsetHeight,s.removeChild(d)}F=l.offsetHeight+g.offsetHeight+o,r.style.minHeight=F+"px"}function ce(){requestAnimationFrame(()=>{typeof window.recalculateTimestampsArea=="function"&&window.recalculateTimestampsArea(),ee(),me(!0)})}function ve(o=450){_e&&(clearTimeout(_e),_e=null),_e=setTimeout(()=>{Z(),ce(),_e=null},o)}function Ae(){_e&&(clearTimeout(_e),_e=null)}function ye(){s&&(s.style.visibility="hidden",u("Hiding timestamps during show animation")),ce(),ve()}function te(){Z(),Ae(),gt&&(clearTimeout(gt),gt=null),gt=setTimeout(()=>{r&&(r.style.display="none",fa(),gt=null)},400)}function Z(){if(!s){tt&&(tt(),tt=null,It=null,$t=null);return}if(!$t){s.style.visibility==="hidden"&&(s.style.visibility="",u("Restoring timestamp visibility (no deferred fragment)")),tt&&(tt(),tt=null,It=null);return}u("Appending deferred timestamps after animation"),s.appendChild($t),$t=null,s.style.visibility==="hidden"&&(s.style.visibility="",u("Restoring timestamp visibility after append")),tt&&(tt(),tt=null,It=null),xt(),$e(),typeof window.recalculateTimestampsArea=="function"&&requestAnimationFrame(()=>window.recalculateTimestampsArea());let o=ne(),c=o?Math.floor(o.getCurrentTime()):Xt();Number.isFinite(c)&&tn(c,!1)}let xe=null,ke=!1,be="ytls-timestamp-pending-delete",Xe="ytls-timestamp-highlight",Pe="https://raw.githubusercontent.com/KamoTimestamps/timekeeper/refs/heads/main/assets/Kamo_64px_Indexed.png",He="https://raw.githubusercontent.com/KamoTimestamps/timekeeper/refs/heads/main/assets/Kamo_Eyebrow_64px_Indexed.png";function lt(){let o=c=>{let d=new Image;d.src=c};o(Pe),o(He)}lt();async function Te(){for(;!document.querySelector("video")||!document.querySelector("#movie_player");)await new Promise(o=>setTimeout(o,100));for(;!document.querySelector(".ytp-progress-bar");)await new Promise(o=>setTimeout(o,100));await new Promise(o=>setTimeout(o,200))}let Ue=["getCurrentTime","seekTo","getPlayerState","seekToLiveHead","getVideoData","getDuration"],Tt=5e3,Qn=new Set(["getCurrentTime","seekTo","getPlayerState","seekToLiveHead","getVideoData","getDuration"]);function Qe(o){return Qn.has(o)}function et(){return document.querySelector("video")}let Ge=null;function ne(){if(Ge&&document.contains(Ge))return Ge;let o=document.getElementById("movie_player");return o&&document.contains(o)?o:null}function we(o){return Ue.every(c=>typeof o?.[c]=="function"?!0:Qe(c)?!!et():!1)}function Nt(o){return Ue.filter(c=>typeof o?.[c]=="function"?!1:Qe(c)?!et():!0)}async function Cr(o=Tt){let c=Date.now();for(;Date.now()-c<o;){let m=ne();if(we(m))return m;await new Promise(x=>setTimeout(x,100))}let d=ne();return we(d),d}let _n="timestampOffsetSeconds",gi=-5,er="shiftClickTimeSkipSeconds",Lr=10,En=300,Yt=300,Ve=null;function Xi(){try{return new URL(window.location.href).origin==="https://www.youtube.com"}catch{return!1}}function Qi(){if(Xi()&&!Ve)try{Ve=new BroadcastChannel("ytls_timestamp_channel"),Ve.onmessage=ea}catch(o){u("Failed to create BroadcastChannel:",o,"warn"),Ve=null}}function tr(o){if(!Xi()){u("Skipping BroadcastChannel message: not on https://www.youtube.com","warn");return}if(Qi(),!Ve){u("No BroadcastChannel available to post message","warn");return}try{Ve.postMessage(o)}catch(c){u("BroadcastChannel error, reopening:",c,"warn");try{Ve=new BroadcastChannel("ytls_timestamp_channel"),Ve.onmessage=ea,Ve.postMessage(o)}catch(d){u("Failed to reopen BroadcastChannel:",d,"error")}}}function ea(o){if(u("Received message from another tab:",o.data),!(!a()||!s||!r)&&o.data){if(o.data.type==="timestamps_updated"&&o.data.videoId===Se)u("Debouncing timestamp load due to external update for video:",o.data.videoId),clearTimeout(rr),rr=setTimeout(()=>{u("Reloading timestamps due to external update for video:",o.data.videoId),la()},500);else if(o.data.type==="window_position_updated"&&r){let c=o.data.position;if(c&&typeof c.x=="number"&&typeof c.y=="number"){r.style.left=`${c.x}px`,r.style.top=`${c.y}px`,r.style.right="auto",r.style.bottom="auto",typeof c.width=="number"&&c.width>0&&(r.style.width=`${c.width}px`),typeof c.height=="number"&&c.height>0&&(r.style.height=`${c.height}px`);let d=r.getBoundingClientRect();qe={x:Math.round(c.x),y:Math.round(c.y),width:Math.round(d.width),height:Math.round(d.height)};let m=document.documentElement.clientWidth,x=document.documentElement.clientHeight;(d.left<0||d.top<0||d.right>m||d.bottom>x)&&Cn()}}}}Qi();let Sn=await GM.getValue(_n);(typeof Sn!="number"||Number.isNaN(Sn))&&(Sn=gi,await GM.setValue(_n,Sn));let nr=await GM.getValue(er);(typeof nr!="number"||Number.isNaN(nr))&&(nr=Lr,await GM.setValue(er,nr));let rr=null,Kt=new Map,Ar=!1,U=null,Mr=null,Se=null,gt=null,_e=null,$t=null,It=null,tt=null,Ft=null,Dr=!1,qe=null,yi=!1,Br=null,Rr=null,Or=null,Pr=null,zr=null,Nr=null,$r=null,ir=null,ar=null,sr=null,yt=null,vt=null,ta=0,or=!1,Jt=null,lr=null;function pe(){return s?Array.from(s.querySelectorAll("li")).filter(o=>!!o.querySelector("a[data-time]")):[]}function vi(){return pe().map(o=>{let c=o.querySelector("a[data-time]"),d=c?.dataset.time;if(!c||!d)return null;let m=Number.parseInt(d,10);if(!Number.isFinite(m))return null;let w=o.querySelector("input")?.value??"",f=o.dataset.guid??crypto.randomUUID();o.dataset.guid||(o.dataset.guid=f);let h=Wn.safeParse({start:m,comment:w,guid:f});return h.success?h.data:(u(`Skipping invalid timestamp in UI: ${h.error.message}`,"warn"),null)}).filter(o=>o!==null)}function Xt(){if(lr!==null)return lr;let o=pe();return lr=o.length>0?Math.max(...o.map(c=>{let d=c.querySelector("a[data-time]")?.getAttribute("data-time");return d?Number.parseInt(d,10):0})):0,lr}function Fr(){lr=null}function ps(o){let c=o.querySelector(".time-diff");return c?(c.textContent?.trim()||"").startsWith("-"):!1}function hs(o,c){return o?c?"\u2514\u2500 ":"\u251C\u2500 ":""}function cr(o){return o.startsWith("\u251C\u2500 ")||o.startsWith("\u2514\u2500 ")?1:0}function na(o){return o.replace(/^[]\s/,"")}function gs(o){let c=pe();if(o>=c.length-1)return"\u2514\u2500 ";let d=c[o+1].querySelector("input");return d&&cr(d.value)===1?"\u251C\u2500 ":"\u2514\u2500 "}function xt(){if(!s)return;let o=pe(),c=!0,d=0,m=o.length;for(;c&&d<m;)c=!1,d++,o.forEach((x,w)=>{let f=x.querySelector("input");if(!f||!(cr(f.value)===1))return;let S=!1;if(w<o.length-1){let N=o[w+1].querySelector("input");N&&(S=!(cr(N.value)===1))}else S=!0;let A=na(f.value),L=`${hs(!0,S)}${A}`;f.value!==L&&(f.value=L,c=!0)})}function Qt(){if(s){for(;s.firstChild;)s.removeChild(s.firstChild);$t&&($t=null),tt&&(tt(),tt=null,It=null)}}function ur(){if(!s||ke||$t)return;Array.from(s.children).some(c=>!c.classList.contains("ytls-placeholder")&&!c.classList.contains("ytls-error-message"))||xi("No timestamps for this video")}function xi(o){if(!s)return;Qt();let c=document.createElement("li");c.className="ytls-placeholder",c.textContent=o,s.appendChild(c),s.style.overflowY="hidden"}function bi(){if(!s)return;let o=s.querySelector(".ytls-placeholder");o&&o.remove(),s.style.overflowY=""}function wi(o){if(!(!r||!s)){if(ke=o,o)r.style.display="",r.classList.remove("ytls-fade-out"),r.classList.add("ytls-fade-in"),xi("Loading timestamps...");else if(bi(),r.style.display="",r.classList.remove("ytls-fade-out"),r.classList.add("ytls-fade-in"),p){let c=ne();if(c){let d=c.getCurrentTime(),m=Number.isFinite(d)?Math.max(0,Math.floor(d)):Math.max(0,Xt()),x=Math.floor(m/3600),w=Math.floor(m/60)%60,f=m%60,{isLive:h}=c.getVideoData()||{isLive:!1},S=s?pe().map(E=>{let L=E.querySelector("a[data-time]");return L?parseFloat(L.getAttribute("data-time")??"0"):0}):[],A="";if(S.length>0)if(h){let E=Math.max(1,m/60),L=S.filter(N=>N<=m);if(L.length>0){let N=(L.length/E).toFixed(2);parseFloat(N)>0&&(A=` (${N}/min)`)}}else{let E=c.getDuration(),L=Number.isFinite(E)&&E>0?E:0,N=Math.max(1,L/60),W=(S.length/N).toFixed(1);parseFloat(W)>0&&(A=` (${W}/min)`)}p.textContent=`\u23F3${x?x+":"+String(w).padStart(2,"0"):w}:${String(f).padStart(2,"0")}${A}`}}!ke&&s&&!s.querySelector(".ytls-error-message")&&ur(),Ct()}}function ys(o){return o?Wn.safeParse(o).success:!1}function jr(o,c){o.textContent=Zt(c),o.dataset.time=String(c),o.href=Di(c,window.location.href)}let Hr=null,Ur=null,en=!1;function vs(o){if(!o||typeof o.getVideoData!="function"||!o.getVideoData()?.isLive)return!1;if(typeof o.getProgressState=="function"){let d=o.getProgressState(),m=Number(d?.seekableEnd??d?.liveHead??d?.head??d?.duration),x=Number(d?.current??o.getCurrentTime?.());if(Number.isFinite(m)&&Number.isFinite(x))return m-x>2}return!1}function tn(o,c){if(!Number.isFinite(o))return;let d=Gr(o);dr(d,c)}function Gr(o){if(!Number.isFinite(o))return null;let c=pe();if(c.length===0)return null;let d=null,m=-1/0;for(let x of c){let f=x.querySelector("a[data-time]")?.dataset.time;if(!f)continue;let h=Number.parseInt(f,10);Number.isFinite(h)&&h<=o&&h>m&&(m=h,d=x)}return d}function dr(o,c=!1){if(!o)return;if(pe().forEach(m=>{m.classList.contains(be)||m.classList.remove(Xe)}),!o.classList.contains(be)&&(o.classList.add(Xe),c&&!Ar))try{if(s instanceof HTMLElement){let m=o.getBoundingClientRect(),x=s.getBoundingClientRect();!(m.bottom<x.top||m.top>x.bottom)||o.scrollIntoView({behavior:"smooth",block:"center"})}else o.scrollIntoView({behavior:"smooth",block:"center"})}catch{try{o.scrollIntoView({behavior:"smooth",block:"center"})}catch{}}}function xs(o){if(!s||s.querySelector(".ytls-error-message")||!Number.isFinite(o)||o===0)return!1;let c=pe();if(c.length===0)return!1;let d=!1;return c.forEach(m=>{let x=m.querySelector("a[data-time]"),w=x?.dataset.time;if(!x||!w)return;let f=Number.parseInt(w,10);if(!Number.isFinite(f))return;let h=Math.max(0,f+o);h!==f&&(jr(x,h),d=!0)}),d?(mr(),xt(),$e(),qr(Se),Jt=null,!0):!1}function ra(o,c={}){if(!Number.isFinite(o)||o===0)return!1;if(!xs(o)){if(c.alertOnNoChange){let f=c.failureMessage??"Offset did not change any timestamps.";alert(f)}return!1}let m=c.logLabel??"bulk offset";u(`Timestamps changed: Offset all timestamps by ${o>0?"+":""}${o} seconds (${m})`);let x=ne(),w=x?Math.floor(x.getCurrentTime()):0;if(Number.isFinite(w)){let f=Gr(w);dr(f,!1)}return!0}function ia(o){if(!s||ke)return;let c=o.target instanceof HTMLElement?o.target:null;if(c)if(c.dataset.time){o.preventDefault();let d=Number(c.dataset.time);if(Number.isFinite(d)){en=!0;let x=ne();x&&x.seekTo(d),setTimeout(()=>{en=!1},500)}let m=c.closest("li");m&&(pe().forEach(x=>{x.classList.contains(be)||x.classList.remove(Xe)}),m.classList.contains(be)||(m.classList.add(Xe),m.scrollIntoView({behavior:"smooth",block:"center"})))}else if(c.dataset.increment){o.preventDefault();let m=c.parentElement?.querySelector("a[data-time]");if(!m||!m.dataset.time)return;let x=parseInt(m.dataset.time,10),w=parseInt(c.dataset.increment,10);if("shiftKey"in o&&o.shiftKey&&(w*=nr),"altKey"in o?o.altKey:!1){ra(w,{logLabel:"Alt adjust"});return}let S=Math.max(0,x+w);u(`Timestamps changed: Timestamp time incremented from ${x} to ${S}`),jr(m,S),Fr();let A=c.closest("li");if(Ur=S,Hr&&clearTimeout(Hr),en=!0,Hr=setTimeout(()=>{if(Ur!==null){let E=ne();E&&E.seekTo(Ur)}Hr=null,Ur=null,setTimeout(()=>{en=!1},500)},500),mr(),xt(),$e(),A){let E=A.querySelector("input"),L=A.dataset.guid;E&&L&&(In(Se,L,S,E.value),Jt=L)}}else c.dataset.action==="clear"&&(o.preventDefault(),u("Timestamps changed: All timestamps cleared from UI"),s.textContent="",Fr(),$e(),Vr(),qr(Se,{allowEmpty:!0}),Jt=null,ur())}function fr(o,c="",d=!1,m=null,x=!0){if(!s)return null;let w=Math.max(0,o),f=m??crypto.randomUUID(),h=document.createElement("li"),S=document.createElement("div"),A=document.createElement("span"),E=document.createElement("span"),L=document.createElement("span"),N=document.createElement("a"),W=document.createElement("span"),Y=document.createElement("input"),Q=document.createElement("button");h.dataset.guid=f,S.className="time-row";let Ze=document.createElement("div");Ze.style.cssText="position:absolute;left:0;top:0;width:20px;height:100%;display:flex;align-items:center;justify-content:center;cursor:pointer;",kt(Ze,"Click to toggle indent");let Me=document.createElement("span");Me.style.cssText="color:#999;font-size:12px;pointer-events:none;display:none;";let rt=()=>{let fe=cr(Y.value);Me.textContent=fe===1?"\u25C0":"\u25B6"},jt=fe=>{fe.stopPropagation();let re=cr(Y.value),Ie=na(Y.value),De=re===0?1:0,ue="";if(De===1){let ct=pe().indexOf(h);ue=gs(ct)}Y.value=`${ue}${Ie}`,rt(),xt();let Ce=Number.parseInt(N.dataset.time??"0",10);In(Se,f,Ce,Y.value)};Ze.onclick=jt,Ze.append(Me),h.style.cssText="position:relative;padding-left:20px;",h.addEventListener("mouseenter",()=>{rt(),Me.style.display="inline"}),h.addEventListener("mouseleave",()=>{Me.style.display="none"}),h.addEventListener("mouseleave",()=>{h.dataset.guid===Jt&&ps(h)&&aa()}),Y.value=c||"",Y.style.cssText="width:100%;margin-top:5px;display:block;",Y.type="text",Y.setAttribute("inputmode","text"),Y.autocapitalize="off",Y.autocomplete="off",Y.spellcheck=!1,Y.addEventListener("focusin",()=>{or=!1}),Y.addEventListener("focusout",fe=>{let re=fe.relatedTarget,Ie=Date.now()-ta<250,De=!!re&&!!r&&r.contains(re);!Ie&&!De&&(or=!0,setTimeout(()=>{(document.activeElement===document.body||document.activeElement==null)&&(Y.focus({preventScroll:!0}),or=!1)},0))}),Y.addEventListener("input",fe=>{let re=fe;if(re&&(re.isComposing||re.inputType==="insertCompositionText"))return;let Ie=Kt.get(f);Ie&&clearTimeout(Ie);let De=setTimeout(()=>{let ue=Number.parseInt(N.dataset.time??"0",10);In(Se,f,ue,Y.value),Kt.delete(f)},500);Kt.set(f,De)}),Y.addEventListener("compositionend",()=>{let fe=Number.parseInt(N.dataset.time??"0",10);setTimeout(()=>{In(Se,f,fe,Y.value)},50)}),A.textContent="\u2796",A.dataset.increment="-1",A.style.cursor="pointer",A.style.margin="0px",A.addEventListener("mouseenter",()=>{A.style.textShadow="0 0 8px rgba(255, 255, 255, 0.8), 0 0 12px rgba(100, 200, 255, 0.6)"}),A.addEventListener("mouseleave",()=>{A.style.textShadow="none"}),L.textContent="\u2795",L.dataset.increment="1",L.style.cursor="pointer",L.style.margin="0px",L.addEventListener("mouseenter",()=>{L.style.textShadow="0 0 8px rgba(255, 255, 255, 0.8), 0 0 12px rgba(100, 200, 255, 0.6)"}),L.addEventListener("mouseleave",()=>{L.style.textShadow="none"}),E.textContent="\u23FA\uFE0F",E.style.cursor="pointer",E.style.margin="0px",kt(E,"Set to current playback time"),E.addEventListener("mouseenter",()=>{E.style.textShadow="0 0 8px rgba(255, 255, 255, 0.8), 0 0 12px rgba(100, 200, 255, 0.6)"}),E.addEventListener("mouseleave",()=>{E.style.textShadow="none"}),E.onclick=()=>{let fe=ne(),re=fe?Math.floor(fe.getCurrentTime()):0;Number.isFinite(re)&&(u(`Timestamps changedset to current playback time ${re}`),jr(N,re),mr(),xt(),In(Se,f,re,Y.value),Jt=f)},jr(N,w),Fr(),Q.textContent="\u{1F5D1}\uFE0F",Q.style.cssText="background:transparent;border:none;color:white;cursor:pointer;margin-left:5px;",Q.addEventListener("mouseenter",()=>{Q.style.textShadow="0 0 8px rgba(255, 255, 255, 0.8), 0 0 12px rgba(255, 100, 100, 0.6)"}),Q.addEventListener("mouseleave",()=>{Q.style.textShadow="none"}),Q.onclick=()=>{let fe=null,re=null,Ie=null,De=()=>{try{h.removeEventListener("click",re,!0)}catch{}try{document.removeEventListener("click",re,!0)}catch{}if(s)try{s.removeEventListener("mouseleave",Ie)}catch{}fe&&(clearTimeout(fe),fe=null)};if(h.dataset.deleteConfirmed==="true"){u("Timestamps changed: Timestamp deleted");let ue=h.dataset.guid??"",Ce=Kt.get(ue);Ce&&(clearTimeout(Ce),Kt.delete(ue)),De(),h.remove(),Fr(),mr(),xt(),$e(),Vr(),bs(Se,ue),Jt=null,ur()}else{h.dataset.deleteConfirmed="true",h.classList.add(be),h.classList.remove(Xe);let ue=()=>{h.dataset.deleteConfirmed="false",h.classList.remove(be);let Ce=ne(),bt=Ce?Ce.getCurrentTime():0,ct=Number.parseInt(h.querySelector("a[data-time]")?.dataset.time??"0",10);Number.isFinite(bt)&&Number.isFinite(ct)&&bt>=ct&&h.classList.add(Xe),De()};re=Ce=>{Ce.target!==Q&&ue()},Ie=()=>{h.dataset.deleteConfirmed==="true"&&ue()},h.addEventListener("click",re,!0),document.addEventListener("click",re,!0),s&&s.addEventListener("mouseleave",Ie),fe=setTimeout(()=>{h.dataset.deleteConfirmed==="true"&&ue(),De()},5e3)}},W.className="time-diff",W.style.color="#888",W.style.marginLeft="5px",S.append(A,E,L,N,W,Q),h.append(Ze,S,Y);let Lt=Number.parseInt(N.dataset.time??"0",10);if(x){bi();let fe=!1,re=pe();for(let Ie=0;Ie<re.length;Ie++){let De=re[Ie],Ce=De.querySelector("a[data-time]")?.dataset.time;if(!Ce)continue;let bt=Number.parseInt(Ce,10);if(Number.isFinite(bt)&&Lt<bt){s.insertBefore(h,De),fe=!0;let ct=re[Ie-1];if(ct){let Rn=ct.querySelector("a[data-time]")?.dataset.time;if(Rn){let On=Number.parseInt(Rn,10);Number.isFinite(On)&&(W.textContent=Zt(Lt-On))}}else W.textContent="";let Bn=De.querySelector(".time-diff");Bn&&(Bn.textContent=Zt(bt-Lt));break}}if(!fe&&(s.appendChild(h),re.length>0)){let ue=re[re.length-1].querySelector("a[data-time]")?.dataset.time;if(ue){let Ce=Number.parseInt(ue,10);Number.isFinite(Ce)&&(W.textContent=Zt(Lt-Ce))}}h.scrollIntoView({behavior:"smooth",block:"center"}),Vr(),xt(),$e(),d||(In(Se,f,w,c),Jt=f,dr(h,!1))}else Y.__ytls_li=h;return Y}function mr(){if(!s||s.querySelector(".ytls-error-message"))return;let o=pe();o.forEach((c,d)=>{let m=c.querySelector(".time-diff");if(!m)return;let w=c.querySelector("a[data-time]")?.dataset.time;if(!w){m.textContent="";return}let f=Number.parseInt(w,10);if(!Number.isFinite(f)){m.textContent="";return}if(d===0){m.textContent="";return}let A=o[d-1].querySelector("a[data-time]")?.dataset.time;if(!A){m.textContent="";return}let E=Number.parseInt(A,10);if(!Number.isFinite(E)){m.textContent="";return}let L=f-E,N=L<0?"-":"";m.textContent=` ${N}${Zt(Math.abs(L))}`})}function aa(){if(!s||s.querySelector(".ytls-error-message")||ke)return;let o=null;if(document.activeElement instanceof HTMLInputElement&&s.contains(document.activeElement)){let f=document.activeElement,S=f.closest("li")?.dataset.guid;if(S){let A=f.selectionStart??f.value.length,E=f.selectionEnd??A,L=f.scrollLeft;o={guid:S,start:A,end:E,scroll:L}}}let c=pe();if(c.length===0)return;let d=c.map(f=>f.dataset.guid),m=c.map(f=>{let h=f.querySelector("a[data-time]"),S=h?.dataset.time;if(!h||!S)return null;let A=Number.parseInt(S,10);if(!Number.isFinite(A))return null;let E=f.dataset.guid??"";return{time:A,guid:E,element:f}}).filter(f=>f!==null).sort((f,h)=>{let S=f.time-h.time;return S!==0?S:f.guid.localeCompare(h.guid)}),x=m.map(f=>f.guid),w=d.length!==x.length||d.some((f,h)=>f!==x[h]);for(;s.firstChild;)s.removeChild(s.firstChild);if(m.forEach(f=>{s.appendChild(f.element)}),mr(),xt(),$e(),o){let h=pe().find(S=>S.dataset.guid===o.guid)?.querySelector("input");if(h)try{h.focus({preventScroll:!0})}catch{}}w&&(u("Timestamps changed: Timestamps sorted"),qr(Se))}function Vr(){if(!s||!r||!l||!g)return;let o=pe().length;typeof window.recalculateTimestampsArea=="function"&&window.recalculateTimestampsArea();let c=r.getBoundingClientRect(),d=l.getBoundingClientRect(),m=g.getBoundingClientRect(),x=Math.max(0,c.height-(d.height+m.height));o===0?(ur(),s.style.overflowY="hidden"):s.style.overflowY=s.scrollHeight>x?"auto":"hidden"}function $e(){if(!s)return;let o=et(),c=document.querySelector(".ytp-progress-bar"),d=ne(),m=d?d.getVideoData():null,x=!!m&&!!m.isLive;if(!o||!c||!isFinite(o.duration)||x)return;oa(),pe().map(f=>{let h=f.querySelector("a[data-time]"),S=h?.dataset.time;if(!h||!S)return null;let A=Number.parseInt(S,10);if(!Number.isFinite(A))return null;let L=f.querySelector("input")?.value??"",N=f.dataset.guid??crypto.randomUUID();return f.dataset.guid||(f.dataset.guid=N),{start:A,comment:L,guid:N}}).filter(ys).forEach(f=>{if(!Number.isFinite(f.start))return;let h=document.createElement("div");h.className="ytls-marker",h.style.position="absolute",h.style.height="100%",h.style.width="2px",h.style.backgroundColor="#ff0000",h.style.cursor="pointer",h.style.left=f.start/o.duration*100+"%",h.dataset.time=String(f.start),h.addEventListener("click",()=>{let S=ne();S&&S.seekTo(f.start)}),c.appendChild(h)})}function qr(o,c={}){if(!s||s.querySelector(".ytls-error-message")||!o)return;if(ke){u("Save blocked: timestamps are currently loading");return}xt();let d=vi().sort((m,x)=>m.start-x.start);if(d.length===0&&!c.allowEmpty){u("Save skipped: no timestamps to save");return}ua(o,d).then(()=>u(`Successfully saved ${d.length} timestamps for ${o} to IndexedDB`)).catch(m=>u(`Failed to save timestamps for ${o} to IndexedDB:`,m,"error")),tr({type:"timestamps_updated",videoId:o,action:"saved"})}function In(o,c,d,m){if(!o||ke)return;let x={guid:c,start:d,comment:m};u(`Saving timestamp: guid=${c}, start=${d}, comment="${m}"`),Ms(o,x).catch(w=>u(`Failed to save timestamp ${c}:`,w,"error")),tr({type:"timestamps_updated",videoId:o,action:"saved"})}function bs(o,c){!o||ke||(u(`Deleting timestamp: guid=${c}`),Ds(o,c).catch(d=>u(`Failed to delete timestamp ${c}:`,d,"error")),tr({type:"timestamps_updated",videoId:o,action:"saved"}))}async function sa(o){if(!s||s.querySelector(".ytls-error-message")){alert("Cannot export timestamps while displaying an error message.");return}let c=Se;if(!c)return;u(`Exporting timestamps for video ID: ${c}`);let d=vi(),m=Math.max(Xt(),0),x=vr();if(o==="json"){let w=new Blob([JSON.stringify(d,null,2)],{type:"application/json"}),f=URL.createObjectURL(w),h=document.createElement("a");h.href=f,h.download=`timestamps-${c}-${x}.json`,h.click(),URL.revokeObjectURL(f)}else if(o==="text"){let w=d.map(A=>{let E=Zt(A.start,m),L=`${A.comment} <!-- guid:${A.guid} -->`.trimStart();return`${E} ${L}`}).join(`
`),f=new Blob([w],{type:"text/plain"}),h=URL.createObjectURL(f),S=document.createElement("a");S.href=h,S.download=`timestamps-${c}-${x}.txt`,S.click(),URL.revokeObjectURL(h)}}function ki(o){if(!r||!s){u("Timekeeper error:",o,"error");return}Qt();let c=document.createElement("li");c.textContent=o,c.classList.add("ytls-error-message"),c.style.color="#ff6b6b",c.style.fontWeight="bold",c.style.padding="8px",c.style.background="rgba(255, 0, 0, 0.1)",s.appendChild(c),$e()}function oa(){document.querySelectorAll(".ytls-marker").forEach(o=>o.remove())}function Cn(){if(!r||!document.body.contains(r))return;let o=r.getBoundingClientRect(),c=document.documentElement.clientWidth,d=document.documentElement.clientHeight,m=o.width,x=o.height;if(o.left<0&&(r.style.left="0",r.style.right="auto"),o.right>c){let w=Math.max(0,c-m);r.style.left=`${w}px`,r.style.right="auto"}if(o.top<0&&(r.style.top="0",r.style.bottom="auto"),o.bottom>d){let w=Math.max(0,d-x);r.style.top=`${w}px`,r.style.bottom="auto"}}function ws(){if(Br&&(document.removeEventListener("mousemove",Br),Br=null),Rr&&(document.removeEventListener("mouseup",Rr),Rr=null),ir&&(document.removeEventListener("keydown",ir),ir=null),Or&&(window.removeEventListener("resize",Or),Or=null),ar&&(document.removeEventListener("pointerdown",ar,!0),ar=null),sr&&(document.removeEventListener("pointerup",sr,!0),sr=null),yt){try{yt.disconnect()}catch{}yt=null}if(vt){try{vt.disconnect()}catch{}vt=null}let o=et();o&&(Pr&&(o.removeEventListener("timeupdate",Pr),Pr=null),zr&&(o.removeEventListener("pause",zr),zr=null),Nr&&(o.removeEventListener("play",Nr),Nr=null),$r&&(o.removeEventListener("seeking",$r),$r=null))}function ks(){oa(),Kt.forEach(c=>clearTimeout(c)),Kt.clear(),rr&&(clearTimeout(rr),rr=null),xe&&(clearInterval(xe),xe=null),gt&&(clearTimeout(gt),gt=null),ws();try{Ve.close()}catch{}if(U&&U.parentNode===document.body&&document.body.removeChild(U),U=null,Mr=null,Ar=!1,Se=null,yt){try{yt.disconnect()}catch{}yt=null}if(vt){try{vt.disconnect()}catch{}vt=null}r&&r.parentNode&&r.remove();let o=document.getElementById("ytls-header-button");o&&o.parentNode&&o.remove(),Ft=null,Dr=!1,qe=null,Qt(),r=null,l=null,s=null,g=null,p=null,b=null,M=null,Ge=null}async function Ts(){let o=Ti();if(!o)return Ge=null,{ok:!1,message:"Timekeeper cannot determine the current video ID. Please refresh the page or open a standard YouTube watch URL."};let c=await Cr();if(!we(c)){let d=Nt(c),m=d.length?` Missing methods: ${d.join(", ")}.`:"",x=c?"Timekeeper cannot access the YouTube player API.":"Timekeeper cannot find the YouTube player on this page.";return Ge=null,{ok:!1,message:`${x}${m} Try refreshing once playback is ready.`}}return Ge=c,{ok:!0,player:c,videoId:o}}async function la(){if(!r||!s)return;let o=s.scrollTop,c=!0,d=()=>{if(!s||!c)return;let m=Math.max(0,s.scrollHeight-s.clientHeight);s.scrollTop=Math.min(o,m)};try{let m=await Ts();if(!m.ok){ki(m.message),Qt(),$e();return}let{videoId:x}=m,w=[];try{let f=await Bs(x);f?(w=f.map(h=>({...h,guid:h.guid||crypto.randomUUID()})),u(`Loaded ${w.length} timestamps from IndexedDB for ${x}`)):u(`No timestamps found in IndexedDB for ${x}`)}catch(f){u(`Failed to load timestamps from IndexedDB for ${x}:`,f,"error"),ki("Failed to load timestamps from IndexedDB. Try refreshing the page."),$e();return}if(w.length>0){w.sort((E,L)=>E.start-L.start),Qt(),bi();let f=document.createDocumentFragment();w.forEach(E=>{let N=fr(E.start,E.comment,!0,E.guid,!1).__ytls_li;N&&f.appendChild(N)}),r&&r.classList.contains("ytls-zoom-in")&&_e!=null?(u("Deferring timestamp DOM append until show animation completes"),$t=f,It||(It=new Promise(E=>{tt=E})),await It):s&&(s.appendChild(f),xt(),$e(),typeof window.recalculateTimestampsArea=="function"&&requestAnimationFrame(()=>window.recalculateTimestampsArea()));let S=ne(),A=S?Math.floor(S.getCurrentTime()):Xt();Number.isFinite(A)&&(tn(A,!1),c=!1)}else Qt(),xi("No timestamps for this video"),$e(),typeof window.recalculateTimestampsArea=="function"&&requestAnimationFrame(()=>window.recalculateTimestampsArea())}catch(m){u("Unexpected error while loading timestamps:",m,"error"),ki("Timekeeper encountered an unexpected error while loading timestamps. Check the console for details.")}finally{It&&await It,requestAnimationFrame(d),typeof window.recalculateTimestampsArea=="function"&&requestAnimationFrame(()=>window.recalculateTimestampsArea()),s&&!s.querySelector(".ytls-error-message")&&ur()}}function Ti(){let c=new URLSearchParams(location.search).get("v");if(c)return c;let d=document.querySelector('meta[itemprop="identifier"]');return d?.content?d.content:null}function _s(){let o=et();if(!o)return;let c=()=>{if(!s)return;let f=ne(),h=f?Math.floor(f.getCurrentTime()):0;if(!Number.isFinite(h))return;let S=Gr(h);dr(S,!1)},d=f=>{try{let h=new URL(window.location.href);f!==null&&Number.isFinite(f)?h.searchParams.set("t",`${Math.floor(f)}s`):h.searchParams.delete("t"),window.history.replaceState({},"",h.toString())}catch{}},m=()=>{let f=ne(),h=f?Math.floor(f.getCurrentTime()):NaN;if(Number.isFinite(h)){d(h);try{tn(h,!0)}catch(S){u("Failed to highlight nearest timestamp on pause:",S,"warn")}}},x=()=>{d(null);try{let f=ne(),h=f?Math.floor(f.getCurrentTime()):NaN;Number.isFinite(h)&&tn(h,!0)}catch(f){u("Failed to highlight nearest timestamp on play:",f,"warn")}},w=()=>{let f=et();if(!f)return;let h=ne(),S=h?Math.floor(h.getCurrentTime()):0;if(!Number.isFinite(S))return;f.paused&&d(S);let A=Gr(S);dr(A,!0)};Pr=c,zr=m,Nr=x,$r=w,o.addEventListener("timeupdate",c),o.addEventListener("pause",m),o.addEventListener("play",x),o.addEventListener("seeking",w)}let Es="ytls-timestamps-db",Ss=3,Ln="timestamps",nt="timestamps_v2",Zr="settings",An=null,Mn=null;function Dn(){if(An)try{if(An.objectStoreNames.length>=0)return Promise.resolve(An)}catch(o){u("IndexedDB connection is no longer usable:",o,"warn"),An=null}return Mn||(Mn=As().then(o=>(An=o,Mn=null,o.onclose=()=>{u("IndexedDB connection closed unexpectedly","warn"),An=null},o.onerror=c=>{u("IndexedDB connection error:",c,"error")},o)).catch(o=>{throw Mn=null,o}),Mn)}async function ca(){let o={},c=await da(nt),d=Ui.array().safeParse(c);if(!d.success)return u("Failed to parse timestamp rows for export:",d.error.format(),"warn"),{json:"{}",filename:"timekeeper-data.json",totalVideos:0,totalTimestamps:0};let m=new Map;for(let f of d.data)m.has(f.video_id)||m.set(f.video_id,[]),m.get(f.video_id).push({guid:f.guid,start:f.start,comment:f.comment});for(let[f,h]of m)o[`ytls-${f}`]={video_id:f,timestamps:h.sort((S,A)=>S.start-A.start)};return{json:JSON.stringify(o,null,2),filename:"timekeeper-data.json",totalVideos:m.size,totalTimestamps:d.data.length}}async function Is(){try{let{json:o,filename:c,totalVideos:d,totalTimestamps:m}=await ca(),x=new Blob([o],{type:"application/json"}),w=URL.createObjectURL(x),f=document.createElement("a");f.href=w,f.download=c,f.click(),URL.revokeObjectURL(w),u(`Exported ${d} videos with ${m} timestamps`)}catch(o){throw u("Failed to export data:",o,"error"),o}}async function Cs(){let o=Ui.array().safeParse(await da(nt));if(!o.success||o.data.length===0){o.success||u("Failed to parse timestamp rows for CSV export:",o.error.format(),"warn");let E=`Tag,Timestamp,URL
`,L=`timestamps-${vr()}.csv`;return{csv:E,filename:L,totalVideos:0,totalTimestamps:0}}let c=o.data,d=new Map;for(let E of c)d.has(E.video_id)||d.set(E.video_id,[]),d.get(E.video_id).push({start:E.start,comment:E.comment});let m=[];m.push("Tag,Timestamp,URL");let x=0,w=E=>`"${String(E).replace(/"/g,'""')}"`,f=E=>{let L=Math.floor(E/3600),N=Math.floor(E%3600/60),W=String(E%60).padStart(2,"0");return`${String(L).padStart(2,"0")}:${String(N).padStart(2,"0")}:${W}`},h=Array.from(d.keys()).sort();for(let E of h){let L=d.get(E).sort((N,W)=>N.start-W.start);for(let N of L){let W=N.comment,Y=f(N.start),Q=Di(N.start,`https://www.youtube.com/watch?v=${E}`);m.push([w(W),w(Y),w(Q)].join(",")),x++}}let S=m.join(`
`),A=`timestamps-${vr()}.csv`;return{csv:S,filename:A,totalVideos:d.size,totalTimestamps:x}}async function Ls(){try{let{csv:o,filename:c,totalVideos:d,totalTimestamps:m}=await Cs(),x=new Blob([o],{type:"text/csv;charset=utf-8;"}),w=URL.createObjectURL(x),f=document.createElement("a");f.href=w,f.download=c,f.click(),URL.revokeObjectURL(w),u(`Exported ${d} videos with ${m} timestamps (CSV)`)}catch(o){throw u("Failed to export CSV data:",o,"error"),o}}function As(){return new Promise((o,c)=>{let d=indexedDB.open(Es,Ss);d.onupgradeneeded=m=>{let x=m.target.result,w=m.oldVersion,f=m.target.transaction;if(w<1&&x.createObjectStore(Ln,{keyPath:"video_id"}),w<2&&!x.objectStoreNames.contains(Zr)&&x.createObjectStore(Zr,{keyPath:"key"}),w<3){if(x.objectStoreNames.contains(Ln)){u("Exporting backup before v2 migration...");let A=f.objectStore(Ln).getAll();A.onsuccess=()=>{let E=ci.array().safeParse(A.result);if(E.success&&E.data.length>0)try{let L={},N=0;E.data.forEach(Ze=>{if(Ze.timestamps.length>0){let Me=Tr.parse(Ze.timestamps);L[`ytls-${Ze.video_id}`]={video_id:Ze.video_id,timestamps:[...Me].sort((rt,jt)=>rt.start-jt.start)},N+=Me.length}});let W=new Blob([JSON.stringify(L,null,2)],{type:"application/json"}),Y=URL.createObjectURL(W),Q=document.createElement("a");Q.href=Y,Q.download=`timekeeper-data-${vr()}.json`,Q.click(),URL.revokeObjectURL(Y),u(`Pre-migration backup exported: ${E.data.length} videos, ${N} timestamps`)}catch(L){u("Failed to export pre-migration backup:",L,"error")}else E.success||u("Skipping pre-migration backup: legacy data failed validation",E.error.format(),"warn")}}let h=x.createObjectStore(nt,{keyPath:"guid"});if(h.createIndex("video_id","video_id",{unique:!1}),h.createIndex("video_start",["video_id","start"],{unique:!1}),x.objectStoreNames.contains(Ln)){let A=f.objectStore(Ln).getAll();A.onsuccess=()=>{let E=ci.array().safeParse(A.result);if(E.success&&E.data.length>0){let L=0;E.data.forEach(N=>{N.timestamps.length>0&&N.timestamps.forEach(W=>{h.put({guid:W.guid,video_id:N.video_id,start:W.start,comment:W.comment}),L++})}),u(`Migrated ${L} timestamps from ${E.data.length} videos to v2 store`)}else E.success||u("Skipping v1 \u2192 v2 migration: legacy data failed validation",E.error.format(),"warn")},x.deleteObjectStore(Ln),u("Deleted old timestamps store after migration to v2")}}},d.onsuccess=m=>{o(m.target.result)},d.onerror=m=>{let x=m.target.error;c(x??new Error("Failed to open IndexedDB"))}})}function _i(o,c,d){return Dn().then(m=>new Promise((x,w)=>{let f;try{f=m.transaction(o,c)}catch(A){w(new Error(`Failed to create transaction for ${o}: ${A}`));return}let h=f.objectStore(o),S;try{S=d(h)}catch(A){w(new Error(`Failed to execute operation on ${o}: ${A}`));return}S&&(S.onsuccess=()=>x(S.result),S.onerror=()=>w(S.error??new Error(`IndexedDB ${c} operation failed`))),f.oncomplete=()=>{S||x(void 0)},f.onerror=()=>w(f.error??new Error("IndexedDB transaction failed")),f.onabort=()=>w(f.error??new Error("IndexedDB transaction aborted"))}))}function ua(o,c){let d=Tr.safeParse(c);if(!d.success)return Promise.reject(new Error(`Invalid timestamp payload for ${o}`));let m=d.data;return Dn().then(x=>new Promise((w,f)=>{let h;try{h=x.transaction([nt],"readwrite")}catch(L){f(new Error(`Failed to create transaction: ${L}`));return}let S=h.objectStore(nt),E=S.index("video_id").getAll(IDBKeyRange.only(o));E.onsuccess=()=>{try{let L=E.result,N=new Set(m.map(W=>W.guid));L.forEach(W=>{N.has(W.guid)||S.delete(W.guid)}),m.forEach(W=>{S.put({guid:W.guid,video_id:o,start:W.start,comment:W.comment})})}catch(L){u("Error during save operation:",L,"error")}},E.onerror=()=>{f(E.error??new Error("Failed to get existing records"))},h.oncomplete=()=>w(),h.onerror=()=>f(h.error??new Error("Failed to save to IndexedDB")),h.onabort=()=>f(h.error??new Error("Transaction aborted during save"))}))}function Ms(o,c){let d=Wn.safeParse(c);if(!d.success)return Promise.reject(new Error(`Invalid timestamp: ${d.error.message}`));let m=d.data;return Dn().then(x=>new Promise((w,f)=>{let h;try{h=x.transaction([nt],"readwrite")}catch(E){f(new Error(`Failed to create transaction: ${E}`));return}let A=h.objectStore(nt).put({guid:m.guid,video_id:o,start:m.start,comment:m.comment});A.onerror=()=>{f(A.error??new Error("Failed to put timestamp"))},h.oncomplete=()=>w(),h.onerror=()=>f(h.error??new Error("Failed to save single timestamp to IndexedDB")),h.onabort=()=>f(h.error??new Error("Transaction aborted during single timestamp save"))}))}function Ds(o,c){return u(`Deleting timestamp ${c} for video ${o}`),Dn().then(d=>new Promise((m,x)=>{let w;try{w=d.transaction([nt],"readwrite")}catch(S){x(new Error(`Failed to create transaction: ${S}`));return}let h=w.objectStore(nt).delete(c);h.onerror=()=>{x(h.error??new Error("Failed to delete timestamp"))},w.oncomplete=()=>m(),w.onerror=()=>x(w.error??new Error("Failed to delete single timestamp from IndexedDB")),w.onabort=()=>x(w.error??new Error("Transaction aborted during timestamp deletion"))}))}function Bs(o){return Dn().then(c=>new Promise(d=>{let m;try{m=c.transaction([nt],"readonly")}catch(h){u("Failed to create read transaction:",h,"warn"),d(null);return}let f=m.objectStore(nt).index("video_id").getAll(IDBKeyRange.only(o));f.onsuccess=()=>{let h=f.result;if(h.length===0){d(null);return}let S=h.map(L=>({guid:L.guid,start:L.start,comment:L.comment})),A=Tr.safeParse(S);if(!A.success){u("Failed to parse timestamps from IndexedDB:",A.error.format(),"warn"),d(null);return}let E=[...A.data].sort((L,N)=>L.start-N.start);d(E)},f.onerror=()=>{u("Failed to load timestamps:",f.error,"warn"),d(null)},m.onabort=()=>{u("Transaction aborted during load:",m.error,"warn"),d(null)}}))}function Rs(o){return Dn().then(c=>new Promise((d,m)=>{let x;try{x=c.transaction([nt],"readwrite")}catch(S){m(new Error(`Failed to create transaction: ${S}`));return}let w=x.objectStore(nt),h=w.index("video_id").getAll(IDBKeyRange.only(o));h.onsuccess=()=>{try{h.result.forEach(A=>{w.delete(A.guid)})}catch(S){u("Error during remove operation:",S,"error")}},h.onerror=()=>{m(h.error??new Error("Failed to get records for removal"))},x.oncomplete=()=>d(),x.onerror=()=>m(x.error??new Error("Failed to remove timestamps")),x.onabort=()=>m(x.error??new Error("Transaction aborted during timestamp removal"))}))}function da(o){return _i(o,"readonly",c=>c.getAll()).then(c=>Array.isArray(c)?c:[])}function Wr(o,c){_i(Zr,"readwrite",d=>{d.put({key:o,value:c})}).catch(d=>{u(`Failed to save setting '${o}' to IndexedDB:`,d,"error")})}function Ei(o){return _i(Zr,"readonly",c=>c.get(o)).then(c=>c?.value).catch(c=>{u(`Failed to load setting '${o}' from IndexedDB:`,c,"error")})}function fa(){if(!r)return;let o=r.style.display!=="none";Wr("uiVisible",o)}function Ct(o){let c=typeof o=="boolean"?o:!!r&&r.style.display!=="none",d=document.getElementById("ytls-header-button");d instanceof HTMLButtonElement&&d.setAttribute("aria-pressed",String(c)),Ft&&!Dr&&Ft.src!==Pe&&(Ft.src=Pe)}function Os(){r&&Ei("uiVisible").then(o=>{let c=B.boolean().safeParse(o),d=c.success?c.data:void 0;typeof d=="boolean"?(d?(r.style.display="flex",r.classList.remove("ytls-zoom-out"),r.classList.add("ytls-zoom-in")):r.style.display="none",Ct(d)):(!c.success&&o!==void 0&&u("UI visibility state failed validation, defaulting to visible",c.error.format(),"warn"),r.style.display="flex",r.classList.remove("ytls-zoom-out"),r.classList.add("ytls-zoom-in"),Ct(!0))}).catch(o=>{u("Failed to load UI visibility state:",o,"error"),r.style.display="flex",r.classList.remove("ytls-zoom-out"),r.classList.add("ytls-zoom-in"),Ct(!0)})}function Si(o){if(!r){u("ERROR: togglePaneVisibility called but pane is null");return}document.body.contains(r)||(u("Pane not in DOM during toggle, appending it"),document.querySelectorAll("#ytls-pane").forEach(x=>{x!==r&&x.remove()}),document.body.appendChild(r));let c=document.querySelectorAll("#ytls-pane");c.length>1&&(u(`ERROR: Multiple panes detected in togglePaneVisibility (${c.length}), cleaning up`),c.forEach(x=>{x!==r&&x.remove()})),gt&&(clearTimeout(gt),gt=null);let d=r.style.display==="none";(typeof o=="boolean"?o:d)?(r.style.display="flex",r.classList.remove("ytls-fade-out"),r.classList.remove("ytls-zoom-out"),r.classList.add("ytls-zoom-in"),Ct(!0),fa(),ye(),_e&&(clearTimeout(_e),_e=null),_e=setTimeout(()=>{Z(),typeof window.recalculateTimestampsArea=="function"&&window.recalculateTimestampsArea(),ee(),me(!0);try{let x=ne(),w=x?Math.floor(x.getCurrentTime()):NaN;Number.isFinite(w)&&tn(w,!0)}catch(x){u("Failed to scroll to nearest timestamp after toggle:",x,"warn")}_e=null},450)):(r.classList.remove("ytls-fade-in"),r.classList.remove("ytls-zoom-in"),r.classList.add("ytls-zoom-out"),Ct(!1),te())}function ma(o){if(!s){u("UI is not initialized; cannot import timestamps.","warn");return}let c=!1;try{let d=JSON.parse(o),m=null;if(Array.isArray(d))m=d;else if(typeof d=="object"&&d!==null){let x=Se;if(x){let w=`timekeeper-${x}`;d[w]&&Array.isArray(d[w].timestamps)&&(m=d[w].timestamps,u(`Found timestamps for current video (${x}) in export format`,"info"))}if(!m){let w=Object.keys(d).filter(f=>f.startsWith("ytls-"));if(w.length===1&&Array.isArray(d[w[0]].timestamps)){m=d[w[0]].timestamps;let f=d[w[0]].video_id;u(`Found timestamps for video ${f} in export format`,"info")}}}m&&Array.isArray(m)?m.every(w=>typeof w.start=="number"&&typeof w.comment=="string")?(m.forEach(w=>{if(w.guid){let f=pe().find(h=>h.dataset.guid===w.guid);if(f){let h=f.querySelector("input");h&&(h.value=w.comment)}else fr(w.start,w.comment,!1,w.guid)}else fr(w.start,w.comment,!1,crypto.randomUUID())}),c=!0):u("Parsed JSON array, but items are not in the expected timestamp format. Trying as plain text.","warn"):u("Parsed JSON, but couldn't find valid timestamps. Trying as plain text.","warn")}catch{}if(!c){let d=o.split(`
`).map(m=>m.trim()).filter(m=>m);if(d.length>0){let m=!1;d.forEach(x=>{let w=x.match(/^(?:(\d{1,2}):)?(\d{1,2}):(\d{2})\s*(.*)$/);if(w){m=!0;let f=parseInt(w[1])||0,h=parseInt(w[2]),S=parseInt(w[3]),A=f*3600+h*60+S,E=w[4]?w[4].trim():"",L=null,N=E,W=E.match(/<!--\s*guid:([^>]+?)\s*-->/);W&&(L=W[1].trim(),N=E.replace(/<!--\s*guid:[^>]+?\s*-->/,"").trim());let Y;if(L&&(Y=pe().find(Q=>Q.dataset.guid===L)),!Y&&!L&&(Y=pe().find(Q=>{if(Q.dataset.guid)return!1;let Me=Q.querySelector("a[data-time]")?.dataset.time;if(!Me)return!1;let rt=Number.parseInt(Me,10);return Number.isFinite(rt)&&rt===A})),Y){let Q=Y.querySelector("input");Q&&(Q.value=N)}else fr(A,N,!1,L||crypto.randomUUID())}}),m&&(c=!0)}}c?(u("Timestamps changed: Imported timestamps from file/clipboard"),xt(),qr(Se),$e(),Vr()):alert("Failed to parse content. Please ensure it is in the correct JSON or plain text format.")}async function Ps(){if(yi){u("Pane initialization already in progress, skipping duplicate call");return}if(!(r&&document.body.contains(r))){yi=!0;try{let m=function(){if(ke||en)return;let v=et(),y=ne();if(!v&&!y)return;let k=y?y.getCurrentTime():0,T=Number.isFinite(k)?Math.max(0,Math.floor(k)):Math.max(0,Xt()),O=Math.floor(T/3600),H=Math.floor(T/60)%60,j=T%60,{isLive:K}=y?y.getVideoData()||{isLive:!1}:{isLive:!1},G=y?vs(y):!1,le=s?pe().map(oe=>{let Le=oe.querySelector("a[data-time]");return Le?parseFloat(Le.getAttribute("data-time")??"0"):0}):[],Fe="";if(le.length>0)if(K){let oe=Math.max(1,T/60),Le=le.filter(je=>je<=T);if(Le.length>0){let je=(Le.length/oe).toFixed(2);parseFloat(je)>0&&(Fe=` (${je}/min)`)}}else{let oe=y?y.getDuration():0,Le=Number.isFinite(oe)&&oe>0?oe:v&&Number.isFinite(v.duration)&&v.duration>0?v.duration:0,je=Math.max(1,Le/60),At=(le.length/je).toFixed(1);parseFloat(At)>0&&(Fe=` (${At}/min)`)}p.textContent=`\u23F3${O?O+":"+String(H).padStart(2,"0"):H}:${String(j).padStart(2,"0")}${Fe}`,p.style.color=G?"#ff4d4f":"",le.length>0&&tn(T,!1)},Q=function(v,y,k){let T=document.createElement("button");return T.textContent=v,kt(T,y),T.classList.add("ytls-settings-modal-button"),T.onclick=k,T},Ze=function(v="general"){if(U&&U.parentNode===document.body){let ze=document.getElementById("ytls-save-modal"),Ht=document.getElementById("ytls-load-modal"),Mt=document.getElementById("ytls-delete-all-modal");ze&&document.body.contains(ze)&&document.body.removeChild(ze),Ht&&document.body.contains(Ht)&&document.body.removeChild(Ht),Mt&&document.body.contains(Mt)&&document.body.removeChild(Mt),U.classList.remove("ytls-fade-in"),U.classList.add("ytls-fade-out"),setTimeout(()=>{document.body.contains(U)&&document.body.removeChild(U),U=null,document.removeEventListener("click",rt,!0),document.removeEventListener("keydown",Me)},300);return}U=document.createElement("div"),U.id="ytls-settings-modal",U.classList.remove("ytls-fade-out"),U.classList.add("ytls-fade-in");let y=document.createElement("div");y.className="ytls-modal-header";let k=document.createElement("div");k.id="ytls-settings-nav";let T=document.createElement("button");T.className="ytls-modal-close-button",T.textContent="\u2715",T.onclick=()=>{if(U&&U.parentNode===document.body){let ze=document.getElementById("ytls-save-modal"),Ht=document.getElementById("ytls-load-modal"),Mt=document.getElementById("ytls-delete-all-modal");ze&&document.body.contains(ze)&&document.body.removeChild(ze),Ht&&document.body.contains(Ht)&&document.body.removeChild(Ht),Mt&&document.body.contains(Mt)&&document.body.removeChild(Mt),U.classList.remove("ytls-fade-in"),U.classList.add("ytls-fade-out"),setTimeout(()=>{document.body.contains(U)&&document.body.removeChild(U),U=null,document.removeEventListener("click",rt,!0),document.removeEventListener("keydown",Me)},300)}};let O=document.createElement("div");O.id="ytls-settings-content";let H=document.createElement("h3");H.className="ytls-section-heading",H.textContent="General",H.style.display="none";let j=document.createElement("div"),K=document.createElement("div");K.className="ytls-button-grid";function G(ze){j.style.display=ze==="general"?"block":"none",K.style.display=ze==="drive"?"block":"none",le.classList.toggle("active",ze==="general"),oe.classList.toggle("active",ze==="drive"),H.textContent=ze==="general"?"General":"Google Drive"}let le=document.createElement("button");le.textContent="\u{1F6E0}\uFE0F";let Fe=document.createElement("span");Fe.className="ytls-tab-text",Fe.textContent=" General",le.appendChild(Fe),kt(le,"General settings"),le.classList.add("ytls-settings-modal-button"),le.onclick=()=>G("general");let oe=document.createElement("button");oe.textContent="\u2601\uFE0F";let Le=document.createElement("span");Le.className="ytls-tab-text",Le.textContent=" Backup",oe.appendChild(Le),kt(oe,"Google Drive sign-in and backup"),oe.classList.add("ytls-settings-modal-button"),oe.onclick=async()=>{z.isSignedIn&&await ls(),G("drive")},k.appendChild(le),k.appendChild(oe),y.appendChild(k),y.appendChild(T),U.appendChild(y),j.className="ytls-button-grid",j.appendChild(Q("\u{1F4BE} Save","Save As...",jt.onclick)),j.appendChild(Q("\u{1F4C2} Load","Load",Lt.onclick)),j.appendChild(Q("\u{1F4E4} Export All","Export All Data",fe.onclick)),j.appendChild(Q("\u{1F4E5} Import All","Import All Data",re.onclick)),j.appendChild(Q("\u{1F4C4} Export All (CSV)","Export All Timestamps to CSV",async()=>{try{await Ls()}catch{alert("Failed to export CSV: Could not read from database.")}}));let je=Q(z.isSignedIn?"\u{1F513} Sign Out":"\u{1F510} Sign In",z.isSignedIn?"Sign out from Google Drive":"Sign in to Google Drive",async()=>{z.isSignedIn?await os():await as(),je.textContent=z.isSignedIn?"\u{1F513} Sign Out":"\u{1F510} Sign In",kt(je,z.isSignedIn?"Sign out from Google Drive":"Sign in to Google Drive"),typeof ge=="function"&&ge()});K.appendChild(je);let At=Q(ht?"\u{1F501} Auto Backup: On":"\u{1F501} Auto Backup: Off","Toggle Auto Backup",async()=>{await fs(),At.textContent=ht?"\u{1F501} Auto Backup: On":"\u{1F501} Auto Backup: Off",typeof ge=="function"&&ge()});K.appendChild(At);let rn=Q(`\u23F1\uFE0F Backup Interval: ${Je}min`,"Set periodic backup interval (minutes)",async()=>{await ms(),rn.textContent=`\u23F1\uFE0F Backup Interval: ${Je}min`,typeof ge=="function"&&ge()});K.appendChild(rn),K.appendChild(Q("\u{1F5C4}\uFE0F Backup Now","Run a backup immediately",async()=>{await Sr(!1),typeof ge=="function"&&ge()}));let it=document.createElement("div");it.style.marginTop="15px",it.style.paddingTop="10px",it.style.borderTop="1px solid #555",it.style.fontSize="12px",it.style.color="#aaa";let an=document.createElement("div");an.style.marginBottom="8px",an.style.fontWeight="bold",it.appendChild(an),ns(an);let Ci=document.createElement("div");Ci.style.marginBottom="8px",es(Ci),it.appendChild(Ci);let va=document.createElement("div");ts(va),it.appendChild(va),K.appendChild(it),Ke(),Ir(),ge(),O.appendChild(H),O.appendChild(j),O.appendChild(K),G(v),U.appendChild(O),document.body.appendChild(U),requestAnimationFrame(()=>{let ze=U.getBoundingClientRect(),Mt=(window.innerHeight-ze.height)/2;U.style.top=`${Math.max(20,Mt)}px`,U.style.transform="translateX(-50%)"}),setTimeout(()=>{document.addEventListener("click",rt,!0),document.addEventListener("keydown",Me)},0)},Me=function(v){if(v.key==="Escape"&&U&&U.parentNode===document.body){let y=document.getElementById("ytls-save-modal"),k=document.getElementById("ytls-load-modal"),T=document.getElementById("ytls-delete-all-modal");if(y||k||T)return;v.preventDefault(),y&&document.body.contains(y)&&document.body.removeChild(y),k&&document.body.contains(k)&&document.body.removeChild(k),T&&document.body.contains(T)&&document.body.removeChild(T),U.classList.remove("ytls-fade-in"),U.classList.add("ytls-fade-out"),setTimeout(()=>{document.body.contains(U)&&document.body.removeChild(U),U=null,document.removeEventListener("click",rt,!0),document.removeEventListener("keydown",Me)},300)}},rt=function(v){if(Mr&&Mr.contains(v.target))return;let y=document.getElementById("ytls-save-modal"),k=document.getElementById("ytls-load-modal"),T=document.getElementById("ytls-delete-all-modal");y&&y.contains(v.target)||k&&k.contains(v.target)||T&&T.contains(v.target)||U&&U.contains(v.target)||(y&&document.body.contains(y)&&document.body.removeChild(y),k&&document.body.contains(k)&&document.body.removeChild(k),T&&document.body.contains(T)&&document.body.removeChild(T),U&&U.parentNode===document.body&&(U.classList.remove("ytls-fade-in"),U.classList.add("ytls-fade-out"),setTimeout(()=>{document.body.contains(U)&&document.body.removeChild(U),U=null,document.removeEventListener("click",rt,!0),document.removeEventListener("keydown",Me)},300)))},Ie=function(){r&&(u("Loading window position from IndexedDB"),Ei("windowPosition").then(v=>{let y=Ka.safeParse(v);if(y.success){let T=y.data;r.style.left=`${T.x}px`,r.style.top=`${T.y}px`,r.style.right="auto",r.style.bottom="auto",typeof T.width=="number"&&T.width>0?r.style.width=`${T.width}px`:(r.style.width=`${En}px`,u(`No stored window width found, using default width ${En}px`)),typeof T.height=="number"&&T.height>0?r.style.height=`${T.height}px`:(r.style.height=`${Yt}px`,u(`No stored window height found, using default height ${Yt}px`));let O=de();he(O,T.x,T.y),u("Restored window position from IndexedDB:",qe)}else y.success?u("No window position found in IndexedDB, applying default size and leaving default position"):u("Window position in IndexedDB failed validation:",y.error.format(),"warn"),r.style.width=`${En}px`,r.style.height=`${Yt}px`,qe=null;Cn();let k=de();k&&(k.width||k.height)&&he(k),typeof window.recalculateTimestampsArea=="function"&&window.recalculateTimestampsArea()}).catch(v=>{u("failed to load pane position from IndexedDB:",v,"warn"),Cn();let y=de();y&&(y.width||y.height)&&(qe={x:Math.max(0,Math.round(y.left)),y:0,width:Math.round(y.width),height:Math.round(y.height)}),typeof window.recalculateTimestampsArea=="function"&&window.recalculateTimestampsArea()}))},De=function(){if(!r)return;let v=de();if(!v)return;let y={x:Math.max(0,Math.round(v.left)),y:Math.max(0,Math.round(v.top)),width:Math.round(v.width),height:Math.round(v.height)};if(qe&&qe.x===y.x&&qe.y===y.y&&qe.width===y.width&&qe.height===y.height){u("Skipping window position save; position and size unchanged");return}qe={...y},u(`Saving window position and size to IndexedDB: x=${y.x}, y=${y.y}, width=${y.width}, height=${y.height}`),Wr("windowPosition",y),tr({type:"window_position_updated",position:y,timestamp:Date.now()})},Xr=function(v,y){v.addEventListener("dblclick",k=>{k.preventDefault(),k.stopPropagation(),r&&(r.style.width="300px",r.style.height="300px",De(),pr())}),v.addEventListener("mousedown",k=>{k.preventDefault(),k.stopPropagation(),Pn=!0,nn=y,ga=k.clientX,ya=k.clientY;let T=r.getBoundingClientRect();zn=T.width,Nn=T.height,Kr=T.left,Jr=T.top,y==="top-left"||y==="bottom-right"?document.body.style.cursor="nwse-resize":document.body.style.cursor="nesw-resize"})},pr=function(){if(r&&l&&g&&s){let v=r.getBoundingClientRect(),y=l.getBoundingClientRect(),k=g.getBoundingClientRect(),T=v.height-(y.height+k.height);s.style.maxHeight=T>0?T+"px":"0px",s.style.overflowY=T>0?"auto":"hidden"}};document.querySelectorAll("#ytls-pane").forEach(v=>v.remove()),r=document.createElement("div"),l=document.createElement("div"),s=document.createElement("ul"),g=document.createElement("div"),p=document.createElement("span"),b=document.createElement("style"),M=document.createElement("span"),R=document.createElement("span"),R.classList.add("ytls-backup-indicator"),R.style.cursor="pointer",R.style.backgroundColor="#666",R.onclick=v=>{v.stopPropagation(),Ze("drive")},s.addEventListener("mouseenter",()=>{Ar=!0,or=!1}),s.addEventListener("mouseleave",()=>{if(Ar=!1,or)return;let v=ne(),y=v?Math.floor(v.getCurrentTime()):Xt();tn(y,!1);let k=null;if(document.activeElement instanceof HTMLInputElement&&s.contains(document.activeElement)&&(k=document.activeElement.closest("li")?.dataset.guid??null),aa(),k){let O=pe().find(H=>H.dataset.guid===k)?.querySelector("input");if(O)try{O.focus({preventScroll:!0})}catch{}}}),r.id="ytls-pane",l.id="ytls-pane-header",l.addEventListener("dblclick",v=>{let y=v.target instanceof HTMLElement?v.target:null;y&&(y.closest("a")||y.closest("button")||y.closest("#ytls-current-time")||y.closest(".ytls-version-display")||y.closest(".ytls-backup-indicator"))||(v.preventDefault(),Si(!1))});let o=v=>{try{v.stopPropagation()}catch{}};["click","dblclick","mousedown","pointerdown","touchstart","wheel"].forEach(v=>{r.addEventListener(v,o)}),r.addEventListener("keydown",v=>{try{v.stopPropagation()}catch{}}),r.addEventListener("keyup",v=>{try{v.stopPropagation()}catch{}}),r.addEventListener("focus",v=>{try{v.stopPropagation()}catch{}},!0),r.addEventListener("blur",v=>{try{v.stopPropagation()}catch{}},!0);let c=GM_info.script.version;M.textContent=`v${c}`,M.classList.add("ytls-version-display");let d=document.createElement("span");d.style.display="inline-flex",d.style.alignItems="center",d.style.gap="6px",d.appendChild(M),d.appendChild(R),p.id="ytls-current-time",p.textContent="\u23F3",p.onclick=()=>{en=!0;let v=ne();v&&v.seekToLiveHead(),setTimeout(()=>{en=!1},500)},m(),xe&&clearInterval(xe),xe=setInterval(m,1e3),g.id="ytls-buttons";let x=(v,y)=>()=>{v.classList.remove("ytls-fade-in"),v.classList.add("ytls-fade-out"),setTimeout(()=>{document.body.contains(v)&&document.body.removeChild(v),y&&y()},300)},w=v=>y=>{y.key==="Escape"&&(y.preventDefault(),y.stopPropagation(),v())},f=v=>{setTimeout(()=>{document.addEventListener("keydown",v)},0)},h=(v,y)=>k=>{v.contains(k.target)||y()},S=v=>{setTimeout(()=>{document.addEventListener("click",v,!0)},0)},W=[{label:"\u{1F423}",title:"Add timestamp",action:()=>{if(!s||s.querySelector(".ytls-error-message")||ke)return;let v=typeof Sn<"u"?Sn:0,y=ne(),k=y?Math.floor(y.getCurrentTime()+v):0;if(!Number.isFinite(k))return;let T=fr(k,"");T&&T.focus()}},{label:"\u2699\uFE0F",title:"Settings",action:()=>Ze()},{label:"\u{1F4CB}",title:"Copy timestamps to clipboard",action:function(v){if(!s||s.querySelector(".ytls-error-message")||ke){this.textContent="\u274C",setTimeout(()=>{this.textContent="\u{1F4CB}"},2e3);return}let y=vi(),k=Math.max(Xt(),0);if(y.length===0){this.textContent="\u274C",setTimeout(()=>{this.textContent="\u{1F4CB}"},2e3);return}let T=v.ctrlKey,O=y.map(H=>{let j=Zt(H.start,k);return T?`${j} ${H.comment} <!-- guid:${H.guid} -->`.trimStart():`${j} ${H.comment}`}).join(`
`);navigator.clipboard.writeText(O).then(()=>{this.textContent="\u2705",setTimeout(()=>{this.textContent="\u{1F4CB}"},2e3)}).catch(H=>{u("Failed to copy timestamps: ",H,"error"),this.textContent="\u274C",setTimeout(()=>{this.textContent="\u{1F4CB}"},2e3)})}},{label:"\u23F1\uFE0F",title:"Offset all timestamps",action:()=>{if(!s||s.querySelector(".ytls-error-message")||ke)return;if(pe().length===0){alert("No timestamps available to offset.");return}let y=prompt("Enter the number of seconds to offset all timestamps (positive or negative integer):","0");if(y===null)return;let k=y.trim();if(k.length===0)return;let T=Number.parseInt(k,10);if(!Number.isFinite(T)){alert("Please enter a valid integer number of seconds.");return}T!==0&&ra(T,{alertOnNoChange:!0,failureMessage:"Offset had no effect because timestamps are already at the requested bounds.",logLabel:"bulk offset"})}},{label:"\u{1F5D1}\uFE0F",title:"Delete all timestamps for current video",action:async()=>{let v=Ti();if(!v){alert("Unable to determine current video ID.");return}let y=document.createElement("div");y.id="ytls-delete-all-modal",y.classList.remove("ytls-fade-out"),y.classList.add("ytls-fade-in");let k=document.createElement("p");k.textContent="Hold the button to delete all timestamps for:",k.style.marginBottom="10px";let T=document.createElement("p");T.textContent=v,T.style.fontFamily="monospace",T.style.fontSize="12px",T.style.marginBottom="15px",T.style.color="#aaa";let O=document.createElement("button");O.classList.add("ytls-save-modal-button"),O.style.background="#d32f2f",O.style.position="relative",O.style.overflow="hidden";let H=null,j=0,K=null,G=document.createElement("div");G.style.position="absolute",G.style.left="0",G.style.top="0",G.style.height="100%",G.style.width="0%",G.style.background="#ff6b6b",G.style.transition="none",G.style.pointerEvents="none",O.appendChild(G);let le=document.createElement("span");le.textContent="Hold to Delete All",le.style.position="relative",le.style.zIndex="1",O.appendChild(le);let Fe=()=>{if(!j)return;let it=Date.now()-j,an=Math.min(it/5e3*100,100);G.style.width=`${an}%`,an<100&&(K=requestAnimationFrame(Fe))},oe=()=>{H&&(clearTimeout(H),H=null),K&&(cancelAnimationFrame(K),K=null),j=0,G.style.width="0%",le.textContent="Hold to Delete All"};O.onmousedown=()=>{j=Date.now(),le.textContent="Deleting...",K=requestAnimationFrame(Fe),H=setTimeout(async()=>{oe(),y.classList.remove("ytls-fade-in"),y.classList.add("ytls-fade-out"),setTimeout(async()=>{document.body.contains(y)&&document.body.removeChild(y);try{await Rs(v),Ii()}catch(it){u("Failed to delete all timestamps:",it,"error"),alert("Failed to delete timestamps. Check console for details.")}},300)},5e3)},O.onmouseup=oe,O.onmouseleave=oe;let Le=null,je=null,At=x(y,()=>{oe(),Le&&document.removeEventListener("keydown",Le),je&&document.removeEventListener("click",je,!0)});Le=w(At),je=h(y,At);let rn=document.createElement("button");rn.textContent="Cancel",rn.classList.add("ytls-save-modal-cancel-button"),rn.onclick=At,y.appendChild(k),y.appendChild(T),y.appendChild(O),y.appendChild(rn),document.body.appendChild(y),f(Le),S(je)}}],Y=Aa();W.forEach(v=>{let y=document.createElement("button");if(y.textContent=v.label,kt(y,v.title),y.classList.add("ytls-main-button"),v.label==="\u{1F423}"&&Y){let k=document.createElement("span");k.textContent=Y,k.classList.add("ytls-holiday-emoji"),y.appendChild(k)}v.label==="\u{1F4CB}"?y.onclick=function(k){v.action.call(this,k)}:y.onclick=v.action,v.label==="\u2699\uFE0F"&&(Mr=y),g.appendChild(y)});let jt=document.createElement("button");jt.textContent="\u{1F4BE} Save",jt.classList.add("ytls-file-operation-button"),jt.onclick=()=>{let v=document.createElement("div");v.id="ytls-save-modal",v.classList.remove("ytls-fade-out"),v.classList.add("ytls-fade-in");let y=document.createElement("p");y.textContent="Save as:";let k=null,T=null,O=x(v,()=>{k&&document.removeEventListener("keydown",k),T&&document.removeEventListener("click",T,!0)});k=w(O),T=h(v,O);let H=document.createElement("button");H.textContent="JSON",H.classList.add("ytls-save-modal-button"),H.onclick=()=>{k&&document.removeEventListener("keydown",k),T&&document.removeEventListener("click",T,!0),x(v,()=>sa("json"))()};let j=document.createElement("button");j.textContent="Plain Text",j.classList.add("ytls-save-modal-button"),j.onclick=()=>{k&&document.removeEventListener("keydown",k),T&&document.removeEventListener("click",T,!0),x(v,()=>sa("text"))()};let K=document.createElement("button");K.textContent="Cancel",K.classList.add("ytls-save-modal-cancel-button"),K.onclick=O,v.appendChild(y),v.appendChild(H),v.appendChild(j),v.appendChild(K),document.body.appendChild(v),f(k),S(T)};let Lt=document.createElement("button");Lt.textContent="\u{1F4C2} Load",Lt.classList.add("ytls-file-operation-button"),Lt.onclick=()=>{let v=document.createElement("div");v.id="ytls-load-modal",v.classList.remove("ytls-fade-out"),v.classList.add("ytls-fade-in");let y=document.createElement("p");y.textContent="Load from:";let k=null,T=null,O=x(v,()=>{k&&document.removeEventListener("keydown",k),T&&document.removeEventListener("click",T,!0)});k=w(O),T=h(v,O);let H=document.createElement("button");H.textContent="File",H.classList.add("ytls-save-modal-button"),H.onclick=()=>{let G=document.createElement("input");G.type="file",G.accept=".json,.txt",G.classList.add("ytls-hidden-file-input"),G.onchange=le=>{let Fe=le.target.files?.[0];if(!Fe)return;k&&document.removeEventListener("keydown",k),T&&document.removeEventListener("click",T,!0),O();let oe=new FileReader;oe.onload=()=>{let Le=String(oe.result).trim();ma(Le)},oe.readAsText(Fe)},G.click()};let j=document.createElement("button");j.textContent="Clipboard",j.classList.add("ytls-save-modal-button"),j.onclick=async()=>{k&&document.removeEventListener("keydown",k),T&&document.removeEventListener("click",T,!0),x(v,async()=>{try{let G=await navigator.clipboard.readText();G?ma(G.trim()):alert("Clipboard is empty.")}catch(G){u("Failed to read from clipboard: ",G,"error"),alert("Failed to read from clipboard. Ensure you have granted permission.")}})()};let K=document.createElement("button");K.textContent="Cancel",K.classList.add("ytls-save-modal-cancel-button"),K.onclick=O,v.appendChild(y),v.appendChild(H),v.appendChild(j),v.appendChild(K),document.body.appendChild(v),f(k),S(T)};let fe=document.createElement("button");fe.textContent="\u{1F4E4} Export",fe.classList.add("ytls-file-operation-button"),fe.onclick=async()=>{try{await Is()}catch{alert("Failed to export data: Could not read from database.")}};let re=document.createElement("button");re.textContent="\u{1F4E5} Import",re.classList.add("ytls-file-operation-button"),re.onclick=()=>{let v=document.createElement("input");v.type="file",v.accept=".json",v.classList.add("ytls-hidden-file-input"),v.onchange=y=>{let k=y.target.files?.[0];if(!k)return;let T=new FileReader;T.onload=()=>{try{let O=JSON.parse(String(T.result)),H=[];for(let j in O)if(Object.prototype.hasOwnProperty.call(O,j)&&j.startsWith("ytls-")){let K=j.substring(5),G=O[j];if(G&&typeof G.video_id=="string"&&Array.isArray(G.timestamps)){let le=G.timestamps.map(oe=>({...oe,guid:oe.guid||crypto.randomUUID()})),Fe=ua(K,le).then(()=>u(`Imported ${K} to IndexedDB`)).catch(oe=>u(`Failed to import ${K} to IndexedDB:`,oe,"error"));H.push(Fe)}else u(`Skipping key ${j} during import due to unexpected data format.`,"warn")}Promise.all(H).then(()=>{Ii()}).catch(j=>{alert("An error occurred during import to IndexedDB. Check console for details."),u("Overall import error:",j,"error")})}catch(O){alert(`Failed to import data. Please ensure the file is in the correct format.
`+O.message),u("Import error:",O,"error")}},T.readAsText(k)},v.click()},b.textContent=Ri,s.onclick=v=>{ia(v)},s.ontouchstart=v=>{ia(v)},r.style.position="fixed",r.style.bottom="0",r.style.right="0",r.style.transition="none",Ie(),setTimeout(()=>Cn(),10);let ue=!1,Ce,bt,ct=!1;r.addEventListener("mousedown",v=>{let y=v.target;y instanceof Element&&(y instanceof HTMLInputElement||y instanceof HTMLTextAreaElement||y!==l&&!l.contains(y)&&window.getComputedStyle(y).cursor==="pointer"||(ue=!0,ct=!1,Ce=v.clientX-r.getBoundingClientRect().left,bt=v.clientY-r.getBoundingClientRect().top,r.style.transition="none"))}),document.addEventListener("mousemove",Br=v=>{if(!ue)return;ct=!0;let y=v.clientX-Ce,k=v.clientY-bt,T=r.getBoundingClientRect(),O=T.width,H=T.height,j=document.documentElement.clientWidth,K=document.documentElement.clientHeight;y=Math.max(0,Math.min(y,j-O)),k=Math.max(0,Math.min(k,K-H)),r.style.left=`${y}px`,r.style.top=`${k}px`,r.style.right="auto",r.style.bottom="auto"}),document.addEventListener("mouseup",Rr=()=>{if(!ue)return;ue=!1;let v=ct;setTimeout(()=>{ct=!1},50),Cn(),setTimeout(()=>{v&&De()},200)}),r.addEventListener("dragstart",v=>v.preventDefault());let Bn=document.createElement("div"),Yr=document.createElement("div"),Rn=document.createElement("div"),On=document.createElement("div");Bn.id="ytls-resize-tl",Yr.id="ytls-resize-tr",Rn.id="ytls-resize-bl",On.id="ytls-resize-br";let Pn=!1,ga=0,ya=0,zn=0,Nn=0,Kr=0,Jr=0,nn=null;Xr(Bn,"top-left"),Xr(Yr,"top-right"),Xr(Rn,"bottom-left"),Xr(On,"bottom-right"),document.addEventListener("mousemove",v=>{if(!Pn||!r||!nn)return;let y=v.clientX-ga,k=v.clientY-ya,T=zn,O=Nn,H=Kr,j=Jr,K=document.documentElement.clientWidth,G=document.documentElement.clientHeight;nn==="bottom-right"?(T=Math.max(200,Math.min(800,zn+y)),O=Math.max(250,Math.min(G,Nn+k))):nn==="top-left"?(T=Math.max(200,Math.min(800,zn-y)),H=Kr+y,O=Math.max(250,Math.min(G,Nn-k)),j=Jr+k):nn==="top-right"?(T=Math.max(200,Math.min(800,zn+y)),O=Math.max(250,Math.min(G,Nn-k)),j=Jr+k):nn==="bottom-left"&&(T=Math.max(200,Math.min(800,zn-y)),H=Kr+y,O=Math.max(250,Math.min(G,Nn+k))),H=Math.max(0,Math.min(H,K-T)),j=Math.max(0,Math.min(j,G-O)),r.style.width=`${T}px`,r.style.height=`${O}px`,r.style.left=`${H}px`,r.style.top=`${j}px`,r.style.right="auto",r.style.bottom="auto"}),document.addEventListener("mouseup",()=>{Pn&&(Pn=!1,nn=null,document.body.style.cursor="",me(!0))});let Qr=null;window.addEventListener("resize",Or=()=>{Qr&&clearTimeout(Qr),Qr=setTimeout(()=>{me(!0),Qr=null},200)}),l.appendChild(p),l.appendChild(d);let ei=document.createElement("div");if(ei.id="ytls-content",ei.append(s),ei.append(g),r.append(l,ei,b,Bn,Yr,Rn,On),r.addEventListener("mousemove",v=>{try{if(ue||Pn)return;let y=r.getBoundingClientRect(),k=20,T=v.clientX,O=v.clientY,H=T-y.left<=k,j=y.right-T<=k,K=O-y.top<=k,G=y.bottom-O<=k,le="";K&&H||G&&j?le="nwse-resize":K&&j||G&&H?le="nesw-resize":le="",document.body.style.cursor=le}catch{}}),r.addEventListener("mouseleave",()=>{!Pn&&!ue&&(document.body.style.cursor="")}),window.recalculateTimestampsArea=pr,setTimeout(()=>{if(pr(),r&&l&&g&&s){let v=40,y=pe();if(y.length>0)v=y[0].offsetHeight;else{let k=document.createElement("li");k.style.visibility="hidden",k.style.position="absolute",k.textContent="00:00 Example",s.appendChild(k),v=k.offsetHeight,s.removeChild(k)}F=l.offsetHeight+g.offsetHeight+v,r.style.minHeight=F+"px"}},0),window.addEventListener("resize",pr),vt){try{vt.disconnect()}catch{}vt=null}vt=new ResizeObserver(pr),vt.observe(r),ar||document.addEventListener("pointerdown",ar=()=>{ta=Date.now()},!0),sr||document.addEventListener("pointerup",sr=()=>{},!0)}finally{yi=!1}}}async function zs(){if(!r)return;if(document.querySelectorAll("#ytls-pane").forEach(d=>{d!==r&&(u("Removing duplicate pane element from DOM"),d.remove())}),document.body.contains(r)){u("Pane already in DOM, skipping append");return}await Os(),typeof Wi=="function"&&Wi(ca),typeof fi=="function"&&fi(Wr),typeof mi=="function"&&mi(Ei),typeof Zi=="function"&&Zi(R),await Yi(),await us(),await Xn(),typeof hi=="function"&&hi();let c=document.querySelectorAll("#ytls-pane");if(c.length>0&&(u(`WARNING: Found ${c.length} existing pane(s) in DOM, removing all`),c.forEach(d=>d.remove())),document.body.contains(r)){u("ERROR: Pane already in body, aborting append");return}if(document.body.appendChild(r),u("Pane successfully appended to DOM"),ye(),_e&&(clearTimeout(_e),_e=null),_e=setTimeout(()=>{Z(),typeof window.recalculateTimestampsArea=="function"&&window.recalculateTimestampsArea(),ee(),me(!0),_e=null},450),yt){try{yt.disconnect()}catch{}yt=null}yt=new MutationObserver(()=>{let d=document.querySelectorAll("#ytls-pane");d.length>1&&(u(`CRITICAL: Multiple panes detected (${d.length}), removing duplicates`),d.forEach((m,x)=>{(x>0||r&&m!==r)&&m.remove()}))}),yt.observe(document.body,{childList:!0,subtree:!0})}function pa(o=0){if(document.getElementById("ytls-header-button")){Ct();return}let c=document.querySelector("#logo");if(!c||!c.parentElement){o<10&&setTimeout(()=>pa(o+1),300);return}let d=document.createElement("button");d.id="ytls-header-button",d.type="button",d.className="ytls-header-button",kt(d,"Toggle Timekeeper UI"),d.setAttribute("aria-label","Toggle Timekeeper UI");let m=document.createElement("img");m.src=Pe,m.alt="",m.decoding="async",d.appendChild(m),Ft=m,d.addEventListener("mouseenter",()=>{Ft&&(Dr=!0,Ft.src=He)}),d.addEventListener("mouseleave",()=>{Ft&&(Dr=!1,Ct())}),d.addEventListener("click",()=>{r&&!document.body.contains(r)&&(u("Pane not in DOM, re-appending before toggle"),document.body.appendChild(r)),Si()}),c.insertAdjacentElement("afterend",d),Ct(),u("Timekeeper header button added next to YouTube logo")}function ha(){if(ae)return;ae=!0;let o=history.pushState,c=history.replaceState;function d(){try{let m=new Event("locationchange");window.dispatchEvent(m)}catch{}}history.pushState=function(){let m=o.apply(this,arguments);return d(),m},history.replaceState=function(){let m=c.apply(this,arguments);return d(),m},window.addEventListener("popstate",d),window.addEventListener("locationchange",()=>{window.location.href!==X&&u("Location changed (locationchange event) \u2014 deferring UI update until navigation finish")})}async function Ii(){if(!a()){ks();return}X=window.location.href,document.querySelectorAll("#ytls-pane").forEach((c,d)=>{(d>0||r&&c!==r)&&c.remove()}),await Te(),await Ps(),Se=Ti();let o=document.title;u("Page Title:",o),u("Video ID:",Se),u("Current URL:",window.location.href),wi(!0),Qt(),$e(),await la(),$e(),wi(!1),u("Timestamps loaded and UI unlocked for video:",Se),await zs(),pa(),_s()}ha(),window.addEventListener("yt-navigate-start",()=>{u("Navigation started (yt-navigate-start event fired)"),a()&&r&&s&&(u("Locking UI and showing loading state for navigation"),wi(!0))}),ir=o=>{o.ctrlKey&&o.altKey&&o.shiftKey&&(o.key==="T"||o.key==="t")&&(o.preventDefault(),Si(),u("Timekeeper UI toggled via keyboard shortcut (Ctrl+Alt+Shift+T)"))},document.addEventListener("keydown",ir),window.addEventListener("yt-navigate-finish",()=>{u("Navigation finished (yt-navigate-finish event fired)"),window.location.href!==X?Ii():u("Navigation finished but URL already handled, skipping.")}),ha(),u("Timekeeper initialized and waiting for navigation events")})();})();

